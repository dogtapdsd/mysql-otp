<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>cover/mysql_protocol.COVER.html</title>
<style>body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  padding: 0;
  color: #000;
  border-top: 2px solid #ddd;
  background-color: #fff;

  min-height: 100%;
  display: flex;
  flex-direction: column;
}

h1 {
  width: 100%;
  border-bottom: 1px solid #eee;
  margin-bottom: 0;
  font-weight: 100;
  font-size: 1.1em;
  letter-spacing: 1px;
}

h1 code {
  font-size: 0.96em;
}

code {
  font: 12px monospace;
}

footer {
  background: #eee;
  width: 100%;
  padding: 10px 0;
  text-align: right;
  border-top: 1px solid #ddd;
  display: flex;
  flex: 1;
  order: 2;
  justify-content: center;
}

table {
  width: 100%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #000;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
}
table thead {
  display: none;
}
table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}
table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0, 0, 0, 0.6);
  background-color: #f0f0f0;
}
tr.miss td.line,
tr.miss td.hits {
  background-color: #ffdce0;
  border-color: #fdaeb7;
}
tr.miss td {
  background-color: #ffeef0;
}
tr.hit td.line,
tr.hit td.hits {
  background-color: #cdffd8;
  border-color: #bef5cb;
}
tr.hit td {
  background-color: #e6ffed;
}
td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monospace;
}
</style>
</head>
<body>
<h1><code>cover/mysql_protocol.COVER.html</code></h1>
<footer><p>File generated from <code>/home/viktor/repos/mysql-otp/ebin/../src/mysql_protocol.erl</code> by <a href="http://erlang.org/doc/man/cover.html">cover</a> at 2019-10-16 at 01:20:11</p></footer>
<table>
<tbody>
<tr>
<td class="line" id="L1">1</td>
<td class="hits"></td>
<td class="source"><code>%% MySQL/OTP – MySQL client library for Erlang/OTP</code></td>
</tr>
<tr>
<td class="line" id="L2">2</td>
<td class="hits"></td>
<td class="source"><code>%% Copyright (C) 2014 Viktor Söderqvist</code></td>
</tr>
<tr>
<td class="line" id="L3">3</td>
<td class="hits"></td>
<td class="source"><code>%%               2017 Piotr Nosek, Michal Slaski</code></td>
</tr>
<tr>
<td class="line" id="L4">4</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L5">5</td>
<td class="hits"></td>
<td class="source"><code>%% This file is part of MySQL/OTP.</code></td>
</tr>
<tr>
<td class="line" id="L6">6</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L7">7</td>
<td class="hits"></td>
<td class="source"><code>%% MySQL/OTP is free software: you can redistribute it and/or modify it under</code></td>
</tr>
<tr>
<td class="line" id="L8">8</td>
<td class="hits"></td>
<td class="source"><code>%% the terms of the GNU Lesser General Public License as published by the Free</code></td>
</tr>
<tr>
<td class="line" id="L9">9</td>
<td class="hits"></td>
<td class="source"><code>%% Software Foundation, either version 3 of the License, or (at your option)</code></td>
</tr>
<tr>
<td class="line" id="L10">10</td>
<td class="hits"></td>
<td class="source"><code>%% any later version.</code></td>
</tr>
<tr>
<td class="line" id="L11">11</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L12">12</td>
<td class="hits"></td>
<td class="source"><code>%% This program is distributed in the hope that it will be useful, but WITHOUT</code></td>
</tr>
<tr>
<td class="line" id="L13">13</td>
<td class="hits"></td>
<td class="source"><code>%% ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</code></td>
</tr>
<tr>
<td class="line" id="L14">14</td>
<td class="hits"></td>
<td class="source"><code>%% FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for</code></td>
</tr>
<tr>
<td class="line" id="L15">15</td>
<td class="hits"></td>
<td class="source"><code>%% more details.</code></td>
</tr>
<tr>
<td class="line" id="L16">16</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L17">17</td>
<td class="hits"></td>
<td class="source"><code>%% You should have received a copy of the GNU Lesser General Public License</code></td>
</tr>
<tr>
<td class="line" id="L18">18</td>
<td class="hits"></td>
<td class="source"><code>%% along with this program. If not, see &lt;https://www.gnu.org/licenses/&gt;.</code></td>
</tr>
<tr>
<td class="line" id="L19">19</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L20">20</td>
<td class="hits"></td>
<td class="source"><code>%% @doc This module implements parts of the MySQL client/server protocol.</code></td>
</tr>
<tr>
<td class="line" id="L21">21</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L22">22</td>
<td class="hits"></td>
<td class="source"><code>%% The protocol is described in the document "MySQL Internals" which can be</code></td>
</tr>
<tr>
<td class="line" id="L23">23</td>
<td class="hits"></td>
<td class="source"><code>%% found under "MySQL Documentation: Expert Guides" on http://dev.mysql.com/.</code></td>
</tr>
<tr>
<td class="line" id="L24">24</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L25">25</td>
<td class="hits"></td>
<td class="source"><code>%% TCP communication is not handled in this module. Most of the public functions</code></td>
</tr>
<tr>
<td class="line" id="L26">26</td>
<td class="hits"></td>
<td class="source"><code>%% take funs for data communitaction as parameters.</code></td>
</tr>
<tr>
<td class="line" id="L27">27</td>
<td class="hits"></td>
<td class="source"><code>%% @private</code></td>
</tr>
<tr>
<td class="line" id="L28">28</td>
<td class="hits"></td>
<td class="source"><code>-module(mysql_protocol).</code></td>
</tr>
<tr>
<td class="line" id="L29">29</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L30">30</td>
<td class="hits"></td>
<td class="source"><code>-export([handshake/7, change_user/7, quit/2, ping/2,</code></td>
</tr>
<tr>
<td class="line" id="L31">31</td>
<td class="hits"></td>
<td class="source"><code>         query/4, query/5, fetch_query_response/3,</code></td>
</tr>
<tr>
<td class="line" id="L32">32</td>
<td class="hits"></td>
<td class="source"><code>         fetch_query_response/4, prepare/3, unprepare/3,</code></td>
</tr>
<tr>
<td class="line" id="L33">33</td>
<td class="hits"></td>
<td class="source"><code>         execute/5, execute/6, fetch_execute_response/3,</code></td>
</tr>
<tr>
<td class="line" id="L34">34</td>
<td class="hits"></td>
<td class="source"><code>         fetch_execute_response/4, reset_connnection/2,</code></td>
</tr>
<tr>
<td class="line" id="L35">35</td>
<td class="hits"></td>
<td class="source"><code>	       valid_params/1]).</code></td>
</tr>
<tr>
<td class="line" id="L36">36</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L37">37</td>
<td class="hits"></td>
<td class="source"><code>-type query_filtermap() :: no_filtermap_fun</code></td>
</tr>
<tr>
<td class="line" id="L38">38</td>
<td class="hits"></td>
<td class="source"><code>                         | fun(([term()]) -&gt; query_filtermap_res())</code></td>
</tr>
<tr>
<td class="line" id="L39">39</td>
<td class="hits"></td>
<td class="source"><code>                         | fun(([term()], [term()]) -&gt; query_filtermap_res()).</code></td>
</tr>
<tr>
<td class="line" id="L40">40</td>
<td class="hits"></td>
<td class="source"><code>-type query_filtermap_res() :: boolean() | {true, term()}.</code></td>
</tr>
<tr>
<td class="line" id="L41">41</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L42">42</td>
<td class="hits"></td>
<td class="source"><code>%% How much data do we want per packet?</code></td>
</tr>
<tr>
<td class="line" id="L43">43</td>
<td class="hits"></td>
<td class="source"><code>-define(MAX_BYTES_PER_PACKET, 16#1000000).</code></td>
</tr>
<tr>
<td class="line" id="L44">44</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L45">45</td>
<td class="hits"></td>
<td class="source"><code>-include("records.hrl").</code></td>
</tr>
<tr>
<td class="line" id="L46">46</td>
<td class="hits"></td>
<td class="source"><code>-include("protocol.hrl").</code></td>
</tr>
<tr>
<td class="line" id="L47">47</td>
<td class="hits"></td>
<td class="source"><code>-include("server_status.hrl").</code></td>
</tr>
<tr>
<td class="line" id="L48">48</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L49">49</td>
<td class="hits"></td>
<td class="source"><code>%% Macros for pattern matching on packets.</code></td>
</tr>
<tr>
<td class="line" id="L50">50</td>
<td class="hits"></td>
<td class="source"><code>-define(ok_pattern, &lt;&lt;?OK, _/binary&gt;&gt;).</code></td>
</tr>
<tr>
<td class="line" id="L51">51</td>
<td class="hits"></td>
<td class="source"><code>-define(error_pattern, &lt;&lt;?ERROR, _/binary&gt;&gt;).</code></td>
</tr>
<tr>
<td class="line" id="L52">52</td>
<td class="hits"></td>
<td class="source"><code>-define(eof_pattern, &lt;&lt;?EOF, _:4/binary&gt;&gt;).</code></td>
</tr>
<tr>
<td class="line" id="L53">53</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L54">54</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Performs a handshake using the supplied socket and socket module for</code></td>
</tr>
<tr>
<td class="line" id="L55">55</td>
<td class="hits"></td>
<td class="source"><code>%% communication. Returns an ok or an error record. Raises errors when various</code></td>
</tr>
<tr>
<td class="line" id="L56">56</td>
<td class="hits"></td>
<td class="source"><code>%% unimplemented features are requested.</code></td>
</tr>
<tr>
<td class="line" id="L57">57</td>
<td class="hits"></td>
<td class="source"><code>-spec handshake(Username :: iodata(), Password :: iodata(),</code></td>
</tr>
<tr>
<td class="line" id="L58">58</td>
<td class="hits"></td>
<td class="source"><code>                Database :: iodata() | undefined,</code></td>
</tr>
<tr>
<td class="line" id="L59">59</td>
<td class="hits"></td>
<td class="source"><code>                SockModule :: module(), SSLOpts :: list() | undefined,</code></td>
</tr>
<tr>
<td class="line" id="L60">60</td>
<td class="hits"></td>
<td class="source"><code>                Socket :: term(),</code></td>
</tr>
<tr>
<td class="line" id="L61">61</td>
<td class="hits"></td>
<td class="source"><code>                SetFoundRows :: boolean()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L62">62</td>
<td class="hits"></td>
<td class="source"><code>    {ok, #handshake{}, SockModule :: module(), Socket :: term()} |</code></td>
</tr>
<tr>
<td class="line" id="L63">63</td>
<td class="hits"></td>
<td class="source"><code>    #error{}.</code></td>
</tr>
<tr>
<td class="line" id="L64">64</td>
<td class="hits"></td>
<td class="source"><code>handshake(Username, Password, Database, SockModule0, SSLOpts, Socket0,</code></td>
</tr>
<tr>
<td class="line" id="L65">65</td>
<td class="hits"></td>
<td class="source"><code>          SetFoundRows) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L66">66</td>
<td class="hits">39</td>
<td class="source"><code>    SeqNum0 = 0,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L67">67</td>
<td class="hits">39</td>
<td class="source"><code>    {ok, HandshakePacket, SeqNum1} = recv_packet(SockModule0, Socket0, SeqNum0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L68">68</td>
<td class="hits">39</td>
<td class="source"><code>    case parse_handshake(HandshakePacket) of</code></td>
</tr>
<tr>
<td class="line" id="L69">69</td>
<td class="hits"></td>
<td class="source"><code>        #handshake{} = Handshake -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L70">70</td>
<td class="hits">37</td>
<td class="source"><code>            {ok, SockModule, Socket, SeqNum2} =</code></td>
</tr>
<tr>
<td class="line" id="L71">71</td>
<td class="hits"></td>
<td class="source"><code>                maybe_do_ssl_upgrade(SockModule0, Socket0, SeqNum1, Handshake,</code></td>
</tr>
<tr>
<td class="line" id="L72">72</td>
<td class="hits"></td>
<td class="source"><code>                                     SSLOpts, Database, SetFoundRows),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L73">73</td>
<td class="hits">37</td>
<td class="source"><code>            Response = build_handshake_response(Handshake, Username, Password,</code></td>
</tr>
<tr>
<td class="line" id="L74">74</td>
<td class="hits"></td>
<td class="source"><code>                                                Database, SetFoundRows),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L75">75</td>
<td class="hits">37</td>
<td class="source"><code>            {ok, SeqNum3} = send_packet(SockModule, Socket, Response, SeqNum2),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L76">76</td>
<td class="hits">37</td>
<td class="source"><code>            handshake_finish_or_switch_auth(Handshake, Password, SockModule,</code></td>
</tr>
<tr>
<td class="line" id="L77">77</td>
<td class="hits"></td>
<td class="source"><code>                                            Socket, SeqNum3);</code></td>
</tr>
<tr>
<td class="line" id="L78">78</td>
<td class="hits"></td>
<td class="source"><code>        #error{} = Error -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L79">79</td>
<td class="hits">1</td>
<td class="source"><code>            Error</code></td>
</tr>
<tr>
<td class="line" id="L80">80</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L81">81</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L82">82</td>
<td class="hits"></td>
<td class="source"><code>handshake_finish_or_switch_auth(Handshake = #handshake{status = Status}, Password,</code></td>
</tr>
<tr>
<td class="line" id="L83">83</td>
<td class="hits"></td>
<td class="source"><code>                                SockModule, Socket, SeqNum0) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L84">84</td>
<td class="hits">37</td>
<td class="source"><code>    {ok, ConfirmPacket, SeqNum1} = recv_packet(SockModule, Socket, SeqNum0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L85">85</td>
<td class="hits">37</td>
<td class="source"><code>    case parse_handshake_confirm(ConfirmPacket) of</code></td>
</tr>
<tr>
<td class="line" id="L86">86</td>
<td class="hits"></td>
<td class="source"><code>        #ok{status = OkStatus} -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L87">87</td>
<td class="hits"></td>
<td class="source"><code>            %% check status, ignoring bit 16#4000, SERVER_SESSION_STATE_CHANGED</code></td>
</tr>
<tr>
<td class="line" id="L88">88</td>
<td class="hits"></td>
<td class="source"><code>            %% and bit 16#0002, SERVER_STATUS_AUTOCOMMIT.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L89">89</td>
<td class="hits">36</td>
<td class="source"><code>            BitMask = bnot (?SERVER_SESSION_STATE_CHANGED bor ?SERVER_STATUS_AUTOCOMMIT),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L90">90</td>
<td class="hits">36</td>
<td class="source"><code>            StatusMasked = Status band BitMask,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L91">91</td>
<td class="hits">36</td>
<td class="source"><code>            StatusMasked = OkStatus band BitMask,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L92">92</td>
<td class="hits">36</td>
<td class="source"><code>            {ok, Handshake, SockModule, Socket};</code></td>
</tr>
<tr>
<td class="line" id="L93">93</td>
<td class="hits"></td>
<td class="source"><code>        #auth_method_switch{auth_plugin_name = AuthPluginName,</code></td>
</tr>
<tr>
<td class="line" id="L94">94</td>
<td class="hits"></td>
<td class="source"><code>                            auth_plugin_data = AuthPluginData} -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L95">95</td>
<td class="hits">0</td>
<td class="source"><code>            Hash = case AuthPluginName of</code></td>
</tr>
<tr>
<td class="line" id="L96">96</td>
<td class="hits"></td>
<td class="source"><code>                       &lt;&lt;&gt;&gt; -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L97">97</td>
<td class="hits">0</td>
<td class="source"><code>                           hash_password(Password, AuthPluginData);</code></td>
</tr>
<tr>
<td class="line" id="L98">98</td>
<td class="hits"></td>
<td class="source"><code>                       &lt;&lt;"mysql_native_password"&gt;&gt; -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L99">99</td>
<td class="hits">0</td>
<td class="source"><code>                           hash_password(Password, AuthPluginData);</code></td>
</tr>
<tr>
<td class="line" id="L100">100</td>
<td class="hits"></td>
<td class="source"><code>                       UnknownAuthMethod -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L101">101</td>
<td class="hits">0</td>
<td class="source"><code>                           error({auth_method, UnknownAuthMethod})</code></td>
</tr>
<tr>
<td class="line" id="L102">102</td>
<td class="hits"></td>
<td class="source"><code>                   end,</code></td>
</tr>
<tr class="miss">
<td class="line" id="L103">103</td>
<td class="hits">0</td>
<td class="source"><code>            {ok, SeqNum2} = send_packet(SockModule, Socket, Hash, SeqNum1),</code></td>
</tr>
<tr class="miss">
<td class="line" id="L104">104</td>
<td class="hits">0</td>
<td class="source"><code>            handshake_finish_or_switch_auth(Handshake, Password, SockModule,</code></td>
</tr>
<tr>
<td class="line" id="L105">105</td>
<td class="hits"></td>
<td class="source"><code>                                            Socket, SeqNum2);</code></td>
</tr>
<tr>
<td class="line" id="L106">106</td>
<td class="hits"></td>
<td class="source"><code>        Error -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L107">107</td>
<td class="hits">1</td>
<td class="source"><code>            Error</code></td>
</tr>
<tr>
<td class="line" id="L108">108</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L109">109</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L110">110</td>
<td class="hits"></td>
<td class="source"><code>-spec quit(module(), term()) -&gt; ok.</code></td>
</tr>
<tr>
<td class="line" id="L111">111</td>
<td class="hits"></td>
<td class="source"><code>quit(SockModule, Socket) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L112">112</td>
<td class="hits">27</td>
<td class="source"><code>    {ok, SeqNum1} = send_packet(SockModule, Socket, &lt;&lt;?COM_QUIT&gt;&gt;, 0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L113">113</td>
<td class="hits">27</td>
<td class="source"><code>    case recv_packet(SockModule, Socket, SeqNum1) of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L114">114</td>
<td class="hits">27</td>
<td class="source"><code>        {error, closed} -&gt; ok;            %% MySQL 5.5.40 and more</code></td>
</tr>
<tr class="miss">
<td class="line" id="L115">115</td>
<td class="hits">0</td>
<td class="source"><code>        {ok, ?ok_pattern, _SeqNum2} -&gt; ok %% Some older MySQL versions?</code></td>
</tr>
<tr>
<td class="line" id="L116">116</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L117">117</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L118">118</td>
<td class="hits"></td>
<td class="source"><code>-spec ping(module(), term()) -&gt; #ok{}.</code></td>
</tr>
<tr>
<td class="line" id="L119">119</td>
<td class="hits"></td>
<td class="source"><code>ping(SockModule, Socket) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L120">120</td>
<td class="hits">4</td>
<td class="source"><code>    {ok, SeqNum1} = send_packet(SockModule, Socket, &lt;&lt;?COM_PING&gt;&gt;, 0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L121">121</td>
<td class="hits">3</td>
<td class="source"><code>    {ok, OkPacket, _SeqNum2} = recv_packet(SockModule, Socket, SeqNum1),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L122">122</td>
<td class="hits">3</td>
<td class="source"><code>    parse_ok_packet(OkPacket).</code></td>
</tr>
<tr>
<td class="line" id="L123">123</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L124">124</td>
<td class="hits"></td>
<td class="source"><code>-spec query(Query :: iodata(), module(), term(), timeout()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L125">125</td>
<td class="hits"></td>
<td class="source"><code>    {ok, [#ok{} | #resultset{} | #error{}]} | {error, timeout}.</code></td>
</tr>
<tr>
<td class="line" id="L126">126</td>
<td class="hits"></td>
<td class="source"><code>query(Query, SockModule, Socket, Timeout) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L127">127</td>
<td class="hits">58</td>
<td class="source"><code>    query(Query, SockModule, Socket, no_filtermap_fun, Timeout).</code></td>
</tr>
<tr>
<td class="line" id="L128">128</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L129">129</td>
<td class="hits"></td>
<td class="source"><code>-spec query(Query :: iodata(), module(), term(), query_filtermap(), timeout()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L130">130</td>
<td class="hits"></td>
<td class="source"><code>    {ok, [#ok{} | #resultset{} | #error{}]} | {error, timeout}.</code></td>
</tr>
<tr>
<td class="line" id="L131">131</td>
<td class="hits"></td>
<td class="source"><code>query(Query, SockModule, Socket, FilterMap, Timeout) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L132">132</td>
<td class="hits">492</td>
<td class="source"><code>    Req = &lt;&lt;?COM_QUERY, (iolist_to_binary(Query))/binary&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L133">133</td>
<td class="hits">492</td>
<td class="source"><code>    SeqNum0 = 0,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L134">134</td>
<td class="hits">492</td>
<td class="source"><code>    {ok, _SeqNum1} = send_packet(SockModule, Socket, Req, SeqNum0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L135">135</td>
<td class="hits">492</td>
<td class="source"><code>    fetch_query_response(SockModule, Socket, FilterMap, Timeout).</code></td>
</tr>
<tr>
<td class="line" id="L136">136</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L137">137</td>
<td class="hits"></td>
<td class="source"><code>%% @doc This is used by query/4. If query/4 returns {error, timeout}, this</code></td>
</tr>
<tr>
<td class="line" id="L138">138</td>
<td class="hits"></td>
<td class="source"><code>%% function can be called to retry to fetch the results of the query.</code></td>
</tr>
<tr>
<td class="line" id="L139">139</td>
<td class="hits"></td>
<td class="source"><code>fetch_query_response(SockModule, Socket, Timeout) -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L140">140</td>
<td class="hits">0</td>
<td class="source"><code>    fetch_query_response(SockModule, Socket, no_filtermap_fun, Timeout).</code></td>
</tr>
<tr>
<td class="line" id="L141">141</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L142">142</td>
<td class="hits"></td>
<td class="source"><code>fetch_query_response(SockModule, Socket, FilterMap, Timeout) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L143">143</td>
<td class="hits">493</td>
<td class="source"><code>    fetch_response(SockModule, Socket, Timeout, text, FilterMap, []).</code></td>
</tr>
<tr>
<td class="line" id="L144">144</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L145">145</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Prepares a statement.</code></td>
</tr>
<tr>
<td class="line" id="L146">146</td>
<td class="hits"></td>
<td class="source"><code>-spec prepare(iodata(), module(), term()) -&gt; #error{} | #prepared{}.</code></td>
</tr>
<tr>
<td class="line" id="L147">147</td>
<td class="hits"></td>
<td class="source"><code>prepare(Query, SockModule, Socket) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L148">148</td>
<td class="hits">116</td>
<td class="source"><code>    Req = &lt;&lt;?COM_STMT_PREPARE, (iolist_to_binary(Query))/binary&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L149">149</td>
<td class="hits">116</td>
<td class="source"><code>    {ok, SeqNum1} = send_packet(SockModule, Socket, Req, 0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L150">150</td>
<td class="hits">116</td>
<td class="source"><code>    {ok, Resp, SeqNum2} = recv_packet(SockModule, Socket, SeqNum1),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L151">151</td>
<td class="hits">116</td>
<td class="source"><code>    case Resp of</code></td>
</tr>
<tr>
<td class="line" id="L152">152</td>
<td class="hits"></td>
<td class="source"><code>        ?error_pattern -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L153">153</td>
<td class="hits">5</td>
<td class="source"><code>            parse_error_packet(Resp);</code></td>
</tr>
<tr>
<td class="line" id="L154">154</td>
<td class="hits"></td>
<td class="source"><code>        &lt;&lt;?OK,</code></td>
</tr>
<tr>
<td class="line" id="L155">155</td>
<td class="hits"></td>
<td class="source"><code>          StmtId:32/little,</code></td>
</tr>
<tr>
<td class="line" id="L156">156</td>
<td class="hits"></td>
<td class="source"><code>          NumColumns:16/little,</code></td>
</tr>
<tr>
<td class="line" id="L157">157</td>
<td class="hits"></td>
<td class="source"><code>          NumParams:16/little,</code></td>
</tr>
<tr>
<td class="line" id="L158">158</td>
<td class="hits"></td>
<td class="source"><code>          0, %% reserved_1 -- [00] filler</code></td>
</tr>
<tr>
<td class="line" id="L159">159</td>
<td class="hits"></td>
<td class="source"><code>          WarningCount:16/little&gt;&gt; -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L160">160</td>
<td class="hits"></td>
<td class="source"><code>            %% This was the first packet.</code></td>
</tr>
<tr>
<td class="line" id="L161">161</td>
<td class="hits"></td>
<td class="source"><code>            %% Now: Parameter Definition Block. The parameter definitions don't</code></td>
</tr>
<tr>
<td class="line" id="L162">162</td>
<td class="hits"></td>
<td class="source"><code>            %% contain any useful data at all. They are always TYPE_VAR_STRING</code></td>
</tr>
<tr>
<td class="line" id="L163">163</td>
<td class="hits"></td>
<td class="source"><code>            %% with charset 'binary' so we have to select a type ourselves for</code></td>
</tr>
<tr>
<td class="line" id="L164">164</td>
<td class="hits"></td>
<td class="source"><code>            %% the parameters we have in execute/4.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L165">165</td>
<td class="hits">111</td>
<td class="source"><code>            {_ParamDefs, SeqNum3} =</code></td>
</tr>
<tr>
<td class="line" id="L166">166</td>
<td class="hits"></td>
<td class="source"><code>                fetch_column_definitions_if_any(NumParams, SockModule, Socket,</code></td>
</tr>
<tr>
<td class="line" id="L167">167</td>
<td class="hits"></td>
<td class="source"><code>                                                SeqNum2),</code></td>
</tr>
<tr>
<td class="line" id="L168">168</td>
<td class="hits"></td>
<td class="source"><code>            %% Column Definition Block. We get column definitions in execute</code></td>
</tr>
<tr>
<td class="line" id="L169">169</td>
<td class="hits"></td>
<td class="source"><code>            %% too, so we don't need them here. We *could* store them to be able</code></td>
</tr>
<tr>
<td class="line" id="L170">170</td>
<td class="hits"></td>
<td class="source"><code>            %% to provide the user with some info about a prepared statement.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L171">171</td>
<td class="hits">111</td>
<td class="source"><code>            {_ColDefs, _SeqNum4} =</code></td>
</tr>
<tr>
<td class="line" id="L172">172</td>
<td class="hits"></td>
<td class="source"><code>                fetch_column_definitions_if_any(NumColumns, SockModule, Socket,</code></td>
</tr>
<tr>
<td class="line" id="L173">173</td>
<td class="hits"></td>
<td class="source"><code>                                                SeqNum3),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L174">174</td>
<td class="hits">111</td>
<td class="source"><code>            #prepared{statement_id = StmtId,</code></td>
</tr>
<tr>
<td class="line" id="L175">175</td>
<td class="hits"></td>
<td class="source"><code>                      orig_query = Query,</code></td>
</tr>
<tr>
<td class="line" id="L176">176</td>
<td class="hits"></td>
<td class="source"><code>                      param_count = NumParams,</code></td>
</tr>
<tr>
<td class="line" id="L177">177</td>
<td class="hits"></td>
<td class="source"><code>                      warning_count = WarningCount}</code></td>
</tr>
<tr>
<td class="line" id="L178">178</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L179">179</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L180">180</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Deallocates a prepared statement.</code></td>
</tr>
<tr>
<td class="line" id="L181">181</td>
<td class="hits"></td>
<td class="source"><code>-spec unprepare(#prepared{}, module(), term()) -&gt; ok.</code></td>
</tr>
<tr>
<td class="line" id="L182">182</td>
<td class="hits"></td>
<td class="source"><code>unprepare(#prepared{statement_id = Id}, SockModule, Socket) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L183">183</td>
<td class="hits">91</td>
<td class="source"><code>    {ok, _SeqNum} = send_packet(SockModule, Socket,</code></td>
</tr>
<tr>
<td class="line" id="L184">184</td>
<td class="hits"></td>
<td class="source"><code>                                &lt;&lt;?COM_STMT_CLOSE, Id:32/little&gt;&gt;, 0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L185">185</td>
<td class="hits">91</td>
<td class="source"><code>    ok.</code></td>
</tr>
<tr>
<td class="line" id="L186">186</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L187">187</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Executes a prepared statement.</code></td>
</tr>
<tr>
<td class="line" id="L188">188</td>
<td class="hits"></td>
<td class="source"><code>-spec execute(#prepared{}, [term()], module(), term(), timeout()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L189">189</td>
<td class="hits"></td>
<td class="source"><code>    {ok, [#ok{} | #resultset{} | #error{}]} | {error, timeout}.</code></td>
</tr>
<tr>
<td class="line" id="L190">190</td>
<td class="hits"></td>
<td class="source"><code>execute(PrepStmt, ParamValues, SockModule, Socket, Timeout) -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L191">191</td>
<td class="hits">0</td>
<td class="source"><code>    execute(PrepStmt, ParamValues, SockModule, Socket, no_filtermap_fun,</code></td>
</tr>
<tr>
<td class="line" id="L192">192</td>
<td class="hits"></td>
<td class="source"><code>            Timeout).</code></td>
</tr>
<tr>
<td class="line" id="L193">193</td>
<td class="hits"></td>
<td class="source"><code>-spec execute(#prepared{}, [term()], module(), term(), query_filtermap(),</code></td>
</tr>
<tr>
<td class="line" id="L194">194</td>
<td class="hits"></td>
<td class="source"><code>              timeout()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L195">195</td>
<td class="hits"></td>
<td class="source"><code>    {ok, [#ok{} | #resultset{} | #error{}]} | {error, timeout}.</code></td>
</tr>
<tr>
<td class="line" id="L196">196</td>
<td class="hits"></td>
<td class="source"><code>execute(#prepared{statement_id = Id, param_count = ParamCount}, ParamValues,</code></td>
</tr>
<tr>
<td class="line" id="L197">197</td>
<td class="hits"></td>
<td class="source"><code>        SockModule, Socket, FilterMap, Timeout)</code></td>
</tr>
<tr>
<td class="line" id="L198">198</td>
<td class="hits"></td>
<td class="source"><code>  when ParamCount == length(ParamValues) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L199">199</td>
<td class="hits"></td>
<td class="source"><code>    %% Flags Constant Name</code></td>
</tr>
<tr>
<td class="line" id="L200">200</td>
<td class="hits"></td>
<td class="source"><code>    %% 0x00 CURSOR_TYPE_NO_CURSOR</code></td>
</tr>
<tr>
<td class="line" id="L201">201</td>
<td class="hits"></td>
<td class="source"><code>    %% 0x01 CURSOR_TYPE_READ_ONLY</code></td>
</tr>
<tr>
<td class="line" id="L202">202</td>
<td class="hits"></td>
<td class="source"><code>    %% 0x02 CURSOR_TYPE_FOR_UPDATE</code></td>
</tr>
<tr>
<td class="line" id="L203">203</td>
<td class="hits"></td>
<td class="source"><code>    %% 0x04 CURSOR_TYPE_SCROLLABLE</code></td>
</tr>
<tr class="hit">
<td class="line" id="L204">204</td>
<td class="hits">197</td>
<td class="source"><code>    Flags = 0,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L205">205</td>
<td class="hits">197</td>
<td class="source"><code>    Req0 = &lt;&lt;?COM_STMT_EXECUTE, Id:32/little, Flags, 1:32/little&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L206">206</td>
<td class="hits">197</td>
<td class="source"><code>    Req = case ParamCount of</code></td>
</tr>
<tr>
<td class="line" id="L207">207</td>
<td class="hits"></td>
<td class="source"><code>        0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L208">208</td>
<td class="hits">115</td>
<td class="source"><code>            Req0;</code></td>
</tr>
<tr>
<td class="line" id="L209">209</td>
<td class="hits"></td>
<td class="source"><code>        _ -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L210">210</td>
<td class="hits"></td>
<td class="source"><code>            %% We can't use the parameter types returned by the prepare call.</code></td>
</tr>
<tr>
<td class="line" id="L211">211</td>
<td class="hits"></td>
<td class="source"><code>            %% They are all reported as ?TYPE_VAR_STRING with character</code></td>
</tr>
<tr>
<td class="line" id="L212">212</td>
<td class="hits"></td>
<td class="source"><code>            %% set 'binary'.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L213">213</td>
<td class="hits">82</td>
<td class="source"><code>            NullBitMap = build_null_bitmap(ParamValues),</code></td>
</tr>
<tr>
<td class="line" id="L214">214</td>
<td class="hits"></td>
<td class="source"><code>            %% What does it mean to *not* bind new params? To use the same</code></td>
</tr>
<tr>
<td class="line" id="L215">215</td>
<td class="hits"></td>
<td class="source"><code>            %% params as last time? Right now we always bind params each time.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L216">216</td>
<td class="hits">82</td>
<td class="source"><code>            NewParamsBoundFlag = 1,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L217">217</td>
<td class="hits">82</td>
<td class="source"><code>            Req1 = &lt;&lt;Req0/binary, NullBitMap/binary, NewParamsBoundFlag&gt;&gt;,</code></td>
</tr>
<tr>
<td class="line" id="L218">218</td>
<td class="hits"></td>
<td class="source"><code>            %% For each value, first append type and signedness (16#80 signed or</code></td>
</tr>
<tr>
<td class="line" id="L219">219</td>
<td class="hits"></td>
<td class="source"><code>            %% 00 unsigned) for all values and then the binary encoded values.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L220">220</td>
<td class="hits">82</td>
<td class="source"><code>            EncodedParams = lists:map(fun encode_param/1, ParamValues),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L221">221</td>
<td class="hits">82</td>
<td class="source"><code>            {TypesAndSigns, EncValues} = lists:unzip(EncodedParams),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L222">222</td>
<td class="hits">82</td>
<td class="source"><code>            iolist_to_binary([Req1, TypesAndSigns, EncValues])</code></td>
</tr>
<tr>
<td class="line" id="L223">223</td>
<td class="hits"></td>
<td class="source"><code>    end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L224">224</td>
<td class="hits">197</td>
<td class="source"><code>    {ok, _SeqNum1} = send_packet(SockModule, Socket, Req, 0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L225">225</td>
<td class="hits">197</td>
<td class="source"><code>    fetch_execute_response(SockModule, Socket, FilterMap, Timeout).</code></td>
</tr>
<tr>
<td class="line" id="L226">226</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L227">227</td>
<td class="hits"></td>
<td class="source"><code>%% @doc This is used by execute/5. If execute/5 returns {error, timeout}, this</code></td>
</tr>
<tr>
<td class="line" id="L228">228</td>
<td class="hits"></td>
<td class="source"><code>%% function can be called to retry to fetch the results of the query.</code></td>
</tr>
<tr>
<td class="line" id="L229">229</td>
<td class="hits"></td>
<td class="source"><code>fetch_execute_response(SockModule, Socket, Timeout) -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L230">230</td>
<td class="hits">0</td>
<td class="source"><code>    fetch_execute_response(SockModule, Socket, no_filtermap_fun, Timeout).</code></td>
</tr>
<tr>
<td class="line" id="L231">231</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L232">232</td>
<td class="hits"></td>
<td class="source"><code>fetch_execute_response(SockModule, Socket, FilterMap, Timeout) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L233">233</td>
<td class="hits">199</td>
<td class="source"><code>    fetch_response(SockModule, Socket, Timeout, binary, FilterMap, []).</code></td>
</tr>
<tr>
<td class="line" id="L234">234</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L235">235</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Changes the user of the connection.</code></td>
</tr>
<tr>
<td class="line" id="L236">236</td>
<td class="hits"></td>
<td class="source"><code>-spec change_user(module(), term(), iodata(), iodata(), binary(),</code></td>
</tr>
<tr>
<td class="line" id="L237">237</td>
<td class="hits"></td>
<td class="source"><code>                  undefined | iodata(), [integer()]) -&gt; #ok{} | #error{}.</code></td>
</tr>
<tr>
<td class="line" id="L238">238</td>
<td class="hits"></td>
<td class="source"><code>change_user(SockModule, Socket, Username, Password, Salt, Database,</code></td>
</tr>
<tr>
<td class="line" id="L239">239</td>
<td class="hits"></td>
<td class="source"><code>            ServerVersion) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L240">240</td>
<td class="hits">9</td>
<td class="source"><code>    DbBin = case Database of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L241">241</td>
<td class="hits">8</td>
<td class="source"><code>        undefined -&gt; &lt;&lt;&gt;&gt;;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L242">242</td>
<td class="hits">1</td>
<td class="source"><code>        _ -&gt; iolist_to_binary(Database)</code></td>
</tr>
<tr>
<td class="line" id="L243">243</td>
<td class="hits"></td>
<td class="source"><code>    end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L244">244</td>
<td class="hits">9</td>
<td class="source"><code>    Hash = hash_password(Password, Salt),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L245">245</td>
<td class="hits">9</td>
<td class="source"><code>    Req = &lt;&lt;?COM_CHANGE_USER, (iolist_to_binary(Username))/binary, 0,</code></td>
</tr>
<tr>
<td class="line" id="L246">246</td>
<td class="hits"></td>
<td class="source"><code>            (lenenc_str_encode(Hash))/binary,</code></td>
</tr>
<tr>
<td class="line" id="L247">247</td>
<td class="hits"></td>
<td class="source"><code>            DbBin/binary, 0, (character_set(ServerVersion)):16/little&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L248">248</td>
<td class="hits">9</td>
<td class="source"><code>    {ok, _SeqNum1} = send_packet(SockModule, Socket, Req, 0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L249">249</td>
<td class="hits">9</td>
<td class="source"><code>    {ok, Packet, _SeqNum2} = recv_packet(SockModule, Socket, infinity, any),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L250">250</td>
<td class="hits">9</td>
<td class="source"><code>    case Packet of</code></td>
</tr>
<tr>
<td class="line" id="L251">251</td>
<td class="hits"></td>
<td class="source"><code>        ?ok_pattern -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L252">252</td>
<td class="hits">8</td>
<td class="source"><code>            parse_ok_packet(Packet);</code></td>
</tr>
<tr>
<td class="line" id="L253">253</td>
<td class="hits"></td>
<td class="source"><code>        ?error_pattern -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L254">254</td>
<td class="hits">1</td>
<td class="source"><code>            parse_error_packet(Packet)</code></td>
</tr>
<tr>
<td class="line" id="L255">255</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L256">256</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L257">257</td>
<td class="hits"></td>
<td class="source"><code>-spec reset_connnection(module(), term()) -&gt; #ok{}|#error{}.</code></td>
</tr>
<tr>
<td class="line" id="L258">258</td>
<td class="hits"></td>
<td class="source"><code>reset_connnection(SockModule, Socket) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L259">259</td>
<td class="hits">1</td>
<td class="source"><code>    {ok, SeqNum1} = send_packet(SockModule, Socket, &lt;&lt;?COM_RESET_CONNECTION&gt;&gt;, 0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L260">260</td>
<td class="hits">1</td>
<td class="source"><code>    {ok, Packet, _SeqNum2} = recv_packet(SockModule, Socket, SeqNum1),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L261">261</td>
<td class="hits">1</td>
<td class="source"><code>    case Packet of</code></td>
</tr>
<tr>
<td class="line" id="L262">262</td>
<td class="hits"></td>
<td class="source"><code>        ?ok_pattern -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L263">263</td>
<td class="hits">1</td>
<td class="source"><code>            parse_ok_packet(Packet);</code></td>
</tr>
<tr>
<td class="line" id="L264">264</td>
<td class="hits"></td>
<td class="source"><code>        ?error_pattern -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L265">265</td>
<td class="hits">0</td>
<td class="source"><code>            parse_error_packet(Packet)</code></td>
</tr>
<tr>
<td class="line" id="L266">266</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L267">267</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L268">268</td>
<td class="hits"></td>
<td class="source"><code>%% --- internal ---</code></td>
</tr>
<tr>
<td class="line" id="L269">269</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L270">270</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Parses a handshake. This is the first thing that comes from the server</code></td>
</tr>
<tr>
<td class="line" id="L271">271</td>
<td class="hits"></td>
<td class="source"><code>%% when connecting. If an unsupported version or variant of the protocol is used</code></td>
</tr>
<tr>
<td class="line" id="L272">272</td>
<td class="hits"></td>
<td class="source"><code>%% an error is raised.</code></td>
</tr>
<tr>
<td class="line" id="L273">273</td>
<td class="hits"></td>
<td class="source"><code>-spec parse_handshake(binary()) -&gt; #handshake{} | #error{}.</code></td>
</tr>
<tr>
<td class="line" id="L274">274</td>
<td class="hits"></td>
<td class="source"><code>parse_handshake(&lt;&lt;10, Rest/binary&gt;&gt;) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L275">275</td>
<td class="hits"></td>
<td class="source"><code>    %% Protocol version 10.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L276">276</td>
<td class="hits">37</td>
<td class="source"><code>    {ServerVersion, Rest1} = nulterm_str(Rest),</code></td>
</tr>
<tr>
<td class="line" id="L277">277</td>
<td class="hits"></td>
<td class="source"><code>    &lt;&lt;ConnectionId:32/little,</code></td>
</tr>
<tr>
<td class="line" id="L278">278</td>
<td class="hits"></td>
<td class="source"><code>      AuthPluginDataPart1:8/binary-unit:8,</code></td>
</tr>
<tr>
<td class="line" id="L279">279</td>
<td class="hits"></td>
<td class="source"><code>      0, %% "filler" -- everything below is optional</code></td>
</tr>
<tr>
<td class="line" id="L280">280</td>
<td class="hits"></td>
<td class="source"><code>      CapabilitiesLower:16/little,</code></td>
</tr>
<tr>
<td class="line" id="L281">281</td>
<td class="hits"></td>
<td class="source"><code>      CharacterSet:8,</code></td>
</tr>
<tr>
<td class="line" id="L282">282</td>
<td class="hits"></td>
<td class="source"><code>      StatusFlags:16/little,</code></td>
</tr>
<tr>
<td class="line" id="L283">283</td>
<td class="hits"></td>
<td class="source"><code>      CapabilitiesUpper:16/little,</code></td>
</tr>
<tr>
<td class="line" id="L284">284</td>
<td class="hits"></td>
<td class="source"><code>      AuthPluginDataLength:8,     %% if cabab &amp; CLIENT_PLUGIN_AUTH, otherwise 0</code></td>
</tr>
<tr>
<td class="line" id="L285">285</td>
<td class="hits"></td>
<td class="source"><code>      _Reserved:10/binary-unit:8, %% 10 unused (reserved) bytes</code></td>
</tr>
<tr class="hit">
<td class="line" id="L286">286</td>
<td class="hits">37</td>
<td class="source"><code>      Rest3/binary&gt;&gt; = Rest1,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L287">287</td>
<td class="hits">37</td>
<td class="source"><code>    Capabilities = CapabilitiesLower + 16#10000 * CapabilitiesUpper,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L288">288</td>
<td class="hits">37</td>
<td class="source"><code>    Len = case AuthPluginDataLength of</code></td>
</tr>
<tr class="miss">
<td class="line" id="L289">289</td>
<td class="hits">0</td>
<td class="source"><code>        0 -&gt; 13;   %% Server has not CLIENT_PLUGIN_AUTH</code></td>
</tr>
<tr class="hit">
<td class="line" id="L290">290</td>
<td class="hits">37</td>
<td class="source"><code>        K -&gt; K - 8 %% Part 2 length = Total length minus the 8 bytes in part 1.</code></td>
</tr>
<tr>
<td class="line" id="L291">291</td>
<td class="hits"></td>
<td class="source"><code>    end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L292">292</td>
<td class="hits">37</td>
<td class="source"><code>    &lt;&lt;AuthPluginDataPart2:Len/binary-unit:8, AuthPluginName/binary&gt;&gt; = Rest3,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L293">293</td>
<td class="hits">37</td>
<td class="source"><code>    AuthPluginData = &lt;&lt;AuthPluginDataPart1/binary, AuthPluginDataPart2/binary&gt;&gt;,</code></td>
</tr>
<tr>
<td class="line" id="L294">294</td>
<td class="hits"></td>
<td class="source"><code>    %% "Due to Bug#59453 the auth-plugin-name is missing the terminating</code></td>
</tr>
<tr>
<td class="line" id="L295">295</td>
<td class="hits"></td>
<td class="source"><code>    %% NUL-char in versions prior to 5.5.10 and 5.6.2."</code></td>
</tr>
<tr>
<td class="line" id="L296">296</td>
<td class="hits"></td>
<td class="source"><code>    %% Strip the final NUL byte if any.</code></td>
</tr>
<tr>
<td class="line" id="L297">297</td>
<td class="hits"></td>
<td class="source"><code>    %% This may also be &lt;&lt;&gt;&gt; in older versions.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L298">298</td>
<td class="hits">37</td>
<td class="source"><code>    L = byte_size(AuthPluginName) - 1,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L299">299</td>
<td class="hits">37</td>
<td class="source"><code>    AuthPluginName1 = case AuthPluginName of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L300">300</td>
<td class="hits">37</td>
<td class="source"><code>        &lt;&lt;AuthPluginNameTrimmed:L/binary, 0&gt;&gt; -&gt; AuthPluginNameTrimmed;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L301">301</td>
<td class="hits">0</td>
<td class="source"><code>        _ -&gt; AuthPluginName</code></td>
</tr>
<tr>
<td class="line" id="L302">302</td>
<td class="hits"></td>
<td class="source"><code>    end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L303">303</td>
<td class="hits">37</td>
<td class="source"><code>    #handshake{server_version = server_version_to_list(ServerVersion),</code></td>
</tr>
<tr>
<td class="line" id="L304">304</td>
<td class="hits"></td>
<td class="source"><code>               connection_id = ConnectionId,</code></td>
</tr>
<tr>
<td class="line" id="L305">305</td>
<td class="hits"></td>
<td class="source"><code>               capabilities = Capabilities,</code></td>
</tr>
<tr>
<td class="line" id="L306">306</td>
<td class="hits"></td>
<td class="source"><code>               character_set = CharacterSet,</code></td>
</tr>
<tr>
<td class="line" id="L307">307</td>
<td class="hits"></td>
<td class="source"><code>               status = StatusFlags,</code></td>
</tr>
<tr>
<td class="line" id="L308">308</td>
<td class="hits"></td>
<td class="source"><code>               auth_plugin_data = AuthPluginData,</code></td>
</tr>
<tr>
<td class="line" id="L309">309</td>
<td class="hits"></td>
<td class="source"><code>               auth_plugin_name = AuthPluginName1};</code></td>
</tr>
<tr>
<td class="line" id="L310">310</td>
<td class="hits"></td>
<td class="source"><code>parse_handshake(&lt;&lt;?ERROR, ErrNo:16/little, Msg/binary&gt;&gt;) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L311">311</td>
<td class="hits"></td>
<td class="source"><code>    %% 'Too many connections' in MariaDB 10.1.21</code></td>
</tr>
<tr>
<td class="line" id="L312">312</td>
<td class="hits"></td>
<td class="source"><code>    %% (Error packet in pre-4.1 protocol)</code></td>
</tr>
<tr class="hit">
<td class="line" id="L313">313</td>
<td class="hits">1</td>
<td class="source"><code>    #error{code = ErrNo, msg = Msg};</code></td>
</tr>
<tr>
<td class="line" id="L314">314</td>
<td class="hits"></td>
<td class="source"><code>parse_handshake(&lt;&lt;Protocol:8, _/binary&gt;&gt;) when Protocol /= 10 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L315">315</td>
<td class="hits">1</td>
<td class="source"><code>    error(unknown_protocol).</code></td>
</tr>
<tr>
<td class="line" id="L316">316</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L317">317</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Converts a version on the form `&lt;&lt;"5.6.21"&gt;' to a list `[5, 6, 21]'.</code></td>
</tr>
<tr>
<td class="line" id="L318">318</td>
<td class="hits"></td>
<td class="source"><code>-spec server_version_to_list(binary()) -&gt; [integer()].</code></td>
</tr>
<tr>
<td class="line" id="L319">319</td>
<td class="hits"></td>
<td class="source"><code>server_version_to_list(ServerVersion) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L320">320</td>
<td class="hits"></td>
<td class="source"><code>    %% This must work with e.g. "5.5.40-0ubuntu0.12.04.1-log" and "5.5.33a".</code></td>
</tr>
<tr class="hit">
<td class="line" id="L321">321</td>
<td class="hits">37</td>
<td class="source"><code>    {match, Parts} = re:run(ServerVersion, &lt;&lt;"^(\\d+)\\.(\\d+)\\.(\\d+)"&gt;&gt;,</code></td>
</tr>
<tr>
<td class="line" id="L322">322</td>
<td class="hits"></td>
<td class="source"><code>                            [{capture, all_but_first, binary}]),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L323">323</td>
<td class="hits">37</td>
<td class="source"><code>    lists:map(fun binary_to_integer/1, Parts).</code></td>
</tr>
<tr>
<td class="line" id="L324">324</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L325">325</td>
<td class="hits"></td>
<td class="source"><code>-spec maybe_do_ssl_upgrade(SockModule0 :: module(),</code></td>
</tr>
<tr>
<td class="line" id="L326">326</td>
<td class="hits"></td>
<td class="source"><code>                           Socket0 :: term(),</code></td>
</tr>
<tr>
<td class="line" id="L327">327</td>
<td class="hits"></td>
<td class="source"><code>                           SeqNum1 :: non_neg_integer(),</code></td>
</tr>
<tr>
<td class="line" id="L328">328</td>
<td class="hits"></td>
<td class="source"><code>                           Handshake :: #handshake{},</code></td>
</tr>
<tr>
<td class="line" id="L329">329</td>
<td class="hits"></td>
<td class="source"><code>                           SSLOpts :: undefined | list(),</code></td>
</tr>
<tr>
<td class="line" id="L330">330</td>
<td class="hits"></td>
<td class="source"><code>                           Database :: iodata() | undefined,</code></td>
</tr>
<tr>
<td class="line" id="L331">331</td>
<td class="hits"></td>
<td class="source"><code>                           SetFoundRows :: boolean()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L332">332</td>
<td class="hits"></td>
<td class="source"><code>    {ok, SockModule :: module(), Socket :: term(),</code></td>
</tr>
<tr>
<td class="line" id="L333">333</td>
<td class="hits"></td>
<td class="source"><code>     SeqNum2 :: non_neg_integer()}.</code></td>
</tr>
<tr>
<td class="line" id="L334">334</td>
<td class="hits"></td>
<td class="source"><code>maybe_do_ssl_upgrade(SockModule0, Socket0, SeqNum1, _Handshake, undefined,</code></td>
</tr>
<tr>
<td class="line" id="L335">335</td>
<td class="hits"></td>
<td class="source"><code>                     _Database, _SetFoundRows) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L336">336</td>
<td class="hits">36</td>
<td class="source"><code>    {ok, SockModule0, Socket0, SeqNum1};</code></td>
</tr>
<tr>
<td class="line" id="L337">337</td>
<td class="hits"></td>
<td class="source"><code>maybe_do_ssl_upgrade(gen_tcp, Socket0, SeqNum1, Handshake, SSLOpts,</code></td>
</tr>
<tr>
<td class="line" id="L338">338</td>
<td class="hits"></td>
<td class="source"><code>                     Database, SetFoundRows) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L339">339</td>
<td class="hits">1</td>
<td class="source"><code>    Response = build_handshake_response(Handshake, Database, SetFoundRows),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L340">340</td>
<td class="hits">1</td>
<td class="source"><code>    {ok, SeqNum2} = send_packet(gen_tcp, Socket0, Response, SeqNum1),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L341">341</td>
<td class="hits">1</td>
<td class="source"><code>    case ssl_connect(Socket0, SSLOpts, 5000) of</code></td>
</tr>
<tr>
<td class="line" id="L342">342</td>
<td class="hits"></td>
<td class="source"><code>        {ok, SSLSocket} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L343">343</td>
<td class="hits">1</td>
<td class="source"><code>            {ok, ssl, SSLSocket, SeqNum2};</code></td>
</tr>
<tr>
<td class="line" id="L344">344</td>
<td class="hits"></td>
<td class="source"><code>        {error, Reason} -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L345">345</td>
<td class="hits">0</td>
<td class="source"><code>            exit({failed_to_upgrade_socket, Reason})</code></td>
</tr>
<tr>
<td class="line" id="L346">346</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L347">347</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L348">348</td>
<td class="hits"></td>
<td class="source"><code>ssl_connect(Port, ConfigSSLOpts, Timeout) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L349">349</td>
<td class="hits">1</td>
<td class="source"><code>    DefaultSSLOpts = [{versions, [tlsv1]}, {verify, verify_peer}],</code></td>
</tr>
<tr class="hit">
<td class="line" id="L350">350</td>
<td class="hits">1</td>
<td class="source"><code>    MandatorySSLOpts = [{active, false}],</code></td>
</tr>
<tr class="hit">
<td class="line" id="L351">351</td>
<td class="hits">1</td>
<td class="source"><code>    MergedSSLOpts = merge_ssl_options(DefaultSSLOpts, MandatorySSLOpts, ConfigSSLOpts),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L352">352</td>
<td class="hits">1</td>
<td class="source"><code>    ssl:connect(Port, MergedSSLOpts, Timeout).</code></td>
</tr>
<tr>
<td class="line" id="L353">353</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L354">354</td>
<td class="hits"></td>
<td class="source"><code>-spec merge_ssl_options(list(), list(), list()) -&gt; list().</code></td>
</tr>
<tr>
<td class="line" id="L355">355</td>
<td class="hits"></td>
<td class="source"><code>merge_ssl_options(DefaultSSLOpts, MandatorySSLOpts, ConfigSSLOpts) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L356">356</td>
<td class="hits">1</td>
<td class="source"><code>    SSLOpts1 =</code></td>
</tr>
<tr>
<td class="line" id="L357">357</td>
<td class="hits"></td>
<td class="source"><code>    lists:foldl(fun({Key, _} = Opt, OptsAcc) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L358">358</td>
<td class="hits">2</td>
<td class="source"><code>                        lists:keystore(Key, 1, OptsAcc, Opt)</code></td>
</tr>
<tr>
<td class="line" id="L359">359</td>
<td class="hits"></td>
<td class="source"><code>                end, DefaultSSLOpts, ConfigSSLOpts),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L360">360</td>
<td class="hits">1</td>
<td class="source"><code>    lists:foldl(fun({Key, _} = Opt, OptsAcc) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L361">361</td>
<td class="hits">1</td>
<td class="source"><code>                        lists:keystore(Key, 1, OptsAcc, Opt)</code></td>
</tr>
<tr>
<td class="line" id="L362">362</td>
<td class="hits"></td>
<td class="source"><code>                end, SSLOpts1, MandatorySSLOpts).</code></td>
</tr>
<tr>
<td class="line" id="L363">363</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L364">364</td>
<td class="hits"></td>
<td class="source"><code>%% @doc This function is used when upgrading to encrypted socket. In other,</code></td>
</tr>
<tr>
<td class="line" id="L365">365</td>
<td class="hits"></td>
<td class="source"><code>%% cases, build_handshake_response/5 is used.</code></td>
</tr>
<tr>
<td class="line" id="L366">366</td>
<td class="hits"></td>
<td class="source"><code>-spec build_handshake_response(#handshake{}, iodata() | undefined, boolean()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L367">367</td>
<td class="hits"></td>
<td class="source"><code>    binary().</code></td>
</tr>
<tr>
<td class="line" id="L368">368</td>
<td class="hits"></td>
<td class="source"><code>build_handshake_response(Handshake, Database, SetFoundRows) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L369">369</td>
<td class="hits">1</td>
<td class="source"><code>    CapabilityFlags = basic_capabilities(Database /= undefined, SetFoundRows),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L370">370</td>
<td class="hits">1</td>
<td class="source"><code>    verify_server_capabilities(Handshake, CapabilityFlags),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L371">371</td>
<td class="hits">1</td>
<td class="source"><code>    ClientCapabilities = add_client_capabilities(CapabilityFlags),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L372">372</td>
<td class="hits">1</td>
<td class="source"><code>    ClientSSLCapabilities = ClientCapabilities bor ?CLIENT_SSL,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L373">373</td>
<td class="hits">1</td>
<td class="source"><code>    CharacterSet = character_set(Handshake#handshake.server_version),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L374">374</td>
<td class="hits">1</td>
<td class="source"><code>    &lt;&lt;ClientSSLCapabilities:32/little,</code></td>
</tr>
<tr>
<td class="line" id="L375">375</td>
<td class="hits"></td>
<td class="source"><code>      ?MAX_BYTES_PER_PACKET:32/little,</code></td>
</tr>
<tr>
<td class="line" id="L376">376</td>
<td class="hits"></td>
<td class="source"><code>      CharacterSet:8,</code></td>
</tr>
<tr>
<td class="line" id="L377">377</td>
<td class="hits"></td>
<td class="source"><code>      0:23/unit:8&gt;&gt;.</code></td>
</tr>
<tr>
<td class="line" id="L378">378</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L379">379</td>
<td class="hits"></td>
<td class="source"><code>%% @doc The response sent by the client to the server after receiving the</code></td>
</tr>
<tr>
<td class="line" id="L380">380</td>
<td class="hits"></td>
<td class="source"><code>%% initial handshake from the server</code></td>
</tr>
<tr>
<td class="line" id="L381">381</td>
<td class="hits"></td>
<td class="source"><code>-spec build_handshake_response(#handshake{}, iodata(), iodata(),</code></td>
</tr>
<tr>
<td class="line" id="L382">382</td>
<td class="hits"></td>
<td class="source"><code>                               iodata() | undefined, boolean()) -&gt; binary().</code></td>
</tr>
<tr>
<td class="line" id="L383">383</td>
<td class="hits"></td>
<td class="source"><code>build_handshake_response(Handshake, Username, Password, Database,</code></td>
</tr>
<tr>
<td class="line" id="L384">384</td>
<td class="hits"></td>
<td class="source"><code>                         SetFoundRows) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L385">385</td>
<td class="hits">37</td>
<td class="source"><code>    CapabilityFlags = basic_capabilities(Database /= undefined, SetFoundRows),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L386">386</td>
<td class="hits">37</td>
<td class="source"><code>    verify_server_capabilities(Handshake, CapabilityFlags),</code></td>
</tr>
<tr>
<td class="line" id="L387">387</td>
<td class="hits"></td>
<td class="source"><code>    %% Add some extra capability flags only for signalling to the server what</code></td>
</tr>
<tr>
<td class="line" id="L388">388</td>
<td class="hits"></td>
<td class="source"><code>    %% the client wants to do. The server doesn't say it handles them although</code></td>
</tr>
<tr>
<td class="line" id="L389">389</td>
<td class="hits"></td>
<td class="source"><code>    %% it does. (http://bugs.mysql.com/bug.php?id=42268)</code></td>
</tr>
<tr class="hit">
<td class="line" id="L390">390</td>
<td class="hits">37</td>
<td class="source"><code>    ClientCapabilityFlags = add_client_capabilities(CapabilityFlags),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L391">391</td>
<td class="hits">37</td>
<td class="source"><code>    Hash = case Handshake#handshake.auth_plugin_name of</code></td>
</tr>
<tr>
<td class="line" id="L392">392</td>
<td class="hits"></td>
<td class="source"><code>        &lt;&lt;&gt;&gt; -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L393">393</td>
<td class="hits"></td>
<td class="source"><code>            %% Server doesn't know auth plugins</code></td>
</tr>
<tr class="miss">
<td class="line" id="L394">394</td>
<td class="hits">0</td>
<td class="source"><code>            hash_password(Password, Handshake#handshake.auth_plugin_data);</code></td>
</tr>
<tr>
<td class="line" id="L395">395</td>
<td class="hits"></td>
<td class="source"><code>        &lt;&lt;"mysql_native_password"&gt;&gt; -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L396">396</td>
<td class="hits">37</td>
<td class="source"><code>            hash_password(Password, Handshake#handshake.auth_plugin_data);</code></td>
</tr>
<tr>
<td class="line" id="L397">397</td>
<td class="hits"></td>
<td class="source"><code>        UnknownAuthMethod -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L398">398</td>
<td class="hits">0</td>
<td class="source"><code>            error({auth_method, UnknownAuthMethod})</code></td>
</tr>
<tr>
<td class="line" id="L399">399</td>
<td class="hits"></td>
<td class="source"><code>    end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L400">400</td>
<td class="hits">37</td>
<td class="source"><code>    HashLength = size(Hash),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L401">401</td>
<td class="hits">37</td>
<td class="source"><code>    CharacterSet = character_set(Handshake#handshake.server_version),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L402">402</td>
<td class="hits">37</td>
<td class="source"><code>    UsernameUtf8 = unicode:characters_to_binary(Username),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L403">403</td>
<td class="hits">37</td>
<td class="source"><code>    DbBin = case Database of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L404">404</td>
<td class="hits">36</td>
<td class="source"><code>        undefined -&gt; &lt;&lt;&gt;&gt;;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L405">405</td>
<td class="hits">1</td>
<td class="source"><code>        _         -&gt; &lt;&lt;(iolist_to_binary(Database))/binary, 0&gt;&gt;</code></td>
</tr>
<tr>
<td class="line" id="L406">406</td>
<td class="hits"></td>
<td class="source"><code>    end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L407">407</td>
<td class="hits">37</td>
<td class="source"><code>    &lt;&lt;ClientCapabilityFlags:32/little,</code></td>
</tr>
<tr>
<td class="line" id="L408">408</td>
<td class="hits"></td>
<td class="source"><code>      ?MAX_BYTES_PER_PACKET:32/little,</code></td>
</tr>
<tr>
<td class="line" id="L409">409</td>
<td class="hits"></td>
<td class="source"><code>      CharacterSet:8,</code></td>
</tr>
<tr>
<td class="line" id="L410">410</td>
<td class="hits"></td>
<td class="source"><code>      0:23/unit:8, %% reserverd</code></td>
</tr>
<tr>
<td class="line" id="L411">411</td>
<td class="hits"></td>
<td class="source"><code>      UsernameUtf8/binary,</code></td>
</tr>
<tr>
<td class="line" id="L412">412</td>
<td class="hits"></td>
<td class="source"><code>      0, %% NUL-terminator for the username</code></td>
</tr>
<tr>
<td class="line" id="L413">413</td>
<td class="hits"></td>
<td class="source"><code>      HashLength,</code></td>
</tr>
<tr>
<td class="line" id="L414">414</td>
<td class="hits"></td>
<td class="source"><code>      Hash/binary,</code></td>
</tr>
<tr>
<td class="line" id="L415">415</td>
<td class="hits"></td>
<td class="source"><code>      DbBin/binary&gt;&gt;.</code></td>
</tr>
<tr>
<td class="line" id="L416">416</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L417">417</td>
<td class="hits"></td>
<td class="source"><code>-spec verify_server_capabilities(Handshake :: #handshake{},</code></td>
</tr>
<tr>
<td class="line" id="L418">418</td>
<td class="hits"></td>
<td class="source"><code>                                 CapabilityFlags :: integer()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L419">419</td>
<td class="hits"></td>
<td class="source"><code>    true | no_return().</code></td>
</tr>
<tr>
<td class="line" id="L420">420</td>
<td class="hits"></td>
<td class="source"><code>verify_server_capabilities(Handshake, CapabilityFlags) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L421">421</td>
<td class="hits"></td>
<td class="source"><code>    %% We require these capabilities. Make sure the server handles them.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L422">422</td>
<td class="hits">38</td>
<td class="source"><code>    Handshake#handshake.capabilities band CapabilityFlags == CapabilityFlags</code></td>
</tr>
<tr class="miss">
<td class="line" id="L423">423</td>
<td class="hits">0</td>
<td class="source"><code>        orelse error(old_server_version).</code></td>
</tr>
<tr>
<td class="line" id="L424">424</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L425">425</td>
<td class="hits"></td>
<td class="source"><code>-spec basic_capabilities(ConnectWithDB :: boolean(),</code></td>
</tr>
<tr>
<td class="line" id="L426">426</td>
<td class="hits"></td>
<td class="source"><code>                         SetFoundRows :: boolean()) -&gt; integer().</code></td>
</tr>
<tr>
<td class="line" id="L427">427</td>
<td class="hits"></td>
<td class="source"><code>basic_capabilities(ConnectWithDB, SetFoundRows) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L428">428</td>
<td class="hits">38</td>
<td class="source"><code>    CapabilityFlags0 = ?CLIENT_PROTOCOL_41 bor</code></td>
</tr>
<tr>
<td class="line" id="L429">429</td>
<td class="hits"></td>
<td class="source"><code>                       ?CLIENT_TRANSACTIONS bor</code></td>
</tr>
<tr>
<td class="line" id="L430">430</td>
<td class="hits"></td>
<td class="source"><code>                       ?CLIENT_SECURE_CONNECTION,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L431">431</td>
<td class="hits">38</td>
<td class="source"><code>    CapabilityFlags1 = case ConnectWithDB of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L432">432</td>
<td class="hits">1</td>
<td class="source"><code>                           true -&gt; CapabilityFlags0 bor ?CLIENT_CONNECT_WITH_DB;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L433">433</td>
<td class="hits">37</td>
<td class="source"><code>                           _ -&gt; CapabilityFlags0</code></td>
</tr>
<tr>
<td class="line" id="L434">434</td>
<td class="hits"></td>
<td class="source"><code>                       end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L435">435</td>
<td class="hits">38</td>
<td class="source"><code>    case SetFoundRows of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L436">436</td>
<td class="hits">1</td>
<td class="source"><code>        true -&gt; CapabilityFlags1 bor ?CLIENT_FOUND_ROWS;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L437">437</td>
<td class="hits">37</td>
<td class="source"><code>        _    -&gt; CapabilityFlags1</code></td>
</tr>
<tr>
<td class="line" id="L438">438</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L439">439</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L440">440</td>
<td class="hits"></td>
<td class="source"><code>-spec add_client_capabilities(Caps :: integer()) -&gt; integer().</code></td>
</tr>
<tr>
<td class="line" id="L441">441</td>
<td class="hits"></td>
<td class="source"><code>add_client_capabilities(Caps) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L442">442</td>
<td class="hits"></td>
<td class="source"><code>    Caps bor</code></td>
</tr>
<tr>
<td class="line" id="L443">443</td>
<td class="hits"></td>
<td class="source"><code>    ?CLIENT_MULTI_STATEMENTS bor</code></td>
</tr>
<tr class="hit">
<td class="line" id="L444">444</td>
<td class="hits">38</td>
<td class="source"><code>    ?CLIENT_MULTI_RESULTS bor</code></td>
</tr>
<tr>
<td class="line" id="L445">445</td>
<td class="hits"></td>
<td class="source"><code>    ?CLIENT_PS_MULTI_RESULTS.</code></td>
</tr>
<tr>
<td class="line" id="L446">446</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L447">447</td>
<td class="hits"></td>
<td class="source"><code>-spec character_set([integer()]) -&gt; integer().</code></td>
</tr>
<tr>
<td class="line" id="L448">448</td>
<td class="hits"></td>
<td class="source"><code>character_set(ServerVersion) when ServerVersion &gt;= [5, 5, 3] -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L449">449</td>
<td class="hits"></td>
<td class="source"><code>    %% https://dev.mysql.com/doc/relnotes/mysql/5.5/en/news-5-5-3.html</code></td>
</tr>
<tr class="hit">
<td class="line" id="L450">450</td>
<td class="hits">47</td>
<td class="source"><code>    ?UTF8MB4;</code></td>
</tr>
<tr>
<td class="line" id="L451">451</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L452">452</td>
<td class="hits"></td>
<td class="source"><code>character_set(_ServerVersion) -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L453">453</td>
<td class="hits">0</td>
<td class="source"><code>    ?UTF8MB3.</code></td>
</tr>
<tr>
<td class="line" id="L454">454</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L455">455</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Handles the second packet from the server, when we have replied to the</code></td>
</tr>
<tr>
<td class="line" id="L456">456</td>
<td class="hits"></td>
<td class="source"><code>%% initial handshake. Returns an error if the server returns an error. Raises</code></td>
</tr>
<tr>
<td class="line" id="L457">457</td>
<td class="hits"></td>
<td class="source"><code>%% an error if unimplemented features are required.</code></td>
</tr>
<tr>
<td class="line" id="L458">458</td>
<td class="hits"></td>
<td class="source"><code>-spec parse_handshake_confirm(binary()) -&gt; #ok{} | #auth_method_switch{} |</code></td>
</tr>
<tr>
<td class="line" id="L459">459</td>
<td class="hits"></td>
<td class="source"><code>                                           #error{}.</code></td>
</tr>
<tr>
<td class="line" id="L460">460</td>
<td class="hits"></td>
<td class="source"><code>parse_handshake_confirm(Packet) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L461">461</td>
<td class="hits">37</td>
<td class="source"><code>    case Packet of</code></td>
</tr>
<tr>
<td class="line" id="L462">462</td>
<td class="hits"></td>
<td class="source"><code>        ?ok_pattern -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L463">463</td>
<td class="hits"></td>
<td class="source"><code>            %% Connection complete.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L464">464</td>
<td class="hits">36</td>
<td class="source"><code>            parse_ok_packet(Packet);</code></td>
</tr>
<tr>
<td class="line" id="L465">465</td>
<td class="hits"></td>
<td class="source"><code>        ?error_pattern -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L466">466</td>
<td class="hits"></td>
<td class="source"><code>            %% Access denied, insufficient client capabilities, etc.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L467">467</td>
<td class="hits">1</td>
<td class="source"><code>            parse_error_packet(Packet);</code></td>
</tr>
<tr>
<td class="line" id="L468">468</td>
<td class="hits"></td>
<td class="source"><code>        &lt;&lt;?EOF&gt;&gt; -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L469">469</td>
<td class="hits"></td>
<td class="source"><code>            %% "Old Authentication Method Switch Request Packet consisting of a</code></td>
</tr>
<tr>
<td class="line" id="L470">470</td>
<td class="hits"></td>
<td class="source"><code>            %% single 0xfe byte. It is sent by server to request client to</code></td>
</tr>
<tr>
<td class="line" id="L471">471</td>
<td class="hits"></td>
<td class="source"><code>            %% switch to Old Password Authentication if CLIENT_PLUGIN_AUTH</code></td>
</tr>
<tr>
<td class="line" id="L472">472</td>
<td class="hits"></td>
<td class="source"><code>            %% capability is not supported (by either the client or the server)"</code></td>
</tr>
<tr class="miss">
<td class="line" id="L473">473</td>
<td class="hits">0</td>
<td class="source"><code>            error(old_auth);</code></td>
</tr>
<tr>
<td class="line" id="L474">474</td>
<td class="hits"></td>
<td class="source"><code>        &lt;&lt;?EOF, AuthMethodSwitch/binary&gt;&gt; -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L475">475</td>
<td class="hits"></td>
<td class="source"><code>            %% "Authentication Method Switch Request Packet. If both server and</code></td>
</tr>
<tr>
<td class="line" id="L476">476</td>
<td class="hits"></td>
<td class="source"><code>            %% client support CLIENT_PLUGIN_AUTH capability, server can send</code></td>
</tr>
<tr>
<td class="line" id="L477">477</td>
<td class="hits"></td>
<td class="source"><code>            %% this packet to ask client to use another authentication method."</code></td>
</tr>
<tr class="miss">
<td class="line" id="L478">478</td>
<td class="hits">0</td>
<td class="source"><code>            parse_auth_method_switch(AuthMethodSwitch)</code></td>
</tr>
<tr>
<td class="line" id="L479">479</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L480">480</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L481">481</td>
<td class="hits"></td>
<td class="source"><code>%% -- both text and binary protocol --</code></td>
</tr>
<tr>
<td class="line" id="L482">482</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L483">483</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Fetches one or more results and and parses the result set(s) using</code></td>
</tr>
<tr>
<td class="line" id="L484">484</td>
<td class="hits"></td>
<td class="source"><code>%% either the text format (for plain queries) or the binary format (for</code></td>
</tr>
<tr>
<td class="line" id="L485">485</td>
<td class="hits"></td>
<td class="source"><code>%% prepared statements).</code></td>
</tr>
<tr>
<td class="line" id="L486">486</td>
<td class="hits"></td>
<td class="source"><code>-spec fetch_response(module(), term(), timeout(), text | binary,</code></td>
</tr>
<tr>
<td class="line" id="L487">487</td>
<td class="hits"></td>
<td class="source"><code>                     query_filtermap(), list()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L488">488</td>
<td class="hits"></td>
<td class="source"><code>    {ok, [#ok{} | #resultset{} | #error{}]} | {error, timeout}.</code></td>
</tr>
<tr>
<td class="line" id="L489">489</td>
<td class="hits"></td>
<td class="source"><code>fetch_response(SockModule, Socket, Timeout, Proto, FilterMap, Acc) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L490">490</td>
<td class="hits">700</td>
<td class="source"><code>    case recv_packet(SockModule, Socket, Timeout, any) of</code></td>
</tr>
<tr>
<td class="line" id="L491">491</td>
<td class="hits"></td>
<td class="source"><code>        {ok, Packet, SeqNum2} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L492">492</td>
<td class="hits">697</td>
<td class="source"><code>            Result = case Packet of</code></td>
</tr>
<tr>
<td class="line" id="L493">493</td>
<td class="hits"></td>
<td class="source"><code>                ?ok_pattern -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L494">494</td>
<td class="hits">413</td>
<td class="source"><code>                    parse_ok_packet(Packet);</code></td>
</tr>
<tr>
<td class="line" id="L495">495</td>
<td class="hits"></td>
<td class="source"><code>                ?error_pattern -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L496">496</td>
<td class="hits">8</td>
<td class="source"><code>                    parse_error_packet(Packet);</code></td>
</tr>
<tr>
<td class="line" id="L497">497</td>
<td class="hits"></td>
<td class="source"><code>                ResultPacket -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L498">498</td>
<td class="hits"></td>
<td class="source"><code>                    %% The first packet in a resultset is only the column count.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L499">499</td>
<td class="hits">276</td>
<td class="source"><code>                    {ColCount, &lt;&lt;&gt;&gt;} = lenenc_int(ResultPacket),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L500">500</td>
<td class="hits">276</td>
<td class="source"><code>                    fetch_resultset(SockModule, Socket, ColCount, Proto,</code></td>
</tr>
<tr>
<td class="line" id="L501">501</td>
<td class="hits"></td>
<td class="source"><code>                                    FilterMap, SeqNum2)</code></td>
</tr>
<tr>
<td class="line" id="L502">502</td>
<td class="hits"></td>
<td class="source"><code>            end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L503">503</td>
<td class="hits">697</td>
<td class="source"><code>            Acc1 = [Result | Acc],</code></td>
</tr>
<tr class="hit">
<td class="line" id="L504">504</td>
<td class="hits">697</td>
<td class="source"><code>            case more_results_exists(Result) of</code></td>
</tr>
<tr>
<td class="line" id="L505">505</td>
<td class="hits"></td>
<td class="source"><code>                true -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L506">506</td>
<td class="hits">8</td>
<td class="source"><code>                    fetch_response(SockModule, Socket, Timeout, Proto,</code></td>
</tr>
<tr>
<td class="line" id="L507">507</td>
<td class="hits"></td>
<td class="source"><code>                                   FilterMap, Acc1);</code></td>
</tr>
<tr>
<td class="line" id="L508">508</td>
<td class="hits"></td>
<td class="source"><code>                false -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L509">509</td>
<td class="hits">689</td>
<td class="source"><code>                    {ok, lists:reverse(Acc1)}</code></td>
</tr>
<tr>
<td class="line" id="L510">510</td>
<td class="hits"></td>
<td class="source"><code>            end;</code></td>
</tr>
<tr>
<td class="line" id="L511">511</td>
<td class="hits"></td>
<td class="source"><code>        {error, timeout} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L512">512</td>
<td class="hits">3</td>
<td class="source"><code>            {error, timeout}</code></td>
</tr>
<tr>
<td class="line" id="L513">513</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L514">514</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L515">515</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Fetches a result set.</code></td>
</tr>
<tr>
<td class="line" id="L516">516</td>
<td class="hits"></td>
<td class="source"><code>-spec fetch_resultset(module(), term(), integer(), text | binary,</code></td>
</tr>
<tr>
<td class="line" id="L517">517</td>
<td class="hits"></td>
<td class="source"><code>                      query_filtermap(), integer()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L518">518</td>
<td class="hits"></td>
<td class="source"><code>    #resultset{} | #error{}.</code></td>
</tr>
<tr>
<td class="line" id="L519">519</td>
<td class="hits"></td>
<td class="source"><code>fetch_resultset(SockModule, Socket, FieldCount, Proto, FilterMap, SeqNum0) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L520">520</td>
<td class="hits">276</td>
<td class="source"><code>    {ok, ColDefs0, SeqNum1} = fetch_column_definitions(SockModule, Socket,</code></td>
</tr>
<tr>
<td class="line" id="L521">521</td>
<td class="hits"></td>
<td class="source"><code>                                                       SeqNum0, FieldCount, []),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L522">522</td>
<td class="hits">276</td>
<td class="source"><code>    {ok, DelimPacket, SeqNum2} = recv_packet(SockModule, Socket, SeqNum1),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L523">523</td>
<td class="hits">276</td>
<td class="source"><code>    #eof{status = S, warning_count = W} = parse_eof_packet(DelimPacket),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L524">524</td>
<td class="hits">276</td>
<td class="source"><code>    ColDefs1 = lists:map(fun parse_column_definition/1, ColDefs0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L525">525</td>
<td class="hits">276</td>
<td class="source"><code>    case fetch_resultset_rows(SockModule, Socket, FieldCount, ColDefs1, Proto,</code></td>
</tr>
<tr>
<td class="line" id="L526">526</td>
<td class="hits"></td>
<td class="source"><code>                              FilterMap, SeqNum2, []) of</code></td>
</tr>
<tr>
<td class="line" id="L527">527</td>
<td class="hits"></td>
<td class="source"><code>        {ok, Rows, _SeqNum3} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L528">528</td>
<td class="hits">275</td>
<td class="source"><code>            #resultset{cols = ColDefs1, rows = Rows, status = S,</code></td>
</tr>
<tr>
<td class="line" id="L529">529</td>
<td class="hits"></td>
<td class="source"><code>                       warning_count = W};</code></td>
</tr>
<tr>
<td class="line" id="L530">530</td>
<td class="hits"></td>
<td class="source"><code>        #error{} = E -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L531">531</td>
<td class="hits">1</td>
<td class="source"><code>            E</code></td>
</tr>
<tr>
<td class="line" id="L532">532</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L533">533</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L534">534</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Fetches the rows for a result set and decodes them using either the text</code></td>
</tr>
<tr>
<td class="line" id="L535">535</td>
<td class="hits"></td>
<td class="source"><code>%% format (for plain queries) or binary format (for prepared statements).</code></td>
</tr>
<tr>
<td class="line" id="L536">536</td>
<td class="hits"></td>
<td class="source"><code>-spec fetch_resultset_rows(module(), term(), integer(), [#col{}], text | binary,</code></td>
</tr>
<tr>
<td class="line" id="L537">537</td>
<td class="hits"></td>
<td class="source"><code>                           query_filtermap(), integer(), [[term()]]) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L538">538</td>
<td class="hits"></td>
<td class="source"><code>    {ok, [[term()]], integer()} | #error{}.</code></td>
</tr>
<tr>
<td class="line" id="L539">539</td>
<td class="hits"></td>
<td class="source"><code>fetch_resultset_rows(SockModule, Socket, FieldCount, ColDefs, Proto,</code></td>
</tr>
<tr>
<td class="line" id="L540">540</td>
<td class="hits"></td>
<td class="source"><code>                     FilterMap, SeqNum0, Acc) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L541">541</td>
<td class="hits">559</td>
<td class="source"><code>    {ok, Packet, SeqNum1} = recv_packet(SockModule, Socket, SeqNum0),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L542">542</td>
<td class="hits">559</td>
<td class="source"><code>    case Packet of</code></td>
</tr>
<tr>
<td class="line" id="L543">543</td>
<td class="hits"></td>
<td class="source"><code>        ?error_pattern -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L544">544</td>
<td class="hits">1</td>
<td class="source"><code>            parse_error_packet(Packet);</code></td>
</tr>
<tr>
<td class="line" id="L545">545</td>
<td class="hits"></td>
<td class="source"><code>        ?eof_pattern -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L546">546</td>
<td class="hits">275</td>
<td class="source"><code>            {ok, lists:reverse(Acc), SeqNum1};</code></td>
</tr>
<tr>
<td class="line" id="L547">547</td>
<td class="hits"></td>
<td class="source"><code>        RowPacket -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L548">548</td>
<td class="hits">283</td>
<td class="source"><code>            Row0=decode_row(FieldCount, ColDefs, RowPacket, Proto),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L549">549</td>
<td class="hits">283</td>
<td class="source"><code>            Acc1 = case filtermap_resultset_row(FilterMap, ColDefs, Row0) of</code></td>
</tr>
<tr>
<td class="line" id="L550">550</td>
<td class="hits"></td>
<td class="source"><code>                false -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L551">551</td>
<td class="hits">6</td>
<td class="source"><code>                    Acc;</code></td>
</tr>
<tr>
<td class="line" id="L552">552</td>
<td class="hits"></td>
<td class="source"><code>                true -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L553">553</td>
<td class="hits">271</td>
<td class="source"><code>                    [Row0|Acc];</code></td>
</tr>
<tr>
<td class="line" id="L554">554</td>
<td class="hits"></td>
<td class="source"><code>                {true, Row1} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L555">555</td>
<td class="hits">6</td>
<td class="source"><code>                    [Row1|Acc]</code></td>
</tr>
<tr>
<td class="line" id="L556">556</td>
<td class="hits"></td>
<td class="source"><code>            end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L557">557</td>
<td class="hits">283</td>
<td class="source"><code>            fetch_resultset_rows(SockModule, Socket, FieldCount, ColDefs,</code></td>
</tr>
<tr>
<td class="line" id="L558">558</td>
<td class="hits"></td>
<td class="source"><code>                                 Proto, FilterMap, SeqNum1, Acc1)</code></td>
</tr>
<tr>
<td class="line" id="L559">559</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L560">560</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L561">561</td>
<td class="hits"></td>
<td class="source"><code>-spec filtermap_resultset_row(query_filtermap(), [#col{}], [term()]) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L562">562</td>
<td class="hits"></td>
<td class="source"><code>    query_filtermap_res().</code></td>
</tr>
<tr>
<td class="line" id="L563">563</td>
<td class="hits"></td>
<td class="source"><code>filtermap_resultset_row(no_filtermap_fun, _, _) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L564">564</td>
<td class="hits">265</td>
<td class="source"><code>    true;</code></td>
</tr>
<tr>
<td class="line" id="L565">565</td>
<td class="hits"></td>
<td class="source"><code>filtermap_resultset_row(Fun, _, Row) when is_function(Fun, 1) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L566">566</td>
<td class="hits">9</td>
<td class="source"><code>    Fun(Row);</code></td>
</tr>
<tr>
<td class="line" id="L567">567</td>
<td class="hits"></td>
<td class="source"><code>filtermap_resultset_row(Fun, ColDefs, Row) when is_function(Fun, 2) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L568">568</td>
<td class="hits">9</td>
<td class="source"><code>    Fun([Col#col.name || Col &lt;- ColDefs], Row).</code></td>
</tr>
<tr>
<td class="line" id="L569">569</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L570">570</td>
<td class="hits"></td>
<td class="source"><code>more_results_exists(#ok{status = S}) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L571">571</td>
<td class="hits">413</td>
<td class="source"><code>    S band ?SERVER_MORE_RESULTS_EXISTS /= 0;</code></td>
</tr>
<tr>
<td class="line" id="L572">572</td>
<td class="hits"></td>
<td class="source"><code>more_results_exists(#error{}) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L573">573</td>
<td class="hits">9</td>
<td class="source"><code>    false; %% No status bits for error</code></td>
</tr>
<tr>
<td class="line" id="L574">574</td>
<td class="hits"></td>
<td class="source"><code>more_results_exists(#resultset{status = S}) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L575">575</td>
<td class="hits">275</td>
<td class="source"><code>    S band ?SERVER_MORE_RESULTS_EXISTS /= 0.</code></td>
</tr>
<tr>
<td class="line" id="L576">576</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L577">577</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Receives NumLeft column definition packets. They are not parsed.</code></td>
</tr>
<tr>
<td class="line" id="L578">578</td>
<td class="hits"></td>
<td class="source"><code>%% @see parse_column_definition/1</code></td>
</tr>
<tr>
<td class="line" id="L579">579</td>
<td class="hits"></td>
<td class="source"><code>-spec fetch_column_definitions(module(), term(), SeqNum :: integer(),</code></td>
</tr>
<tr>
<td class="line" id="L580">580</td>
<td class="hits"></td>
<td class="source"><code>                               NumLeft :: integer(), Acc :: [binary()]) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L581">581</td>
<td class="hits"></td>
<td class="source"><code>    {ok, ColDefPackets :: [binary()], NextSeqNum :: integer()}.</code></td>
</tr>
<tr>
<td class="line" id="L582">582</td>
<td class="hits"></td>
<td class="source"><code>fetch_column_definitions(SockModule, Socket, SeqNum, NumLeft, Acc)</code></td>
</tr>
<tr>
<td class="line" id="L583">583</td>
<td class="hits"></td>
<td class="source"><code>  when NumLeft &gt; 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L584">584</td>
<td class="hits">461</td>
<td class="source"><code>    {ok, Packet, SeqNum1} = recv_packet(SockModule, Socket, SeqNum),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L585">585</td>
<td class="hits">461</td>
<td class="source"><code>    fetch_column_definitions(SockModule, Socket, SeqNum1, NumLeft - 1,</code></td>
</tr>
<tr>
<td class="line" id="L586">586</td>
<td class="hits"></td>
<td class="source"><code>                             [Packet | Acc]);</code></td>
</tr>
<tr>
<td class="line" id="L587">587</td>
<td class="hits"></td>
<td class="source"><code>fetch_column_definitions(_SockModule, _Socket, SeqNum, 0, Acc) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L588">588</td>
<td class="hits">395</td>
<td class="source"><code>    {ok, lists:reverse(Acc), SeqNum}.</code></td>
</tr>
<tr>
<td class="line" id="L589">589</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L590">590</td>
<td class="hits"></td>
<td class="source"><code>%% Parses a packet containing a column definition (part of a result set)</code></td>
</tr>
<tr>
<td class="line" id="L591">591</td>
<td class="hits"></td>
<td class="source"><code>parse_column_definition(Data) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L592">592</td>
<td class="hits">318</td>
<td class="source"><code>    {&lt;&lt;"def"&gt;&gt;, Rest1} = lenenc_str(Data),   %% catalog (always "def")</code></td>
</tr>
<tr class="hit">
<td class="line" id="L593">593</td>
<td class="hits">318</td>
<td class="source"><code>    {_Schema, Rest2} = lenenc_str(Rest1),    %% schema-name</code></td>
</tr>
<tr class="hit">
<td class="line" id="L594">594</td>
<td class="hits">318</td>
<td class="source"><code>    {_Table, Rest3} = lenenc_str(Rest2),     %% virtual table-name</code></td>
</tr>
<tr class="hit">
<td class="line" id="L595">595</td>
<td class="hits">318</td>
<td class="source"><code>    {_OrgTable, Rest4} = lenenc_str(Rest3),  %% physical table-name</code></td>
</tr>
<tr class="hit">
<td class="line" id="L596">596</td>
<td class="hits">318</td>
<td class="source"><code>    {Name, Rest5} = lenenc_str(Rest4),       %% virtual column name</code></td>
</tr>
<tr class="hit">
<td class="line" id="L597">597</td>
<td class="hits">318</td>
<td class="source"><code>    {_OrgName, Rest6} = lenenc_str(Rest5),   %% physical column name</code></td>
</tr>
<tr class="hit">
<td class="line" id="L598">598</td>
<td class="hits">318</td>
<td class="source"><code>    {16#0c, Rest7} = lenenc_int(Rest6),      %% length of the following fields</code></td>
</tr>
<tr>
<td class="line" id="L599">599</td>
<td class="hits"></td>
<td class="source"><code>                                             %% (always 0x0c)</code></td>
</tr>
<tr>
<td class="line" id="L600">600</td>
<td class="hits"></td>
<td class="source"><code>    &lt;&lt;Charset:16/little,        %% column character set</code></td>
</tr>
<tr>
<td class="line" id="L601">601</td>
<td class="hits"></td>
<td class="source"><code>      Length:32/little,         %% maximum length of the field</code></td>
</tr>
<tr>
<td class="line" id="L602">602</td>
<td class="hits"></td>
<td class="source"><code>      Type:8,                   %% type of the column as defined in Column Type</code></td>
</tr>
<tr>
<td class="line" id="L603">603</td>
<td class="hits"></td>
<td class="source"><code>      Flags:16/little,          %% flags</code></td>
</tr>
<tr>
<td class="line" id="L604">604</td>
<td class="hits"></td>
<td class="source"><code>      Decimals:8,               %% max shown decimal digits:</code></td>
</tr>
<tr>
<td class="line" id="L605">605</td>
<td class="hits"></td>
<td class="source"><code>      0,  %% "filler"           %%   - 0x00 for integers and static strings</code></td>
</tr>
<tr>
<td class="line" id="L606">606</td>
<td class="hits"></td>
<td class="source"><code>      0,                        %%   - 0x1f for dynamic strings, double, float</code></td>
</tr>
<tr class="hit">
<td class="line" id="L607">607</td>
<td class="hits">318</td>
<td class="source"><code>      Rest8/binary&gt;&gt; = Rest7,   %%   - 0x00 to 0x51 for decimals</code></td>
</tr>
<tr>
<td class="line" id="L608">608</td>
<td class="hits"></td>
<td class="source"><code>    %% Here, if command was COM_FIELD_LIST {</code></td>
</tr>
<tr>
<td class="line" id="L609">609</td>
<td class="hits"></td>
<td class="source"><code>    %%   default values: lenenc_str</code></td>
</tr>
<tr>
<td class="line" id="L610">610</td>
<td class="hits"></td>
<td class="source"><code>    %% }</code></td>
</tr>
<tr class="hit">
<td class="line" id="L611">611</td>
<td class="hits">318</td>
<td class="source"><code>    &lt;&lt;&gt;&gt; = Rest8,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L612">612</td>
<td class="hits">318</td>
<td class="source"><code>    #col{name = Name, type = Type, charset = Charset, length = Length,</code></td>
</tr>
<tr>
<td class="line" id="L613">613</td>
<td class="hits"></td>
<td class="source"><code>         decimals = Decimals, flags = Flags}.</code></td>
</tr>
<tr>
<td class="line" id="L614">614</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L615">615</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Decodes a row using either the text or binary format.</code></td>
</tr>
<tr>
<td class="line" id="L616">616</td>
<td class="hits"></td>
<td class="source"><code>-spec decode_row(integer(), [#col{}], binary(), text | binary) -&gt; [term()].</code></td>
</tr>
<tr>
<td class="line" id="L617">617</td>
<td class="hits"></td>
<td class="source"><code>decode_row(FieldCount, ColDefs, RowPacket, text) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L618">618</td>
<td class="hits">157</td>
<td class="source"><code>    decode_text_row(FieldCount, ColDefs, RowPacket);</code></td>
</tr>
<tr>
<td class="line" id="L619">619</td>
<td class="hits"></td>
<td class="source"><code>decode_row(FieldCount, ColDefs, RowPacket, binary) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L620">620</td>
<td class="hits">126</td>
<td class="source"><code>    decode_binary_row(FieldCount, ColDefs, RowPacket).</code></td>
</tr>
<tr>
<td class="line" id="L621">621</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L622">622</td>
<td class="hits"></td>
<td class="source"><code>%% -- text protocol --</code></td>
</tr>
<tr>
<td class="line" id="L623">623</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L624">624</td>
<td class="hits"></td>
<td class="source"><code>-spec decode_text_row(NumColumns :: integer(),</code></td>
</tr>
<tr>
<td class="line" id="L625">625</td>
<td class="hits"></td>
<td class="source"><code>                      ColumnDefinitions :: [#col{}],</code></td>
</tr>
<tr>
<td class="line" id="L626">626</td>
<td class="hits"></td>
<td class="source"><code>                      Data :: binary()) -&gt; [term()].</code></td>
</tr>
<tr>
<td class="line" id="L627">627</td>
<td class="hits"></td>
<td class="source"><code>decode_text_row(_NumColumns, ColumnDefs, Data) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L628">628</td>
<td class="hits">157</td>
<td class="source"><code>    decode_text_row_acc(ColumnDefs, Data, []).</code></td>
</tr>
<tr>
<td class="line" id="L629">629</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L630">630</td>
<td class="hits"></td>
<td class="source"><code>%% parses Data using ColDefs and builds the values Acc.</code></td>
</tr>
<tr>
<td class="line" id="L631">631</td>
<td class="hits"></td>
<td class="source"><code>decode_text_row_acc([ColDef | ColDefs], Data, Acc) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L632">632</td>
<td class="hits">180</td>
<td class="source"><code>    case Data of</code></td>
</tr>
<tr>
<td class="line" id="L633">633</td>
<td class="hits"></td>
<td class="source"><code>        &lt;&lt;16#fb, Rest/binary&gt;&gt; -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L634">634</td>
<td class="hits"></td>
<td class="source"><code>            %% NULL</code></td>
</tr>
<tr class="hit">
<td class="line" id="L635">635</td>
<td class="hits">2</td>
<td class="source"><code>            decode_text_row_acc(ColDefs, Rest, [null | Acc]);</code></td>
</tr>
<tr>
<td class="line" id="L636">636</td>
<td class="hits"></td>
<td class="source"><code>        _ -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L637">637</td>
<td class="hits"></td>
<td class="source"><code>            %% Every thing except NULL</code></td>
</tr>
<tr class="hit">
<td class="line" id="L638">638</td>
<td class="hits">178</td>
<td class="source"><code>            {Text, Rest} = lenenc_str(Data),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L639">639</td>
<td class="hits">178</td>
<td class="source"><code>            Term = decode_text(ColDef, Text),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L640">640</td>
<td class="hits">178</td>
<td class="source"><code>            decode_text_row_acc(ColDefs, Rest, [Term | Acc])</code></td>
</tr>
<tr>
<td class="line" id="L641">641</td>
<td class="hits"></td>
<td class="source"><code>    end;</code></td>
</tr>
<tr>
<td class="line" id="L642">642</td>
<td class="hits"></td>
<td class="source"><code>decode_text_row_acc([], &lt;&lt;&gt;&gt;, Acc) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L643">643</td>
<td class="hits">157</td>
<td class="source"><code>    lists:reverse(Acc).</code></td>
</tr>
<tr>
<td class="line" id="L644">644</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L645">645</td>
<td class="hits"></td>
<td class="source"><code>%% @doc When receiving data in the text protocol, we get everything as binaries</code></td>
</tr>
<tr>
<td class="line" id="L646">646</td>
<td class="hits"></td>
<td class="source"><code>%% (except NULL). This function is used to parse these string values.</code></td>
</tr>
<tr>
<td class="line" id="L647">647</td>
<td class="hits"></td>
<td class="source"><code>decode_text(#col{type = T}, Text)</code></td>
</tr>
<tr>
<td class="line" id="L648">648</td>
<td class="hits"></td>
<td class="source"><code>  when T == ?TYPE_TINY; T == ?TYPE_SHORT; T == ?TYPE_LONG; T == ?TYPE_LONGLONG;</code></td>
</tr>
<tr>
<td class="line" id="L649">649</td>
<td class="hits"></td>
<td class="source"><code>       T == ?TYPE_INT24; T == ?TYPE_YEAR -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L650">650</td>
<td class="hits">72</td>
<td class="source"><code>    binary_to_integer(Text);</code></td>
</tr>
<tr>
<td class="line" id="L651">651</td>
<td class="hits"></td>
<td class="source"><code>decode_text(#col{type = T}, Text)</code></td>
</tr>
<tr>
<td class="line" id="L652">652</td>
<td class="hits"></td>
<td class="source"><code>  when T == ?TYPE_STRING; T == ?TYPE_VARCHAR; T == ?TYPE_VAR_STRING;</code></td>
</tr>
<tr>
<td class="line" id="L653">653</td>
<td class="hits"></td>
<td class="source"><code>       T == ?TYPE_ENUM; T == ?TYPE_SET; T == ?TYPE_LONG_BLOB;</code></td>
</tr>
<tr>
<td class="line" id="L654">654</td>
<td class="hits"></td>
<td class="source"><code>       T == ?TYPE_MEDIUM_BLOB; T == ?TYPE_BLOB; T == ?TYPE_TINY_BLOB;</code></td>
</tr>
<tr>
<td class="line" id="L655">655</td>
<td class="hits"></td>
<td class="source"><code>       T == ?TYPE_GEOMETRY; T == ?TYPE_JSON -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L656">656</td>
<td class="hits"></td>
<td class="source"><code>    %% As of MySQL 5.6.21 we receive SET and ENUM values as STRING, i.e. we</code></td>
</tr>
<tr>
<td class="line" id="L657">657</td>
<td class="hits"></td>
<td class="source"><code>    %% cannot convert them to atom() or sets:set(), etc.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L658">658</td>
<td class="hits">41</td>
<td class="source"><code>    Text;</code></td>
</tr>
<tr>
<td class="line" id="L659">659</td>
<td class="hits"></td>
<td class="source"><code>decode_text(#col{type = ?TYPE_BIT, length = Length}, Text) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L660">660</td>
<td class="hits"></td>
<td class="source"><code>    %% Convert to &lt;&lt;_:Length/bitstring&gt;&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L661">661</td>
<td class="hits">5</td>
<td class="source"><code>    decode_bitstring(Text, Length);</code></td>
</tr>
<tr>
<td class="line" id="L662">662</td>
<td class="hits"></td>
<td class="source"><code>decode_text(#col{type = T, decimals = S, length = L}, Text)</code></td>
</tr>
<tr>
<td class="line" id="L663">663</td>
<td class="hits"></td>
<td class="source"><code>  when T == ?TYPE_DECIMAL; T == ?TYPE_NEWDECIMAL -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L664">664</td>
<td class="hits"></td>
<td class="source"><code>    %% Length is the max number of symbols incl. dot and minus sign, e.g. the</code></td>
</tr>
<tr>
<td class="line" id="L665">665</td>
<td class="hits"></td>
<td class="source"><code>    %% number of digits plus 2.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L666">666</td>
<td class="hits">19</td>
<td class="source"><code>    decode_decimal(Text, L - 2, S);</code></td>
</tr>
<tr>
<td class="line" id="L667">667</td>
<td class="hits"></td>
<td class="source"><code>decode_text(#col{type = ?TYPE_DATE},</code></td>
</tr>
<tr>
<td class="line" id="L668">668</td>
<td class="hits"></td>
<td class="source"><code>            &lt;&lt;Y:4/binary, "-", M:2/binary, "-", D:2/binary&gt;&gt;) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L669">669</td>
<td class="hits">6</td>
<td class="source"><code>    {binary_to_integer(Y), binary_to_integer(M), binary_to_integer(D)};</code></td>
</tr>
<tr>
<td class="line" id="L670">670</td>
<td class="hits"></td>
<td class="source"><code>decode_text(#col{type = ?TYPE_TIME}, Text) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L671">671</td>
<td class="hits">23</td>
<td class="source"><code>    {match, [Sign, Hbin, Mbin, Sbin, Frac]} =</code></td>
</tr>
<tr>
<td class="line" id="L672">672</td>
<td class="hits"></td>
<td class="source"><code>        re:run(Text,</code></td>
</tr>
<tr>
<td class="line" id="L673">673</td>
<td class="hits"></td>
<td class="source"><code>               &lt;&lt;"^(-?)(\\d+):(\\d+):(\\d+)(\\.?\\d*)$"&gt;&gt;,</code></td>
</tr>
<tr>
<td class="line" id="L674">674</td>
<td class="hits"></td>
<td class="source"><code>               [{capture, all_but_first, binary}]),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L675">675</td>
<td class="hits">23</td>
<td class="source"><code>    H = binary_to_integer(Hbin),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L676">676</td>
<td class="hits">23</td>
<td class="source"><code>    M = binary_to_integer(Mbin),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L677">677</td>
<td class="hits">23</td>
<td class="source"><code>    S = binary_to_integer(Sbin),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L678">678</td>
<td class="hits">23</td>
<td class="source"><code>    IsNeg = Sign == &lt;&lt;"-"&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L679">679</td>
<td class="hits">23</td>
<td class="source"><code>    Fraction = case Frac of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L680">680</td>
<td class="hits">19</td>
<td class="source"><code>        &lt;&lt;&gt;&gt; -&gt; 0;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L681">681</td>
<td class="hits">2</td>
<td class="source"><code>        _ when not IsNeg -&gt; binary_to_float(&lt;&lt;"0", Frac/binary&gt;&gt;);</code></td>
</tr>
<tr class="hit">
<td class="line" id="L682">682</td>
<td class="hits">2</td>
<td class="source"><code>        _ when IsNeg -&gt; 1 - binary_to_float(&lt;&lt;"0", Frac/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L683">683</td>
<td class="hits"></td>
<td class="source"><code>    end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L684">684</td>
<td class="hits">23</td>
<td class="source"><code>    Sec1 = H * 3600 + M * 60 + S,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L685">685</td>
<td class="hits">23</td>
<td class="source"><code>    Sec2 = if IsNeg -&gt; -Sec1; true -&gt; Sec1 end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L686">686</td>
<td class="hits">23</td>
<td class="source"><code>    Sec3 = if IsNeg and (Fraction /= 0) -&gt; Sec2 - 1;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L687">687</td>
<td class="hits">21</td>
<td class="source"><code>              true                      -&gt; Sec2</code></td>
</tr>
<tr>
<td class="line" id="L688">688</td>
<td class="hits"></td>
<td class="source"><code>           end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L689">689</td>
<td class="hits">23</td>
<td class="source"><code>    {Days, {Hours, Minutes, Seconds}} = calendar:seconds_to_daystime(Sec3),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L690">690</td>
<td class="hits">23</td>
<td class="source"><code>    {Days, {Hours, Minutes, Seconds + Fraction}};</code></td>
</tr>
<tr>
<td class="line" id="L691">691</td>
<td class="hits"></td>
<td class="source"><code>decode_text(#col{type = T},</code></td>
</tr>
<tr>
<td class="line" id="L692">692</td>
<td class="hits"></td>
<td class="source"><code>            &lt;&lt;Y:4/binary, "-", M:2/binary, "-", D:2/binary, " ",</code></td>
</tr>
<tr>
<td class="line" id="L693">693</td>
<td class="hits"></td>
<td class="source"><code>              H:2/binary, ":", Mi:2/binary, ":", S:2/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L694">694</td>
<td class="hits"></td>
<td class="source"><code>  when T == ?TYPE_TIMESTAMP; T == ?TYPE_DATETIME -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L695">695</td>
<td class="hits"></td>
<td class="source"><code>    %% Without fractions.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L696">696</td>
<td class="hits">9</td>
<td class="source"><code>    {{binary_to_integer(Y), binary_to_integer(M), binary_to_integer(D)},</code></td>
</tr>
<tr>
<td class="line" id="L697">697</td>
<td class="hits"></td>
<td class="source"><code>     {binary_to_integer(H), binary_to_integer(Mi), binary_to_integer(S)}};</code></td>
</tr>
<tr>
<td class="line" id="L698">698</td>
<td class="hits"></td>
<td class="source"><code>decode_text(#col{type = T},</code></td>
</tr>
<tr>
<td class="line" id="L699">699</td>
<td class="hits"></td>
<td class="source"><code>            &lt;&lt;Y:4/binary, "-", M:2/binary, "-", D:2/binary, " ",</code></td>
</tr>
<tr>
<td class="line" id="L700">700</td>
<td class="hits"></td>
<td class="source"><code>              H:2/binary, ":", Mi:2/binary, ":", FloatS/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L701">701</td>
<td class="hits"></td>
<td class="source"><code>  when T == ?TYPE_TIMESTAMP; T == ?TYPE_DATETIME -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L702">702</td>
<td class="hits"></td>
<td class="source"><code>    %% With fractions.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L703">703</td>
<td class="hits">2</td>
<td class="source"><code>    {{binary_to_integer(Y), binary_to_integer(M), binary_to_integer(D)},</code></td>
</tr>
<tr>
<td class="line" id="L704">704</td>
<td class="hits"></td>
<td class="source"><code>     {binary_to_integer(H), binary_to_integer(Mi), binary_to_float(FloatS)}};</code></td>
</tr>
<tr>
<td class="line" id="L705">705</td>
<td class="hits"></td>
<td class="source"><code>decode_text(#col{type = T}, Text) when T == ?TYPE_FLOAT;</code></td>
</tr>
<tr>
<td class="line" id="L706">706</td>
<td class="hits"></td>
<td class="source"><code>                                                     T == ?TYPE_DOUBLE -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L707">707</td>
<td class="hits">28</td>
<td class="source"><code>    try binary_to_float(Text)</code></td>
</tr>
<tr>
<td class="line" id="L708">708</td>
<td class="hits"></td>
<td class="source"><code>    catch error:badarg -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L709">709</td>
<td class="hits">10</td>
<td class="source"><code>        try binary_to_integer(Text) of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L710">710</td>
<td class="hits">9</td>
<td class="source"><code>            Int -&gt; float(Int)</code></td>
</tr>
<tr>
<td class="line" id="L711">711</td>
<td class="hits"></td>
<td class="source"><code>        catch error:badarg -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L712">712</td>
<td class="hits"></td>
<td class="source"><code>            %% It is something like "4e75" that must be turned into "4.0e75"</code></td>
</tr>
<tr class="hit">
<td class="line" id="L713">713</td>
<td class="hits">1</td>
<td class="source"><code>            binary_to_float(binary:replace(Text, &lt;&lt;"e"&gt;&gt;, &lt;&lt;".0e"&gt;&gt;))</code></td>
</tr>
<tr>
<td class="line" id="L714">714</td>
<td class="hits"></td>
<td class="source"><code>        end</code></td>
</tr>
<tr>
<td class="line" id="L715">715</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L716">716</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L717">717</td>
<td class="hits"></td>
<td class="source"><code>%% -- binary protocol --</code></td>
</tr>
<tr>
<td class="line" id="L718">718</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L719">719</td>
<td class="hits"></td>
<td class="source"><code>%% @doc If NumColumns is non-zero, fetches this number of column definitions</code></td>
</tr>
<tr>
<td class="line" id="L720">720</td>
<td class="hits"></td>
<td class="source"><code>%% and an EOF packet. Used by prepare/3.</code></td>
</tr>
<tr>
<td class="line" id="L721">721</td>
<td class="hits"></td>
<td class="source"><code>fetch_column_definitions_if_any(0, _SockModule, _Socket, SeqNum) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L722">722</td>
<td class="hits">103</td>
<td class="source"><code>    {[], SeqNum};</code></td>
</tr>
<tr>
<td class="line" id="L723">723</td>
<td class="hits"></td>
<td class="source"><code>fetch_column_definitions_if_any(N, SockModule, Socket, SeqNum) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L724">724</td>
<td class="hits">119</td>
<td class="source"><code>    {ok, Defs, SeqNum1} = fetch_column_definitions(SockModule, Socket, SeqNum,</code></td>
</tr>
<tr>
<td class="line" id="L725">725</td>
<td class="hits"></td>
<td class="source"><code>                                                   N, []),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L726">726</td>
<td class="hits">119</td>
<td class="source"><code>    {ok, ?eof_pattern, SeqNum2} = recv_packet(SockModule, Socket, SeqNum1),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L727">727</td>
<td class="hits">119</td>
<td class="source"><code>    {Defs, SeqNum2}.</code></td>
</tr>
<tr>
<td class="line" id="L728">728</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L729">729</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Decodes a packet representing a row in a binary result set.</code></td>
</tr>
<tr>
<td class="line" id="L730">730</td>
<td class="hits"></td>
<td class="source"><code>%% It consists of a 0 byte, then a null bitmap, then the values.</code></td>
</tr>
<tr>
<td class="line" id="L731">731</td>
<td class="hits"></td>
<td class="source"><code>%% Returns a list of length NumColumns with terms of appropriate types for each</code></td>
</tr>
<tr>
<td class="line" id="L732">732</td>
<td class="hits"></td>
<td class="source"><code>%% MySQL type in ColumnTypes.</code></td>
</tr>
<tr>
<td class="line" id="L733">733</td>
<td class="hits"></td>
<td class="source"><code>-spec decode_binary_row(NumColumns :: integer(),</code></td>
</tr>
<tr>
<td class="line" id="L734">734</td>
<td class="hits"></td>
<td class="source"><code>                        ColumnDefs :: [#col{}],</code></td>
</tr>
<tr>
<td class="line" id="L735">735</td>
<td class="hits"></td>
<td class="source"><code>                        Data :: binary()) -&gt; [term()].</code></td>
</tr>
<tr>
<td class="line" id="L736">736</td>
<td class="hits"></td>
<td class="source"><code>decode_binary_row(NumColumns, ColumnDefs, &lt;&lt;0, Data/binary&gt;&gt;) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L737">737</td>
<td class="hits">126</td>
<td class="source"><code>    {NullBitMap, Rest} = null_bitmap_decode(NumColumns, Data, 2),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L738">738</td>
<td class="hits">126</td>
<td class="source"><code>    decode_binary_row_acc(ColumnDefs, NullBitMap, Rest, []).</code></td>
</tr>
<tr>
<td class="line" id="L739">739</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L740">740</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Accumulating helper for decode_binary_row/3.</code></td>
</tr>
<tr>
<td class="line" id="L741">741</td>
<td class="hits"></td>
<td class="source"><code>decode_binary_row_acc([_|ColDefs], &lt;&lt;1:1, NullBitMap/bitstring&gt;&gt;, Data, Acc) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L742">742</td>
<td class="hits"></td>
<td class="source"><code>    %% NULL</code></td>
</tr>
<tr class="hit">
<td class="line" id="L743">743</td>
<td class="hits">1</td>
<td class="source"><code>    decode_binary_row_acc(ColDefs, NullBitMap, Data, [null | Acc]);</code></td>
</tr>
<tr>
<td class="line" id="L744">744</td>
<td class="hits"></td>
<td class="source"><code>decode_binary_row_acc([ColDef | ColDefs], &lt;&lt;0:1, NullBitMap/bitstring&gt;&gt;, Data,</code></td>
</tr>
<tr>
<td class="line" id="L745">745</td>
<td class="hits"></td>
<td class="source"><code>                      Acc) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L746">746</td>
<td class="hits"></td>
<td class="source"><code>    %% Not NULL</code></td>
</tr>
<tr class="hit">
<td class="line" id="L747">747</td>
<td class="hits">147</td>
<td class="source"><code>    {Term, Rest} = decode_binary(ColDef, Data),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L748">748</td>
<td class="hits">147</td>
<td class="source"><code>    decode_binary_row_acc(ColDefs, NullBitMap, Rest, [Term | Acc]);</code></td>
</tr>
<tr>
<td class="line" id="L749">749</td>
<td class="hits"></td>
<td class="source"><code>decode_binary_row_acc([], _, &lt;&lt;&gt;&gt;, Acc) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L750">750</td>
<td class="hits">126</td>
<td class="source"><code>    lists:reverse(Acc).</code></td>
</tr>
<tr>
<td class="line" id="L751">751</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L752">752</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Decodes a null bitmap as stored by MySQL and returns it in a strait</code></td>
</tr>
<tr>
<td class="line" id="L753">753</td>
<td class="hits"></td>
<td class="source"><code>%% bitstring counting bits from left to right in a tuple with remaining data.</code></td>
</tr>
<tr>
<td class="line" id="L754">754</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L755">755</td>
<td class="hits"></td>
<td class="source"><code>%% In the MySQL null bitmap the bits are stored counting bytes from the left and</code></td>
</tr>
<tr>
<td class="line" id="L756">756</td>
<td class="hits"></td>
<td class="source"><code>%% bits within each byte from the right. (Sort of little endian.)</code></td>
</tr>
<tr>
<td class="line" id="L757">757</td>
<td class="hits"></td>
<td class="source"><code>-spec null_bitmap_decode(NumColumns :: integer(), Data :: binary(),</code></td>
</tr>
<tr>
<td class="line" id="L758">758</td>
<td class="hits"></td>
<td class="source"><code>                         BitOffset :: integer()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L759">759</td>
<td class="hits"></td>
<td class="source"><code>    {NullBitstring :: bitstring(), Rest :: binary()}.</code></td>
</tr>
<tr>
<td class="line" id="L760">760</td>
<td class="hits"></td>
<td class="source"><code>null_bitmap_decode(NumColumns, Data, BitOffset) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L761">761</td>
<td class="hits"></td>
<td class="source"><code>    %% Binary shift right by 3 is equivallent to integer division by 8.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L762">762</td>
<td class="hits">127</td>
<td class="source"><code>    BitMapLength = (NumColumns + BitOffset + 7) bsr 3,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L763">763</td>
<td class="hits">127</td>
<td class="source"><code>    &lt;&lt;NullBitstring0:BitMapLength/binary, Rest/binary&gt;&gt; = Data,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L764">764</td>
<td class="hits">127</td>
<td class="source"><code>    &lt;&lt;_:BitOffset, NullBitstring:NumColumns/bitstring, _/bitstring&gt;&gt; =</code></td>
</tr>
<tr class="hit">
<td class="line" id="L765">765</td>
<td class="hits">129</td>
<td class="source"><code>        &lt;&lt; &lt;&lt;(reverse_byte(B))/binary&gt;&gt; || &lt;&lt;B:1/binary&gt;&gt; &lt;= NullBitstring0 &gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L766">766</td>
<td class="hits">127</td>
<td class="source"><code>    {NullBitstring, Rest}.</code></td>
</tr>
<tr>
<td class="line" id="L767">767</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L768">768</td>
<td class="hits"></td>
<td class="source"><code>%% @doc The reverse of null_bitmap_decode/3. The number of columns is taken to</code></td>
</tr>
<tr>
<td class="line" id="L769">769</td>
<td class="hits"></td>
<td class="source"><code>%% be the number of bits in NullBitstring. Returns the MySQL null bitmap as a</code></td>
</tr>
<tr>
<td class="line" id="L770">770</td>
<td class="hits"></td>
<td class="source"><code>%% binary (i.e. full bytes). BitOffset is the number of unused bits that should</code></td>
</tr>
<tr>
<td class="line" id="L771">771</td>
<td class="hits"></td>
<td class="source"><code>%% be inserted before the other bits.</code></td>
</tr>
<tr>
<td class="line" id="L772">772</td>
<td class="hits"></td>
<td class="source"><code>-spec null_bitmap_encode(bitstring(), integer()) -&gt; binary().</code></td>
</tr>
<tr>
<td class="line" id="L773">773</td>
<td class="hits"></td>
<td class="source"><code>null_bitmap_encode(NullBitstring, BitOffset) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L774">774</td>
<td class="hits">83</td>
<td class="source"><code>    PayloadLength = bit_size(NullBitstring) + BitOffset,</code></td>
</tr>
<tr>
<td class="line" id="L775">775</td>
<td class="hits"></td>
<td class="source"><code>    %% Round up to a multiple of 8.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L776">776</td>
<td class="hits">83</td>
<td class="source"><code>    BitMapLength = (PayloadLength + 7) band bnot 7,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L777">777</td>
<td class="hits">83</td>
<td class="source"><code>    PadBitsLength = BitMapLength - PayloadLength,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L778">778</td>
<td class="hits">83</td>
<td class="source"><code>    PaddedBitstring = &lt;&lt;0:BitOffset, NullBitstring/bitstring, 0:PadBitsLength&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L779">779</td>
<td class="hits">83</td>
<td class="source"><code>    &lt;&lt; &lt;&lt;(reverse_byte(B))/binary&gt;&gt; || &lt;&lt;B:1/binary&gt;&gt; &lt;= PaddedBitstring &gt;&gt;.</code></td>
</tr>
<tr>
<td class="line" id="L780">780</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L781">781</td>
<td class="hits"></td>
<td class="source"><code>%% Reverses the bits in a byte.</code></td>
</tr>
<tr>
<td class="line" id="L782">782</td>
<td class="hits"></td>
<td class="source"><code>reverse_byte(&lt;&lt;A:1, B:1, C:1, D:1, E:1, F:1, G:1, H:1&gt;&gt;) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L783">783</td>
<td class="hits">214</td>
<td class="source"><code>    &lt;&lt;H:1, G:1, F:1, E:1, D:1, C:1, B:1, A:1&gt;&gt;.</code></td>
</tr>
<tr>
<td class="line" id="L784">784</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L785">785</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Used for executing prepared statements. The bit offset whould be 0 in</code></td>
</tr>
<tr>
<td class="line" id="L786">786</td>
<td class="hits"></td>
<td class="source"><code>%% this case.</code></td>
</tr>
<tr>
<td class="line" id="L787">787</td>
<td class="hits"></td>
<td class="source"><code>-spec build_null_bitmap([any()]) -&gt; binary().</code></td>
</tr>
<tr>
<td class="line" id="L788">788</td>
<td class="hits"></td>
<td class="source"><code>build_null_bitmap(Values) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L789">789</td>
<td class="hits">82</td>
<td class="source"><code>    Bits = &lt;&lt; &lt;&lt;(case V of null -&gt; 1; _ -&gt; 0 end):1&gt;&gt; || V &lt;- Values &gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L790">790</td>
<td class="hits">82</td>
<td class="source"><code>    null_bitmap_encode(Bits, 0).</code></td>
</tr>
<tr>
<td class="line" id="L791">791</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L792">792</td>
<td class="hits"></td>
<td class="source"><code>%% Decodes a value as received in the 'binary protocol' result set.</code></td>
</tr>
<tr>
<td class="line" id="L793">793</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L794">794</td>
<td class="hits"></td>
<td class="source"><code>%% The types are type constants for the binary protocol, such as</code></td>
</tr>
<tr>
<td class="line" id="L795">795</td>
<td class="hits"></td>
<td class="source"><code>%% ProtocolBinary::MYSQL_TYPE_STRING. In the guide "MySQL Internals" these are</code></td>
</tr>
<tr>
<td class="line" id="L796">796</td>
<td class="hits"></td>
<td class="source"><code>%% not listed, but we assume that are the same as for the text protocol.</code></td>
</tr>
<tr>
<td class="line" id="L797">797</td>
<td class="hits"></td>
<td class="source"><code>-spec decode_binary(ColDef :: #col{}, Data :: binary()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L798">798</td>
<td class="hits"></td>
<td class="source"><code>    {Term :: term(), Rest :: binary()}.</code></td>
</tr>
<tr>
<td class="line" id="L799">799</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = T}, Data)</code></td>
</tr>
<tr>
<td class="line" id="L800">800</td>
<td class="hits"></td>
<td class="source"><code>  when T == ?TYPE_STRING; T == ?TYPE_VARCHAR; T == ?TYPE_VAR_STRING;</code></td>
</tr>
<tr>
<td class="line" id="L801">801</td>
<td class="hits"></td>
<td class="source"><code>       T == ?TYPE_ENUM; T == ?TYPE_SET; T == ?TYPE_LONG_BLOB;</code></td>
</tr>
<tr>
<td class="line" id="L802">802</td>
<td class="hits"></td>
<td class="source"><code>       T == ?TYPE_MEDIUM_BLOB; T == ?TYPE_BLOB; T == ?TYPE_TINY_BLOB;</code></td>
</tr>
<tr>
<td class="line" id="L803">803</td>
<td class="hits"></td>
<td class="source"><code>       T == ?TYPE_GEOMETRY; T == ?TYPE_JSON -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L804">804</td>
<td class="hits"></td>
<td class="source"><code>    %% As of MySQL 5.6.21 we receive SET and ENUM values as STRING, i.e. we</code></td>
</tr>
<tr>
<td class="line" id="L805">805</td>
<td class="hits"></td>
<td class="source"><code>    %% cannot convert them to atom() or sets:set(), etc.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L806">806</td>
<td class="hits">17</td>
<td class="source"><code>    lenenc_str(Data);</code></td>
</tr>
<tr>
<td class="line" id="L807">807</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_LONGLONG, flags = F},</code></td>
</tr>
<tr>
<td class="line" id="L808">808</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:64/signed-little, Rest/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L809">809</td>
<td class="hits"></td>
<td class="source"><code>  when F band ?UNSIGNED_FLAG == 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L810">810</td>
<td class="hits">4</td>
<td class="source"><code>    {Value, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L811">811</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_LONGLONG, flags = F},</code></td>
</tr>
<tr>
<td class="line" id="L812">812</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:64/unsigned-little, Rest/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L813">813</td>
<td class="hits"></td>
<td class="source"><code>  when F band ?UNSIGNED_FLAG /= 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L814">814</td>
<td class="hits">2</td>
<td class="source"><code>    {Value, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L815">815</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = T, flags = F},</code></td>
</tr>
<tr>
<td class="line" id="L816">816</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:32/signed-little, Rest/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L817">817</td>
<td class="hits"></td>
<td class="source"><code>  when (T == ?TYPE_LONG orelse T == ?TYPE_INT24) andalso</code></td>
</tr>
<tr>
<td class="line" id="L818">818</td>
<td class="hits"></td>
<td class="source"><code>       F band ?UNSIGNED_FLAG == 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L819">819</td>
<td class="hits">28</td>
<td class="source"><code>    {Value, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L820">820</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = T, flags = F},</code></td>
</tr>
<tr>
<td class="line" id="L821">821</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:32/unsigned-little, Rest/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L822">822</td>
<td class="hits"></td>
<td class="source"><code>  when (T == ?TYPE_LONG orelse T == ?TYPE_INT24) andalso</code></td>
</tr>
<tr>
<td class="line" id="L823">823</td>
<td class="hits"></td>
<td class="source"><code>       F band ?UNSIGNED_FLAG /= 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L824">824</td>
<td class="hits">2</td>
<td class="source"><code>    {Value, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L825">825</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_SHORT, flags = F},</code></td>
</tr>
<tr>
<td class="line" id="L826">826</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:16/signed-little, Rest/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L827">827</td>
<td class="hits"></td>
<td class="source"><code>  when F band ?UNSIGNED_FLAG == 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L828">828</td>
<td class="hits">4</td>
<td class="source"><code>    {Value, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L829">829</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = T, flags = F},</code></td>
</tr>
<tr>
<td class="line" id="L830">830</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:16/unsigned-little, Rest/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L831">831</td>
<td class="hits"></td>
<td class="source"><code>  when (T == ?TYPE_SHORT orelse T == ?TYPE_YEAR) andalso</code></td>
</tr>
<tr>
<td class="line" id="L832">832</td>
<td class="hits"></td>
<td class="source"><code>       F band ?UNSIGNED_FLAG /= 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L833">833</td>
<td class="hits">3</td>
<td class="source"><code>    {Value, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L834">834</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_TINY, flags = F},</code></td>
</tr>
<tr>
<td class="line" id="L835">835</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:8/unsigned, Rest/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L836">836</td>
<td class="hits"></td>
<td class="source"><code>  when F band ?UNSIGNED_FLAG /= 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L837">837</td>
<td class="hits">3</td>
<td class="source"><code>    {Value, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L838">838</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_TINY, flags = F},</code></td>
</tr>
<tr>
<td class="line" id="L839">839</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:8/signed, Rest/binary&gt;&gt;)</code></td>
</tr>
<tr>
<td class="line" id="L840">840</td>
<td class="hits"></td>
<td class="source"><code>  when F band ?UNSIGNED_FLAG == 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L841">841</td>
<td class="hits">4</td>
<td class="source"><code>    {Value, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L842">842</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = T, decimals = S, length = L}, Data)</code></td>
</tr>
<tr>
<td class="line" id="L843">843</td>
<td class="hits"></td>
<td class="source"><code>  when T == ?TYPE_DECIMAL; T == ?TYPE_NEWDECIMAL -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L844">844</td>
<td class="hits"></td>
<td class="source"><code>    %% Length is the max number of symbols incl. dot and minus sign, e.g. the</code></td>
</tr>
<tr>
<td class="line" id="L845">845</td>
<td class="hits"></td>
<td class="source"><code>    %% number of digits plus 2.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L846">846</td>
<td class="hits">17</td>
<td class="source"><code>    {Binary, Rest} = lenenc_str(Data),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L847">847</td>
<td class="hits">17</td>
<td class="source"><code>    {decode_decimal(Binary, L - 2, S), Rest};</code></td>
</tr>
<tr>
<td class="line" id="L848">848</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_DOUBLE},</code></td>
</tr>
<tr>
<td class="line" id="L849">849</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:64/float-little, Rest/binary&gt;&gt;) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L850">850</td>
<td class="hits">1</td>
<td class="source"><code>    {Value, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L851">851</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_FLOAT}, &lt;&lt;0.0:32/float-little, Rest/binary&gt;&gt;) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L852">852</td>
<td class="hits"></td>
<td class="source"><code>    %% TYPE_FLOAT conversation fails on math:log10(0.0)</code></td>
</tr>
<tr class="hit">
<td class="line" id="L853">853</td>
<td class="hits">1</td>
<td class="source"><code>    {0.0, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L854">854</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_FLOAT},</code></td>
</tr>
<tr>
<td class="line" id="L855">855</td>
<td class="hits"></td>
<td class="source"><code>              &lt;&lt;Value:32/float-little, Rest/binary&gt;&gt;) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L856">856</td>
<td class="hits"></td>
<td class="source"><code>    %% There is a precision loss when storing and fetching a 32-bit float.</code></td>
</tr>
<tr>
<td class="line" id="L857">857</td>
<td class="hits"></td>
<td class="source"><code>    %% In the text protocol, it is obviously rounded. Storing 3.14 in a FLOAT</code></td>
</tr>
<tr>
<td class="line" id="L858">858</td>
<td class="hits"></td>
<td class="source"><code>    %% column and fetching it using the text protocol, we get "3.14" which we</code></td>
</tr>
<tr>
<td class="line" id="L859">859</td>
<td class="hits"></td>
<td class="source"><code>    %% parse to the Erlang double as close as possible to 3.14. Fetching the</code></td>
</tr>
<tr>
<td class="line" id="L860">860</td>
<td class="hits"></td>
<td class="source"><code>    %% same value as a binary 32-bit float, we get 3.140000104904175. To achieve</code></td>
</tr>
<tr>
<td class="line" id="L861">861</td>
<td class="hits"></td>
<td class="source"><code>    %% the same rounding after receiving it as a 32-bit float, we try to do the</code></td>
</tr>
<tr>
<td class="line" id="L862">862</td>
<td class="hits"></td>
<td class="source"><code>    %% same rounding here as MySQL does when sending it over the text protocol.</code></td>
</tr>
<tr>
<td class="line" id="L863">863</td>
<td class="hits"></td>
<td class="source"><code>    %%</code></td>
</tr>
<tr>
<td class="line" id="L864">864</td>
<td class="hits"></td>
<td class="source"><code>    %% This comment explains the idea:</code></td>
</tr>
<tr>
<td class="line" id="L865">865</td>
<td class="hits"></td>
<td class="source"><code>    %%</code></td>
</tr>
<tr>
<td class="line" id="L866">866</td>
<td class="hits"></td>
<td class="source"><code>    %%     Posted by Geoffrey Downs on March 10 2011 10:26am</code></td>
</tr>
<tr>
<td class="line" id="L867">867</td>
<td class="hits"></td>
<td class="source"><code>    %%</code></td>
</tr>
<tr>
<td class="line" id="L868">868</td>
<td class="hits"></td>
<td class="source"><code>    %%     Following up... I *think* this is correct for the default float</code></td>
</tr>
<tr>
<td class="line" id="L869">869</td>
<td class="hits"></td>
<td class="source"><code>    %%     columns in mysql:</code></td>
</tr>
<tr>
<td class="line" id="L870">870</td>
<td class="hits"></td>
<td class="source"><code>    %%</code></td>
</tr>
<tr>
<td class="line" id="L871">871</td>
<td class="hits"></td>
<td class="source"><code>    %%     var yourNumber = some floating point value</code></td>
</tr>
<tr>
<td class="line" id="L872">872</td>
<td class="hits"></td>
<td class="source"><code>    %%     max decimal precision = 10 ^ (-5 + flooring(yourNumber log 10))</code></td>
</tr>
<tr>
<td class="line" id="L873">873</td>
<td class="hits"></td>
<td class="source"><code>    %%     So:</code></td>
</tr>
<tr>
<td class="line" id="L874">874</td>
<td class="hits"></td>
<td class="source"><code>    %%     0 &lt; x &lt; 10 -&gt; max precision is 0.00001</code></td>
</tr>
<tr>
<td class="line" id="L875">875</td>
<td class="hits"></td>
<td class="source"><code>    %%     10 &lt;= x &lt; 100 -&gt; max precision is 0.0001</code></td>
</tr>
<tr>
<td class="line" id="L876">876</td>
<td class="hits"></td>
<td class="source"><code>    %%     100 &lt;= x &lt; 1000 -&gt; max precision is 0.001</code></td>
</tr>
<tr>
<td class="line" id="L877">877</td>
<td class="hits"></td>
<td class="source"><code>    %%     etc.</code></td>
</tr>
<tr>
<td class="line" id="L878">878</td>
<td class="hits"></td>
<td class="source"><code>    %%</code></td>
</tr>
<tr>
<td class="line" id="L879">879</td>
<td class="hits"></td>
<td class="source"><code>    %% (From http://dev.mysql.com/doc/refman/5.7/en/problems-with-float.html</code></td>
</tr>
<tr>
<td class="line" id="L880">880</td>
<td class="hits"></td>
<td class="source"><code>    %% fetched 10 Nov 2014)</code></td>
</tr>
<tr>
<td class="line" id="L881">881</td>
<td class="hits"></td>
<td class="source"><code>    %%</code></td>
</tr>
<tr>
<td class="line" id="L882">882</td>
<td class="hits"></td>
<td class="source"><code>    %% The above is almost correct, except for the example in the interval</code></td>
</tr>
<tr>
<td class="line" id="L883">883</td>
<td class="hits"></td>
<td class="source"><code>    %% 0 &lt; x &lt; 1. There are 6 significant digits also for these numbers.</code></td>
</tr>
<tr>
<td class="line" id="L884">884</td>
<td class="hits"></td>
<td class="source"><code>    %%</code></td>
</tr>
<tr>
<td class="line" id="L885">885</td>
<td class="hits"></td>
<td class="source"><code>    %% Now, instead of P = 0.00001 we want the inverse 100000.0 but if we</code></td>
</tr>
<tr>
<td class="line" id="L886">886</td>
<td class="hits"></td>
<td class="source"><code>    %% compute Factor = 1 / P we get a precision loss, so instead we do this:</code></td>
</tr>
<tr class="hit">
<td class="line" id="L887">887</td>
<td class="hits">27</td>
<td class="source"><code>    Factor = math:pow(10, flooring(6 - math:log10(abs(Value)))),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L888">888</td>
<td class="hits">27</td>
<td class="source"><code>    RoundedValue = round(Value * Factor) / Factor,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L889">889</td>
<td class="hits">27</td>
<td class="source"><code>    {RoundedValue, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L890">890</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_BIT, length = Length}, Data) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L891">891</td>
<td class="hits">4</td>
<td class="source"><code>    {Binary, Rest} = lenenc_str(Data),</code></td>
</tr>
<tr>
<td class="line" id="L892">892</td>
<td class="hits"></td>
<td class="source"><code>    %% Convert to &lt;&lt;_:Length/bitstring&gt;&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L893">893</td>
<td class="hits">4</td>
<td class="source"><code>    {decode_bitstring(Binary, Length), Rest};</code></td>
</tr>
<tr>
<td class="line" id="L894">894</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_DATE}, Data) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L895">895</td>
<td class="hits"></td>
<td class="source"><code>    %% Coded in the same way as DATETIME and TIMESTAMP below, but returned in</code></td>
</tr>
<tr>
<td class="line" id="L896">896</td>
<td class="hits"></td>
<td class="source"><code>    %% a simple triple.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L897">897</td>
<td class="hits">5</td>
<td class="source"><code>    case lenenc_int(Data) of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L898">898</td>
<td class="hits">2</td>
<td class="source"><code>        {0, Rest} -&gt; {{0, 0, 0}, Rest};</code></td>
</tr>
<tr class="hit">
<td class="line" id="L899">899</td>
<td class="hits">3</td>
<td class="source"><code>        {4, &lt;&lt;Y:16/little, M, D, Rest/binary&gt;&gt;} -&gt; {{Y, M, D}, Rest}</code></td>
</tr>
<tr>
<td class="line" id="L900">900</td>
<td class="hits"></td>
<td class="source"><code>    end;</code></td>
</tr>
<tr>
<td class="line" id="L901">901</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = T}, Data)</code></td>
</tr>
<tr>
<td class="line" id="L902">902</td>
<td class="hits"></td>
<td class="source"><code>  when T == ?TYPE_DATETIME; T == ?TYPE_TIMESTAMP -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L903">903</td>
<td class="hits"></td>
<td class="source"><code>    %% length (1) -- number of bytes following (valid values: 0, 4, 7, 11)</code></td>
</tr>
<tr class="hit">
<td class="line" id="L904">904</td>
<td class="hits">9</td>
<td class="source"><code>    case lenenc_int(Data) of</code></td>
</tr>
<tr>
<td class="line" id="L905">905</td>
<td class="hits"></td>
<td class="source"><code>        {0, Rest} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L906">906</td>
<td class="hits">2</td>
<td class="source"><code>            {{{0, 0, 0}, {0, 0, 0}}, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L907">907</td>
<td class="hits"></td>
<td class="source"><code>        {4, &lt;&lt;Y:16/little, M, D, Rest/binary&gt;&gt;} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L908">908</td>
<td class="hits">2</td>
<td class="source"><code>            {{{Y, M, D}, {0, 0, 0}}, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L909">909</td>
<td class="hits"></td>
<td class="source"><code>        {7, &lt;&lt;Y:16/little, M, D, H, Mi, S, Rest/binary&gt;&gt;} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L910">910</td>
<td class="hits">3</td>
<td class="source"><code>            {{{Y, M, D}, {H, Mi, S}}, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L911">911</td>
<td class="hits"></td>
<td class="source"><code>        {11, &lt;&lt;Y:16/little, M, D, H, Mi, S, Micro:32/little, Rest/binary&gt;&gt;} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L912">912</td>
<td class="hits">2</td>
<td class="source"><code>            {{{Y, M, D}, {H, Mi, S + 0.000001 * Micro}}, Rest}</code></td>
</tr>
<tr>
<td class="line" id="L913">913</td>
<td class="hits"></td>
<td class="source"><code>    end;</code></td>
</tr>
<tr>
<td class="line" id="L914">914</td>
<td class="hits"></td>
<td class="source"><code>decode_binary(#col{type = ?TYPE_TIME}, Data) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L915">915</td>
<td class="hits"></td>
<td class="source"><code>    %% length (1) -- number of bytes following (valid values: 0, 8, 12)</code></td>
</tr>
<tr>
<td class="line" id="L916">916</td>
<td class="hits"></td>
<td class="source"><code>    %% is_negative (1) -- (1 if minus, 0 for plus)</code></td>
</tr>
<tr>
<td class="line" id="L917">917</td>
<td class="hits"></td>
<td class="source"><code>    %% days (4) -- days</code></td>
</tr>
<tr>
<td class="line" id="L918">918</td>
<td class="hits"></td>
<td class="source"><code>    %% hours (1) -- hours</code></td>
</tr>
<tr>
<td class="line" id="L919">919</td>
<td class="hits"></td>
<td class="source"><code>    %% minutes (1) -- minutes</code></td>
</tr>
<tr>
<td class="line" id="L920">920</td>
<td class="hits"></td>
<td class="source"><code>    %% seconds (1) -- seconds</code></td>
</tr>
<tr>
<td class="line" id="L921">921</td>
<td class="hits"></td>
<td class="source"><code>    %% micro_seconds (4) -- micro-seconds</code></td>
</tr>
<tr class="hit">
<td class="line" id="L922">922</td>
<td class="hits">21</td>
<td class="source"><code>    case lenenc_int(Data) of</code></td>
</tr>
<tr>
<td class="line" id="L923">923</td>
<td class="hits"></td>
<td class="source"><code>        {0, Rest} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L924">924</td>
<td class="hits">2</td>
<td class="source"><code>            {{0, {0, 0, 0}}, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L925">925</td>
<td class="hits"></td>
<td class="source"><code>        {8, &lt;&lt;0, D:32/little, H, M, S, Rest/binary&gt;&gt;} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L926">926</td>
<td class="hits">5</td>
<td class="source"><code>            {{D, {H, M, S}}, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L927">927</td>
<td class="hits"></td>
<td class="source"><code>        {12, &lt;&lt;0, D:32/little, H, M, S, Micro:32/little, Rest/binary&gt;&gt;} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L928">928</td>
<td class="hits">2</td>
<td class="source"><code>            {{D, {H, M, S + 0.000001 * Micro}}, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L929">929</td>
<td class="hits"></td>
<td class="source"><code>        {8, &lt;&lt;1, D:32/little, H, M, S, Rest/binary&gt;&gt;} -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L930">930</td>
<td class="hits"></td>
<td class="source"><code>            %% Negative time. Example: '-00:00:01' --&gt; {-1,{23,59,59}}</code></td>
</tr>
<tr class="hit">
<td class="line" id="L931">931</td>
<td class="hits">10</td>
<td class="source"><code>            Seconds = ((D * 24 + H) * 60 + M) * 60 + S,</code></td>
</tr>
<tr>
<td class="line" id="L932">932</td>
<td class="hits"></td>
<td class="source"><code>            %Seconds = D * 86400 + calendar:time_to_seconds({H, M, S}),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L933">933</td>
<td class="hits">10</td>
<td class="source"><code>            {calendar:seconds_to_daystime(-Seconds), Rest};</code></td>
</tr>
<tr>
<td class="line" id="L934">934</td>
<td class="hits"></td>
<td class="source"><code>        {12, &lt;&lt;1, D:32/little, H, M, S, Micro:32/little, Rest/binary&gt;&gt;}</code></td>
</tr>
<tr>
<td class="line" id="L935">935</td>
<td class="hits"></td>
<td class="source"><code>          when Micro &gt; 0 -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L936">936</td>
<td class="hits"></td>
<td class="source"><code>            %% Negate and convert to seconds, excl fractions</code></td>
</tr>
<tr class="hit">
<td class="line" id="L937">937</td>
<td class="hits">2</td>
<td class="source"><code>            Seconds = -(((D * 24 + H) * 60 + M) * 60 + S),</code></td>
</tr>
<tr>
<td class="line" id="L938">938</td>
<td class="hits"></td>
<td class="source"><code>            %Seconds = -D * 86400 - calendar:time_to_seconds({H, M, S}),</code></td>
</tr>
<tr>
<td class="line" id="L939">939</td>
<td class="hits"></td>
<td class="source"><code>            %% Subtract 1 second for the fractions</code></td>
</tr>
<tr class="hit">
<td class="line" id="L940">940</td>
<td class="hits">2</td>
<td class="source"><code>            {Days, {Hours, Minutes, Sec}} =</code></td>
</tr>
<tr>
<td class="line" id="L941">941</td>
<td class="hits"></td>
<td class="source"><code>                calendar:seconds_to_daystime(Seconds - 1),</code></td>
</tr>
<tr>
<td class="line" id="L942">942</td>
<td class="hits"></td>
<td class="source"><code>            %% Adding the fractions to Sec again makes it a float</code></td>
</tr>
<tr class="hit">
<td class="line" id="L943">943</td>
<td class="hits">2</td>
<td class="source"><code>            {{Days, {Hours, Minutes, Sec + 1 - 0.000001 * Micro}}, Rest}</code></td>
</tr>
<tr>
<td class="line" id="L944">944</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L945">945</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L946">946</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Like trunc/1 but towards negative infinity instead of towards zero.</code></td>
</tr>
<tr>
<td class="line" id="L947">947</td>
<td class="hits"></td>
<td class="source"><code>flooring(Value) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L948">948</td>
<td class="hits">27</td>
<td class="source"><code>    Trunc = trunc(Value),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L949">949</td>
<td class="hits">27</td>
<td class="source"><code>    if</code></td>
</tr>
<tr class="hit">
<td class="line" id="L950">950</td>
<td class="hits">21</td>
<td class="source"><code>        Trunc =&lt; Value -&gt; Trunc;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L951">951</td>
<td class="hits">6</td>
<td class="source"><code>        Trunc &gt; Value -&gt; Trunc - 1 %% for negative values</code></td>
</tr>
<tr>
<td class="line" id="L952">952</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L953">953</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L954">954</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Encodes a term reprenting av value as a binary for use in the binary</code></td>
</tr>
<tr>
<td class="line" id="L955">955</td>
<td class="hits"></td>
<td class="source"><code>%% protocol. As this is used to encode parameters for prepared statements, the</code></td>
</tr>
<tr>
<td class="line" id="L956">956</td>
<td class="hits"></td>
<td class="source"><code>%% encoding is in its required form, namely `&lt;&lt;Type:8, Sign:8, Value/binary&gt;&gt;'.</code></td>
</tr>
<tr>
<td class="line" id="L957">957</td>
<td class="hits"></td>
<td class="source"><code>-spec encode_param(term()) -&gt; {TypeAndSign :: binary(), Data :: binary()}.</code></td>
</tr>
<tr>
<td class="line" id="L958">958</td>
<td class="hits"></td>
<td class="source"><code>encode_param(null) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L959">959</td>
<td class="hits">1</td>
<td class="source"><code>    {&lt;&lt;?TYPE_NULL, 0&gt;&gt;, &lt;&lt;&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L960">960</td>
<td class="hits"></td>
<td class="source"><code>encode_param(Value) when is_binary(Value) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L961">961</td>
<td class="hits">10</td>
<td class="source"><code>    EncLength = lenenc_int_encode(byte_size(Value)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L962">962</td>
<td class="hits">10</td>
<td class="source"><code>    {&lt;&lt;?TYPE_VAR_STRING, 0&gt;&gt;, &lt;&lt;EncLength/binary, Value/binary&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L963">963</td>
<td class="hits"></td>
<td class="source"><code>encode_param(Value) when is_list(Value) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L964">964</td>
<td class="hits">1</td>
<td class="source"><code>    encode_param(unicode:characters_to_binary(Value));</code></td>
</tr>
<tr>
<td class="line" id="L965">965</td>
<td class="hits"></td>
<td class="source"><code>encode_param(Value) when is_integer(Value), Value &gt;= 0 -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L966">966</td>
<td class="hits"></td>
<td class="source"><code>    %% We send positive integers with the 'unsigned' flag set.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L967">967</td>
<td class="hits">31</td>
<td class="source"><code>    if</code></td>
</tr>
<tr>
<td class="line" id="L968">968</td>
<td class="hits"></td>
<td class="source"><code>        Value =&lt; 16#ff -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L969">969</td>
<td class="hits">22</td>
<td class="source"><code>            {&lt;&lt;?TYPE_TINY, 16#80&gt;&gt;, &lt;&lt;Value:8&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L970">970</td>
<td class="hits"></td>
<td class="source"><code>        Value =&lt; 16#ffff -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L971">971</td>
<td class="hits">3</td>
<td class="source"><code>            {&lt;&lt;?TYPE_SHORT, 16#80&gt;&gt;, &lt;&lt;Value:16/little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L972">972</td>
<td class="hits"></td>
<td class="source"><code>        Value =&lt; 16#ffffffff -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L973">973</td>
<td class="hits">3</td>
<td class="source"><code>            {&lt;&lt;?TYPE_LONG, 16#80&gt;&gt;, &lt;&lt;Value:32/little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L974">974</td>
<td class="hits"></td>
<td class="source"><code>        Value =&lt; 16#ffffffffffffffff -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L975">975</td>
<td class="hits">2</td>
<td class="source"><code>            {&lt;&lt;?TYPE_LONGLONG, 16#80&gt;&gt;, &lt;&lt;Value:64/little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L976">976</td>
<td class="hits"></td>
<td class="source"><code>        true -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L977">977</td>
<td class="hits"></td>
<td class="source"><code>            %% If larger than a 64-bit int we send it as a string. MySQL does</code></td>
</tr>
<tr>
<td class="line" id="L978">978</td>
<td class="hits"></td>
<td class="source"><code>            %% silently cast strings in aithmetic expressions. Also, DECIMALs</code></td>
</tr>
<tr>
<td class="line" id="L979">979</td>
<td class="hits"></td>
<td class="source"><code>            %% are always sent as strings.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L980">980</td>
<td class="hits">1</td>
<td class="source"><code>            encode_param(integer_to_binary(Value))</code></td>
</tr>
<tr>
<td class="line" id="L981">981</td>
<td class="hits"></td>
<td class="source"><code>    end;</code></td>
</tr>
<tr>
<td class="line" id="L982">982</td>
<td class="hits"></td>
<td class="source"><code>encode_param(Value) when is_integer(Value), Value &lt; 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L983">983</td>
<td class="hits">7</td>
<td class="source"><code>    if</code></td>
</tr>
<tr>
<td class="line" id="L984">984</td>
<td class="hits"></td>
<td class="source"><code>        Value &gt;= -16#80 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L985">985</td>
<td class="hits">2</td>
<td class="source"><code>            {&lt;&lt;?TYPE_TINY, 0&gt;&gt;, &lt;&lt;Value:8&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L986">986</td>
<td class="hits"></td>
<td class="source"><code>        Value &gt;= -16#8000 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L987">987</td>
<td class="hits">1</td>
<td class="source"><code>            {&lt;&lt;?TYPE_SHORT, 0&gt;&gt;, &lt;&lt;Value:16/little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L988">988</td>
<td class="hits"></td>
<td class="source"><code>        Value &gt;= -16#80000000 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L989">989</td>
<td class="hits">2</td>
<td class="source"><code>            {&lt;&lt;?TYPE_LONG, 0&gt;&gt;, &lt;&lt;Value:32/little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L990">990</td>
<td class="hits"></td>
<td class="source"><code>        Value &gt;= -16#8000000000000000 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L991">991</td>
<td class="hits">1</td>
<td class="source"><code>            {&lt;&lt;?TYPE_LONGLONG, 0&gt;&gt;, &lt;&lt;Value:64/little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L992">992</td>
<td class="hits"></td>
<td class="source"><code>        true -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L993">993</td>
<td class="hits">1</td>
<td class="source"><code>            encode_param(integer_to_binary(Value))</code></td>
</tr>
<tr>
<td class="line" id="L994">994</td>
<td class="hits"></td>
<td class="source"><code>    end;</code></td>
</tr>
<tr>
<td class="line" id="L995">995</td>
<td class="hits"></td>
<td class="source"><code>encode_param(Value) when is_float(Value) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L996">996</td>
<td class="hits">28</td>
<td class="source"><code>    {&lt;&lt;?TYPE_DOUBLE, 0&gt;&gt;, &lt;&lt;Value:64/float-little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L997">997</td>
<td class="hits"></td>
<td class="source"><code>encode_param(Value) when is_bitstring(Value) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L998">998</td>
<td class="hits">2</td>
<td class="source"><code>    Binary = encode_bitstring(Value),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L999">999</td>
<td class="hits">2</td>
<td class="source"><code>    EncLength = lenenc_int_encode(byte_size(Binary)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1000">1000</td>
<td class="hits">2</td>
<td class="source"><code>    {&lt;&lt;?TYPE_VAR_STRING, 0&gt;&gt;, &lt;&lt;EncLength/binary, Binary/binary&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L1001">1001</td>
<td class="hits"></td>
<td class="source"><code>encode_param({Y, M, D}) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1002">1002</td>
<td class="hits"></td>
<td class="source"><code>    %% calendar:date()</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1003">1003</td>
<td class="hits">3</td>
<td class="source"><code>    {&lt;&lt;?TYPE_DATE, 0&gt;&gt;, &lt;&lt;4, Y:16/little, M, D&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L1004">1004</td>
<td class="hits"></td>
<td class="source"><code>encode_param({{Y, M, D}, {0, 0, 0}}) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1005">1005</td>
<td class="hits"></td>
<td class="source"><code>    %% Datetime at midnight</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1006">1006</td>
<td class="hits">2</td>
<td class="source"><code>    {&lt;&lt;?TYPE_DATETIME, 0&gt;&gt;, &lt;&lt;4, Y:16/little, M, D&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L1007">1007</td>
<td class="hits"></td>
<td class="source"><code>encode_param({{Y, M, D}, {H, Mi, S}}) when is_integer(S) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1008">1008</td>
<td class="hits"></td>
<td class="source"><code>    %% calendar:datetime()</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1009">1009</td>
<td class="hits">2</td>
<td class="source"><code>    {&lt;&lt;?TYPE_DATETIME, 0&gt;&gt;, &lt;&lt;7, Y:16/little, M, D, H, Mi, S&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L1010">1010</td>
<td class="hits"></td>
<td class="source"><code>encode_param({{Y, M, D}, {H, Mi, S}}) when is_float(S) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1011">1011</td>
<td class="hits"></td>
<td class="source"><code>    %% calendar:datetime() with a float for seconds. This way it looks very</code></td>
</tr>
<tr>
<td class="line" id="L1012">1012</td>
<td class="hits"></td>
<td class="source"><code>    %% similar to a datetime. Microseconds in MySQL timestamps are possible but</code></td>
</tr>
<tr>
<td class="line" id="L1013">1013</td>
<td class="hits"></td>
<td class="source"><code>    %% not very common.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1014">1014</td>
<td class="hits">1</td>
<td class="source"><code>    Sec = trunc(S),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1015">1015</td>
<td class="hits">1</td>
<td class="source"><code>    Micro = round(1000000 * (S - Sec)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1016">1016</td>
<td class="hits">1</td>
<td class="source"><code>    {&lt;&lt;?TYPE_DATETIME, 0&gt;&gt;, &lt;&lt;11, Y:16/little, M, D, H, Mi, Sec,</code></td>
</tr>
<tr>
<td class="line" id="L1017">1017</td>
<td class="hits"></td>
<td class="source"><code>                              Micro:32/little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L1018">1018</td>
<td class="hits"></td>
<td class="source"><code>encode_param({D, {H, M, S}}) when is_integer(S), D &gt;= 0 -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1019">1019</td>
<td class="hits"></td>
<td class="source"><code>    %% calendar:seconds_to_daystime()</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1020">1020</td>
<td class="hits">4</td>
<td class="source"><code>    {&lt;&lt;?TYPE_TIME, 0&gt;&gt;, &lt;&lt;8, 0, D:32/little, H, M, S&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L1021">1021</td>
<td class="hits"></td>
<td class="source"><code>encode_param({D, {H, M, S}}) when is_integer(S), D &lt; 0 -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1022">1022</td>
<td class="hits"></td>
<td class="source"><code>    %% Convert to seconds, negate and convert back to daystime form.</code></td>
</tr>
<tr>
<td class="line" id="L1023">1023</td>
<td class="hits"></td>
<td class="source"><code>    %% Then set the minus flag.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1024">1024</td>
<td class="hits">6</td>
<td class="source"><code>    Seconds = ((D * 24 + H) * 60 + M) * 60 + S,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1025">1025</td>
<td class="hits">6</td>
<td class="source"><code>    {D1, {H1, M1, S1}} = calendar:seconds_to_daystime(-Seconds),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1026">1026</td>
<td class="hits">6</td>
<td class="source"><code>    {&lt;&lt;?TYPE_TIME, 0&gt;&gt;, &lt;&lt;8, 1, D1:32/little, H1, M1, S1&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L1027">1027</td>
<td class="hits"></td>
<td class="source"><code>encode_param({D, {H, M, S}}) when is_float(S), D &gt;= 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1028">1028</td>
<td class="hits">1</td>
<td class="source"><code>    S1 = trunc(S),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1029">1029</td>
<td class="hits">1</td>
<td class="source"><code>    Micro = round(1000000 * (S - S1)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1030">1030</td>
<td class="hits">1</td>
<td class="source"><code>    {&lt;&lt;?TYPE_TIME, 0&gt;&gt;, &lt;&lt;12, 0, D:32/little, H, M, S1, Micro:32/little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L1031">1031</td>
<td class="hits"></td>
<td class="source"><code>encode_param({D, {H, M, S}}) when is_float(S), S &gt; 0.0, D &lt; 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1032">1032</td>
<td class="hits">1</td>
<td class="source"><code>    IntS = trunc(S),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1033">1033</td>
<td class="hits">1</td>
<td class="source"><code>    Micro = round(1000000 * (1 - S + IntS)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1034">1034</td>
<td class="hits">1</td>
<td class="source"><code>    Seconds = (D * 24 + H) * 3600 + M * 60 + IntS + 1,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1035">1035</td>
<td class="hits">1</td>
<td class="source"><code>    {D1, {M1, H1, S1}} = calendar:seconds_to_daystime(-Seconds),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1036">1036</td>
<td class="hits">1</td>
<td class="source"><code>    {&lt;&lt;?TYPE_TIME, 0&gt;&gt;, &lt;&lt;12, 1, D1:32/little, H1, M1, S1, Micro:32/little&gt;&gt;};</code></td>
</tr>
<tr>
<td class="line" id="L1037">1037</td>
<td class="hits"></td>
<td class="source"><code>encode_param({D, {H, M, 0.0}}) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1038">1038</td>
<td class="hits">1</td>
<td class="source"><code>    encode_param({D, {H, M, 0}}).</code></td>
</tr>
<tr>
<td class="line" id="L1039">1039</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1040">1040</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Checks if the given Parameters can be encoded for use in the</code></td>
</tr>
<tr>
<td class="line" id="L1041">1041</td>
<td class="hits"></td>
<td class="source"><code>%% binary protocol. Returns `true' if all of the parameters can be</code></td>
</tr>
<tr>
<td class="line" id="L1042">1042</td>
<td class="hits"></td>
<td class="source"><code>%% encoded, `false' if any of them cannot be encoded.</code></td>
</tr>
<tr>
<td class="line" id="L1043">1043</td>
<td class="hits"></td>
<td class="source"><code>-spec valid_params([term()]) -&gt; boolean().</code></td>
</tr>
<tr>
<td class="line" id="L1044">1044</td>
<td class="hits"></td>
<td class="source"><code>valid_params(Values) when is_list(Values) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1045">1045</td>
<td class="hits">204</td>
<td class="source"><code>    lists:all(fun is_valid_param/1, Values).</code></td>
</tr>
<tr>
<td class="line" id="L1046">1046</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1047">1047</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Checks if the given parameter can be encoded for use in the</code></td>
</tr>
<tr>
<td class="line" id="L1048">1048</td>
<td class="hits"></td>
<td class="source"><code>%% binary protocol.</code></td>
</tr>
<tr>
<td class="line" id="L1049">1049</td>
<td class="hits"></td>
<td class="source"><code>-spec is_valid_param(term()) -&gt; boolean().</code></td>
</tr>
<tr>
<td class="line" id="L1050">1050</td>
<td class="hits"></td>
<td class="source"><code>is_valid_param(null) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1051">1051</td>
<td class="hits">4</td>
<td class="source"><code>    true;</code></td>
</tr>
<tr>
<td class="line" id="L1052">1052</td>
<td class="hits"></td>
<td class="source"><code>is_valid_param(Value) when is_list(Value) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1053">1053</td>
<td class="hits">12</td>
<td class="source"><code>    try</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1054">1054</td>
<td class="hits">12</td>
<td class="source"><code>        unicode:characters_to_binary(Value)</code></td>
</tr>
<tr>
<td class="line" id="L1055">1055</td>
<td class="hits"></td>
<td class="source"><code>    of</code></td>
</tr>
<tr>
<td class="line" id="L1056">1056</td>
<td class="hits"></td>
<td class="source"><code>        Value1 when is_binary(Value1) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1057">1057</td>
<td class="hits">10</td>
<td class="source"><code>            true;</code></td>
</tr>
<tr>
<td class="line" id="L1058">1058</td>
<td class="hits"></td>
<td class="source"><code>        _ErrorOrIncomplete -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1059">1059</td>
<td class="hits">1</td>
<td class="source"><code>            false</code></td>
</tr>
<tr>
<td class="line" id="L1060">1060</td>
<td class="hits"></td>
<td class="source"><code>    catch</code></td>
</tr>
<tr>
<td class="line" id="L1061">1061</td>
<td class="hits"></td>
<td class="source"><code>        error:badarg -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1062">1062</td>
<td class="hits">1</td>
<td class="source"><code>            false</code></td>
</tr>
<tr>
<td class="line" id="L1063">1063</td>
<td class="hits"></td>
<td class="source"><code>    end;</code></td>
</tr>
<tr>
<td class="line" id="L1064">1064</td>
<td class="hits"></td>
<td class="source"><code>is_valid_param(Value) when is_number(Value) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1065">1065</td>
<td class="hits">73</td>
<td class="source"><code>    true;</code></td>
</tr>
<tr>
<td class="line" id="L1066">1066</td>
<td class="hits"></td>
<td class="source"><code>is_valid_param(Value) when is_bitstring(Value) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1067">1067</td>
<td class="hits">18</td>
<td class="source"><code>    true;</code></td>
</tr>
<tr>
<td class="line" id="L1068">1068</td>
<td class="hits"></td>
<td class="source"><code>is_valid_param({Y, M, D}) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1069">1069</td>
<td class="hits">9</td>
<td class="source"><code>    is_integer(Y) andalso is_integer(M) andalso is_integer(D);</code></td>
</tr>
<tr>
<td class="line" id="L1070">1070</td>
<td class="hits"></td>
<td class="source"><code>is_valid_param({{Y, M, D}, {H, Mi, S}}) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1071">1071</td>
<td class="hits">17</td>
<td class="source"><code>    is_integer(Y) andalso is_integer(M) andalso is_integer(D) andalso</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1072">1072</td>
<td class="hits">14</td>
<td class="source"><code>    is_integer(H) andalso is_integer(Mi) andalso is_number(S);</code></td>
</tr>
<tr>
<td class="line" id="L1073">1073</td>
<td class="hits"></td>
<td class="source"><code>is_valid_param({D, {H, M, S}}) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1074">1074</td>
<td class="hits">22</td>
<td class="source"><code>    is_integer(D) andalso</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1075">1075</td>
<td class="hits">21</td>
<td class="source"><code>    is_integer(H) andalso is_integer(M) andalso is_number(S);</code></td>
</tr>
<tr>
<td class="line" id="L1076">1076</td>
<td class="hits"></td>
<td class="source"><code>is_valid_param(_) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1077">1077</td>
<td class="hits">9</td>
<td class="source"><code>    false.</code></td>
</tr>
<tr>
<td class="line" id="L1078">1078</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1079">1079</td>
<td class="hits"></td>
<td class="source"><code>%% -- Value representation in both the text and binary protocols --</code></td>
</tr>
<tr>
<td class="line" id="L1080">1080</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1081">1081</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Convert to `&lt;&lt;_:Length/bitstring&gt;&gt;'</code></td>
</tr>
<tr>
<td class="line" id="L1082">1082</td>
<td class="hits"></td>
<td class="source"><code>decode_bitstring(Binary, Length) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1083">1083</td>
<td class="hits">9</td>
<td class="source"><code>    PaddingLength = bit_size(Binary) - Length,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1084">1084</td>
<td class="hits">9</td>
<td class="source"><code>    &lt;&lt;_:PaddingLength/bitstring, Bitstring:Length/bitstring&gt;&gt; = Binary,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1085">1085</td>
<td class="hits">9</td>
<td class="source"><code>    Bitstring.</code></td>
</tr>
<tr>
<td class="line" id="L1086">1086</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1087">1087</td>
<td class="hits"></td>
<td class="source"><code>encode_bitstring(Bitstring) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1088">1088</td>
<td class="hits">2</td>
<td class="source"><code>    Size = bit_size(Bitstring),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1089">1089</td>
<td class="hits">2</td>
<td class="source"><code>    PaddingSize = byte_size(Bitstring) * 8 - Size,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1090">1090</td>
<td class="hits">2</td>
<td class="source"><code>    &lt;&lt;0:PaddingSize, Bitstring:Size/bitstring&gt;&gt;.</code></td>
</tr>
<tr>
<td class="line" id="L1091">1091</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1092">1092</td>
<td class="hits"></td>
<td class="source"><code>decode_decimal(Bin, _P, 0) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1093">1093</td>
<td class="hits">8</td>
<td class="source"><code>    binary_to_integer(Bin);</code></td>
</tr>
<tr>
<td class="line" id="L1094">1094</td>
<td class="hits"></td>
<td class="source"><code>decode_decimal(Bin, P, S) when P =&lt; 15, S &gt; 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1095">1095</td>
<td class="hits">16</td>
<td class="source"><code>    binary_to_float(Bin);</code></td>
</tr>
<tr>
<td class="line" id="L1096">1096</td>
<td class="hits"></td>
<td class="source"><code>decode_decimal(Bin, P, S) when P &gt;= 16, S &gt; 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1097">1097</td>
<td class="hits">12</td>
<td class="source"><code>    Bin.</code></td>
</tr>
<tr>
<td class="line" id="L1098">1098</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1099">1099</td>
<td class="hits"></td>
<td class="source"><code>%% -- Protocol basics: packets --</code></td>
</tr>
<tr>
<td class="line" id="L1100">1100</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1101">1101</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Wraps Data in packet headers, sends it by calling SockModule:send/2 with</code></td>
</tr>
<tr>
<td class="line" id="L1102">1102</td>
<td class="hits"></td>
<td class="source"><code>%% Socket and returns {ok, SeqNum1} where SeqNum1 is the next sequence number.</code></td>
</tr>
<tr>
<td class="line" id="L1103">1103</td>
<td class="hits"></td>
<td class="source"><code>-spec send_packet(module(), term(), Data :: binary(), SeqNum :: integer()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1104">1104</td>
<td class="hits"></td>
<td class="source"><code>    {ok, NextSeqNum :: integer()}.</code></td>
</tr>
<tr>
<td class="line" id="L1105">1105</td>
<td class="hits"></td>
<td class="source"><code>send_packet(SockModule, Socket, Data, SeqNum) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1106">1106</td>
<td class="hits">975</td>
<td class="source"><code>    {WithHeaders, SeqNum1} = add_packet_headers(Data, SeqNum),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1107">1107</td>
<td class="hits">975</td>
<td class="source"><code>    ok = SockModule:send(Socket, WithHeaders),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1108">1108</td>
<td class="hits">974</td>
<td class="source"><code>    {ok, SeqNum1}.</code></td>
</tr>
<tr>
<td class="line" id="L1109">1109</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1110">1110</td>
<td class="hits"></td>
<td class="source"><code>%% @see recv_packet/4</code></td>
</tr>
<tr>
<td class="line" id="L1111">1111</td>
<td class="hits"></td>
<td class="source"><code>recv_packet(SockModule, Socket, SeqNum) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1112">1112</td>
<td class="hits">1638</td>
<td class="source"><code>    recv_packet(SockModule, Socket, infinity, SeqNum).</code></td>
</tr>
<tr>
<td class="line" id="L1113">1113</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1114">1114</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Receives data by calling SockModule:recv/2 and removes the packet</code></td>
</tr>
<tr>
<td class="line" id="L1115">1115</td>
<td class="hits"></td>
<td class="source"><code>%% headers. Returns the packet contents and the next packet sequence number.</code></td>
</tr>
<tr>
<td class="line" id="L1116">1116</td>
<td class="hits"></td>
<td class="source"><code>-spec recv_packet(module(), term(), timeout(), integer() | any) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1117">1117</td>
<td class="hits"></td>
<td class="source"><code>    {ok, Data :: binary(), NextSeqNum :: integer()} | {error, term()}.</code></td>
</tr>
<tr>
<td class="line" id="L1118">1118</td>
<td class="hits"></td>
<td class="source"><code>recv_packet(SockModule, Socket, Timeout, SeqNum) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1119">1119</td>
<td class="hits">2347</td>
<td class="source"><code>    recv_packet(SockModule, Socket, Timeout, SeqNum, &lt;&lt;&gt;&gt;).</code></td>
</tr>
<tr>
<td class="line" id="L1120">1120</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1121">1121</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Accumulating helper for recv_packet/4</code></td>
</tr>
<tr>
<td class="line" id="L1122">1122</td>
<td class="hits"></td>
<td class="source"><code>-spec recv_packet(module(), term(), timeout(), integer() | any, binary()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1123">1123</td>
<td class="hits"></td>
<td class="source"><code>    {ok, Data :: binary(), NextSeqNum :: integer()} | {error, term()}.</code></td>
</tr>
<tr>
<td class="line" id="L1124">1124</td>
<td class="hits"></td>
<td class="source"><code>recv_packet(SockModule, Socket, Timeout, ExpectSeqNum, Acc) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1125">1125</td>
<td class="hits">2347</td>
<td class="source"><code>    case SockModule:recv(Socket, 4, Timeout) of</code></td>
</tr>
<tr>
<td class="line" id="L1126">1126</td>
<td class="hits"></td>
<td class="source"><code>        {ok, Header} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1127">1127</td>
<td class="hits">2317</td>
<td class="source"><code>            {Size, SeqNum, More} = parse_packet_header(Header),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1128">1128</td>
<td class="hits">2317</td>
<td class="source"><code>            true = SeqNum == ExpectSeqNum orelse ExpectSeqNum == any,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1129">1129</td>
<td class="hits">2317</td>
<td class="source"><code>            {ok, Body} = SockModule:recv(Socket, Size),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1130">1130</td>
<td class="hits">2317</td>
<td class="source"><code>            Acc1 = &lt;&lt;Acc/binary, Body/binary&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1131">1131</td>
<td class="hits">2317</td>
<td class="source"><code>            NextSeqNum = (SeqNum + 1) band 16#ff,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1132">1132</td>
<td class="hits">2317</td>
<td class="source"><code>            case More of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1133">1133</td>
<td class="hits">2317</td>
<td class="source"><code>                false -&gt; {ok, Acc1, NextSeqNum};</code></td>
</tr>
<tr class="miss">
<td class="line" id="L1134">1134</td>
<td class="hits">0</td>
<td class="source"><code>                true  -&gt; recv_packet(SockModule, Socket, Timeout, NextSeqNum,</code></td>
</tr>
<tr>
<td class="line" id="L1135">1135</td>
<td class="hits"></td>
<td class="source"><code>                                     Acc1)</code></td>
</tr>
<tr>
<td class="line" id="L1136">1136</td>
<td class="hits"></td>
<td class="source"><code>            end;</code></td>
</tr>
<tr>
<td class="line" id="L1137">1137</td>
<td class="hits"></td>
<td class="source"><code>        {error, Reason} -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1138">1138</td>
<td class="hits">30</td>
<td class="source"><code>            {error, Reason}</code></td>
</tr>
<tr>
<td class="line" id="L1139">1139</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L1140">1140</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1141">1141</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Parses a packet header (32 bits) and returns a tuple.</code></td>
</tr>
<tr>
<td class="line" id="L1142">1142</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L1143">1143</td>
<td class="hits"></td>
<td class="source"><code>%% The client should first read a header and parse it. Then read PacketLength</code></td>
</tr>
<tr>
<td class="line" id="L1144">1144</td>
<td class="hits"></td>
<td class="source"><code>%% bytes. If there are more packets, read another header and read a new packet</code></td>
</tr>
<tr>
<td class="line" id="L1145">1145</td>
<td class="hits"></td>
<td class="source"><code>%% length of payload until there are no more packets. The seq num should</code></td>
</tr>
<tr>
<td class="line" id="L1146">1146</td>
<td class="hits"></td>
<td class="source"><code>%% increment from 0 and may wrap around at 255 back to 0.</code></td>
</tr>
<tr>
<td class="line" id="L1147">1147</td>
<td class="hits"></td>
<td class="source"><code>%%</code></td>
</tr>
<tr>
<td class="line" id="L1148">1148</td>
<td class="hits"></td>
<td class="source"><code>%% When all packets are read and the payload of all packets are concatenated, it</code></td>
</tr>
<tr>
<td class="line" id="L1149">1149</td>
<td class="hits"></td>
<td class="source"><code>%% can be parsed using parse_response/1, etc. depending on what type of response</code></td>
</tr>
<tr>
<td class="line" id="L1150">1150</td>
<td class="hits"></td>
<td class="source"><code>%% is expected.</code></td>
</tr>
<tr>
<td class="line" id="L1151">1151</td>
<td class="hits"></td>
<td class="source"><code>-spec parse_packet_header(PackerHeader :: binary()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1152">1152</td>
<td class="hits"></td>
<td class="source"><code>    {PacketLength :: integer(),</code></td>
</tr>
<tr>
<td class="line" id="L1153">1153</td>
<td class="hits"></td>
<td class="source"><code>     SeqNum :: integer(),</code></td>
</tr>
<tr>
<td class="line" id="L1154">1154</td>
<td class="hits"></td>
<td class="source"><code>     MorePacketsExist :: boolean()}.</code></td>
</tr>
<tr>
<td class="line" id="L1155">1155</td>
<td class="hits"></td>
<td class="source"><code>parse_packet_header(&lt;&lt;PacketLength:24/little-integer, SeqNum:8/integer&gt;&gt;) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1156">1156</td>
<td class="hits">2318</td>
<td class="source"><code>    {PacketLength, SeqNum, PacketLength == 16#ffffff}.</code></td>
</tr>
<tr>
<td class="line" id="L1157">1157</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1158">1158</td>
<td class="hits"></td>
<td class="source"><code>%% @doc Splits a packet body into chunks and wraps them in headers. The</code></td>
</tr>
<tr>
<td class="line" id="L1159">1159</td>
<td class="hits"></td>
<td class="source"><code>%% resulting list is ready to be sent to the socket. The result is built as a</code></td>
</tr>
<tr>
<td class="line" id="L1160">1160</td>
<td class="hits"></td>
<td class="source"><code>%% list to avoid copying large binaries.</code></td>
</tr>
<tr>
<td class="line" id="L1161">1161</td>
<td class="hits"></td>
<td class="source"><code>-spec add_packet_headers(Data :: binary(), SeqNum :: integer()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1162">1162</td>
<td class="hits"></td>
<td class="source"><code>    {PacketsWithHeaders :: iodata(), NextSeqNum :: integer()}.</code></td>
</tr>
<tr>
<td class="line" id="L1163">1163</td>
<td class="hits"></td>
<td class="source"><code>add_packet_headers(&lt;&lt;Payload:16#ffffff/binary, Rest/binary&gt;&gt;, SeqNum) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1164">1164</td>
<td class="hits">4</td>
<td class="source"><code>    SeqNum1 = (SeqNum + 1) band 16#ff,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1165">1165</td>
<td class="hits">4</td>
<td class="source"><code>    {Packets, NextSeqNum} = add_packet_headers(Rest, SeqNum1),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1166">1166</td>
<td class="hits">4</td>
<td class="source"><code>    Header = &lt;&lt;16#ffffff:24/little, SeqNum:8&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1167">1167</td>
<td class="hits">4</td>
<td class="source"><code>    {[Header, Payload | Packets], NextSeqNum};</code></td>
</tr>
<tr>
<td class="line" id="L1168">1168</td>
<td class="hits"></td>
<td class="source"><code>add_packet_headers(Bin, SeqNum) when byte_size(Bin) &lt; 16#ffffff -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1169">1169</td>
<td class="hits">979</td>
<td class="source"><code>    NextSeqNum = (SeqNum + 1) band 16#ff,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1170">1170</td>
<td class="hits">979</td>
<td class="source"><code>    Header = &lt;&lt;(byte_size(Bin)):24/little, SeqNum:8&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1171">1171</td>
<td class="hits">979</td>
<td class="source"><code>    {[Header, Bin], NextSeqNum}.</code></td>
</tr>
<tr>
<td class="line" id="L1172">1172</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1173">1173</td>
<td class="hits"></td>
<td class="source"><code>-spec parse_ok_packet(binary()) -&gt; #ok{}.</code></td>
</tr>
<tr>
<td class="line" id="L1174">1174</td>
<td class="hits"></td>
<td class="source"><code>parse_ok_packet(&lt;&lt;?OK:8, Rest/binary&gt;&gt;) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1175">1175</td>
<td class="hits">462</td>
<td class="source"><code>    {AffectedRows, Rest1} = lenenc_int(Rest),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1176">1176</td>
<td class="hits">462</td>
<td class="source"><code>    {InsertId, Rest2} = lenenc_int(Rest1),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1177">1177</td>
<td class="hits">462</td>
<td class="source"><code>    &lt;&lt;StatusFlags:16/little, WarningCount:16/little, Msg/binary&gt;&gt; = Rest2,</code></td>
</tr>
<tr>
<td class="line" id="L1178">1178</td>
<td class="hits"></td>
<td class="source"><code>    %% We have CLIENT_PROTOCOL_41 but not CLIENT_SESSION_TRACK enabled. The</code></td>
</tr>
<tr>
<td class="line" id="L1179">1179</td>
<td class="hits"></td>
<td class="source"><code>    %% protocol is conditional. This is from the protocol documentation:</code></td>
</tr>
<tr>
<td class="line" id="L1180">1180</td>
<td class="hits"></td>
<td class="source"><code>    %%</code></td>
</tr>
<tr>
<td class="line" id="L1181">1181</td>
<td class="hits"></td>
<td class="source"><code>    %% if capabilities &amp; CLIENT_PROTOCOL_41 {</code></td>
</tr>
<tr>
<td class="line" id="L1182">1182</td>
<td class="hits"></td>
<td class="source"><code>    %%   int&lt;2&gt; status_flags</code></td>
</tr>
<tr>
<td class="line" id="L1183">1183</td>
<td class="hits"></td>
<td class="source"><code>    %%   int&lt;2&gt; warning_count</code></td>
</tr>
<tr>
<td class="line" id="L1184">1184</td>
<td class="hits"></td>
<td class="source"><code>    %% } elseif capabilities &amp; CLIENT_TRANSACTIONS {</code></td>
</tr>
<tr>
<td class="line" id="L1185">1185</td>
<td class="hits"></td>
<td class="source"><code>    %%   int&lt;2&gt; status_flags</code></td>
</tr>
<tr>
<td class="line" id="L1186">1186</td>
<td class="hits"></td>
<td class="source"><code>    %% }</code></td>
</tr>
<tr>
<td class="line" id="L1187">1187</td>
<td class="hits"></td>
<td class="source"><code>    %% if capabilities &amp; CLIENT_SESSION_TRACK {</code></td>
</tr>
<tr>
<td class="line" id="L1188">1188</td>
<td class="hits"></td>
<td class="source"><code>    %%   string&lt;lenenc&gt; info</code></td>
</tr>
<tr>
<td class="line" id="L1189">1189</td>
<td class="hits"></td>
<td class="source"><code>    %%   if status_flags &amp; SERVER_SESSION_STATE_CHANGED {</code></td>
</tr>
<tr>
<td class="line" id="L1190">1190</td>
<td class="hits"></td>
<td class="source"><code>    %%     string&lt;lenenc&gt; session_state_changes</code></td>
</tr>
<tr>
<td class="line" id="L1191">1191</td>
<td class="hits"></td>
<td class="source"><code>    %%   }</code></td>
</tr>
<tr>
<td class="line" id="L1192">1192</td>
<td class="hits"></td>
<td class="source"><code>    %% } else {</code></td>
</tr>
<tr>
<td class="line" id="L1193">1193</td>
<td class="hits"></td>
<td class="source"><code>    %%   string&lt;EOF&gt; info</code></td>
</tr>
<tr>
<td class="line" id="L1194">1194</td>
<td class="hits"></td>
<td class="source"><code>    %% }</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1195">1195</td>
<td class="hits">462</td>
<td class="source"><code>    #ok{affected_rows = AffectedRows,</code></td>
</tr>
<tr>
<td class="line" id="L1196">1196</td>
<td class="hits"></td>
<td class="source"><code>        insert_id = InsertId,</code></td>
</tr>
<tr>
<td class="line" id="L1197">1197</td>
<td class="hits"></td>
<td class="source"><code>        status = StatusFlags,</code></td>
</tr>
<tr>
<td class="line" id="L1198">1198</td>
<td class="hits"></td>
<td class="source"><code>        warning_count = WarningCount,</code></td>
</tr>
<tr>
<td class="line" id="L1199">1199</td>
<td class="hits"></td>
<td class="source"><code>        msg = Msg}.</code></td>
</tr>
<tr>
<td class="line" id="L1200">1200</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1201">1201</td>
<td class="hits"></td>
<td class="source"><code>-spec parse_error_packet(binary()) -&gt; #error{}.</code></td>
</tr>
<tr>
<td class="line" id="L1202">1202</td>
<td class="hits"></td>
<td class="source"><code>parse_error_packet(&lt;&lt;?ERROR:8, ErrNo:16/little, "#", SQLState:5/binary-unit:8,</code></td>
</tr>
<tr>
<td class="line" id="L1203">1203</td>
<td class="hits"></td>
<td class="source"><code>                     Msg/binary&gt;&gt;) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1204">1204</td>
<td class="hits"></td>
<td class="source"><code>    %% Error, 4.1 protocol.</code></td>
</tr>
<tr>
<td class="line" id="L1205">1205</td>
<td class="hits"></td>
<td class="source"><code>    %% (Older protocol: &lt;&lt;?ERROR:8, ErrNo:16/little, Msg/binary&gt;&gt;)</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1206">1206</td>
<td class="hits">17</td>
<td class="source"><code>    #error{code = ErrNo, state = SQLState, msg = Msg}.</code></td>
</tr>
<tr>
<td class="line" id="L1207">1207</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1208">1208</td>
<td class="hits"></td>
<td class="source"><code>-spec parse_eof_packet(binary()) -&gt; #eof{}.</code></td>
</tr>
<tr>
<td class="line" id="L1209">1209</td>
<td class="hits"></td>
<td class="source"><code>parse_eof_packet(&lt;&lt;?EOF:8, NumWarnings:16/little, StatusFlags:16/little&gt;&gt;) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1210">1210</td>
<td class="hits"></td>
<td class="source"><code>    %% EOF packet, 4.1 protocol.</code></td>
</tr>
<tr>
<td class="line" id="L1211">1211</td>
<td class="hits"></td>
<td class="source"><code>    %% (Older protocol: &lt;&lt;?EOF:8&gt;&gt;)</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1212">1212</td>
<td class="hits">277</td>
<td class="source"><code>    #eof{status = StatusFlags, warning_count = NumWarnings}.</code></td>
</tr>
<tr>
<td class="line" id="L1213">1213</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1214">1214</td>
<td class="hits"></td>
<td class="source"><code>-spec parse_auth_method_switch(binary()) -&gt; #auth_method_switch{}.</code></td>
</tr>
<tr>
<td class="line" id="L1215">1215</td>
<td class="hits"></td>
<td class="source"><code>parse_auth_method_switch(AMSData) -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L1216">1216</td>
<td class="hits">0</td>
<td class="source"><code>    {AuthPluginName, AuthPluginData} = get_null_terminated_binary(AMSData),</code></td>
</tr>
<tr class="miss">
<td class="line" id="L1217">1217</td>
<td class="hits">0</td>
<td class="source"><code>    #auth_method_switch{</code></td>
</tr>
<tr>
<td class="line" id="L1218">1218</td>
<td class="hits"></td>
<td class="source"><code>       auth_plugin_name = AuthPluginName,</code></td>
</tr>
<tr>
<td class="line" id="L1219">1219</td>
<td class="hits"></td>
<td class="source"><code>       auth_plugin_data = AuthPluginData</code></td>
</tr>
<tr>
<td class="line" id="L1220">1220</td>
<td class="hits"></td>
<td class="source"><code>      }.</code></td>
</tr>
<tr>
<td class="line" id="L1221">1221</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1222">1222</td>
<td class="hits"></td>
<td class="source"><code>-spec get_null_terminated_binary(binary()) -&gt; {Binary :: binary(),</code></td>
</tr>
<tr>
<td class="line" id="L1223">1223</td>
<td class="hits"></td>
<td class="source"><code>                                               Rest :: binary()}.</code></td>
</tr>
<tr>
<td class="line" id="L1224">1224</td>
<td class="hits"></td>
<td class="source"><code>get_null_terminated_binary(In) -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L1225">1225</td>
<td class="hits">0</td>
<td class="source"><code>    get_null_terminated_binary(In, &lt;&lt;&gt;&gt;).</code></td>
</tr>
<tr>
<td class="line" id="L1226">1226</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1227">1227</td>
<td class="hits"></td>
<td class="source"><code>get_null_terminated_binary(&lt;&lt;0, Rest/binary&gt;&gt;, Acc) -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L1228">1228</td>
<td class="hits">0</td>
<td class="source"><code>    {Acc, Rest};</code></td>
</tr>
<tr>
<td class="line" id="L1229">1229</td>
<td class="hits"></td>
<td class="source"><code>get_null_terminated_binary(&lt;&lt;Ch, Rest/binary&gt;&gt;, Acc) -&gt;</code></td>
</tr>
<tr class="miss">
<td class="line" id="L1230">1230</td>
<td class="hits">0</td>
<td class="source"><code>    get_null_terminated_binary(Rest, &lt;&lt;Acc/binary, Ch&gt;&gt;).</code></td>
</tr>
<tr>
<td class="line" id="L1231">1231</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1232">1232</td>
<td class="hits"></td>
<td class="source"><code>-spec hash_password(Password :: iodata(), Salt :: binary()) -&gt; Hash :: binary().</code></td>
</tr>
<tr>
<td class="line" id="L1233">1233</td>
<td class="hits"></td>
<td class="source"><code>hash_password(Password, Salt) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1234">1234</td>
<td class="hits"></td>
<td class="source"><code>    %% From the "MySQL Internals" manual:</code></td>
</tr>
<tr>
<td class="line" id="L1235">1235</td>
<td class="hits"></td>
<td class="source"><code>    %% SHA1( password ) XOR SHA1( "20-bytes random data from server" &lt;concat&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1236">1236</td>
<td class="hits"></td>
<td class="source"><code>    %%                            SHA1( SHA1( password ) ) )</code></td>
</tr>
<tr>
<td class="line" id="L1237">1237</td>
<td class="hits"></td>
<td class="source"><code>    %% ----</code></td>
</tr>
<tr>
<td class="line" id="L1238">1238</td>
<td class="hits"></td>
<td class="source"><code>    %% Make sure the salt is exactly 20 bytes.</code></td>
</tr>
<tr>
<td class="line" id="L1239">1239</td>
<td class="hits"></td>
<td class="source"><code>    %%</code></td>
</tr>
<tr>
<td class="line" id="L1240">1240</td>
<td class="hits"></td>
<td class="source"><code>    %% The auth data is obviously nul-terminated. For the "native" auth</code></td>
</tr>
<tr>
<td class="line" id="L1241">1241</td>
<td class="hits"></td>
<td class="source"><code>    %% method, it should be a 20 byte salt, so let's trim it in this case.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1242">1242</td>
<td class="hits">48</td>
<td class="source"><code>    PasswordBin = case erlang:is_binary(Password) of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1243">1243</td>
<td class="hits">2</td>
<td class="source"><code>        true -&gt; Password;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1244">1244</td>
<td class="hits">46</td>
<td class="source"><code>        false -&gt; erlang:iolist_to_binary(Password)</code></td>
</tr>
<tr>
<td class="line" id="L1245">1245</td>
<td class="hits"></td>
<td class="source"><code>    end,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1246">1246</td>
<td class="hits">48</td>
<td class="source"><code>    case PasswordBin =:= &lt;&lt;&gt;&gt; of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1247">1247</td>
<td class="hits">1</td>
<td class="source"><code>        true -&gt; &lt;&lt;&gt;&gt;;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1248">1248</td>
<td class="hits">47</td>
<td class="source"><code>        false -&gt; hash_non_empty_password(Password, Salt)</code></td>
</tr>
<tr>
<td class="line" id="L1249">1249</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L1250">1250</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1251">1251</td>
<td class="hits"></td>
<td class="source"><code>-spec hash_non_empty_password(Password :: iodata(), Salt :: binary()) -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1252">1252</td>
<td class="hits"></td>
<td class="source"><code>    Hash :: binary().</code></td>
</tr>
<tr>
<td class="line" id="L1253">1253</td>
<td class="hits"></td>
<td class="source"><code>hash_non_empty_password(Password, Salt) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1254">1254</td>
<td class="hits">47</td>
<td class="source"><code>    Salt1 = case Salt of</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1255">1255</td>
<td class="hits">46</td>
<td class="source"><code>        &lt;&lt;SaltNoNul:20/binary-unit:8, 0&gt;&gt; -&gt; SaltNoNul;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1256">1256</td>
<td class="hits">1</td>
<td class="source"><code>        _ when size(Salt) == 20           -&gt; Salt</code></td>
</tr>
<tr>
<td class="line" id="L1257">1257</td>
<td class="hits"></td>
<td class="source"><code>    end,</code></td>
</tr>
<tr>
<td class="line" id="L1258">1258</td>
<td class="hits"></td>
<td class="source"><code>    %% Hash as described above.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1259">1259</td>
<td class="hits">47</td>
<td class="source"><code>    &lt;&lt;Hash1Num:160&gt;&gt; = Hash1 = crypto:hash(sha, Password),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1260">1260</td>
<td class="hits">47</td>
<td class="source"><code>    Hash2 = crypto:hash(sha, Hash1),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1261">1261</td>
<td class="hits">47</td>
<td class="source"><code>    &lt;&lt;Hash3Num:160&gt;&gt; = crypto:hash(sha, &lt;&lt;Salt1/binary, Hash2/binary&gt;&gt;),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1262">1262</td>
<td class="hits">47</td>
<td class="source"><code>    &lt;&lt;(Hash1Num bxor Hash3Num):160&gt;&gt;.</code></td>
</tr>
<tr>
<td class="line" id="L1263">1263</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1264">1264</td>
<td class="hits"></td>
<td class="source"><code>%% --- Lowlevel: variable length integers and strings ---</code></td>
</tr>
<tr>
<td class="line" id="L1265">1265</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1266">1266</td>
<td class="hits"></td>
<td class="source"><code>%% lenenc_int/1 decodes length-encoded-integer values</code></td>
</tr>
<tr>
<td class="line" id="L1267">1267</td>
<td class="hits"></td>
<td class="source"><code>-spec lenenc_int(Input :: binary()) -&gt; {Value :: integer(), Rest :: binary()}.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1268">1268</td>
<td class="hits">3679</td>
<td class="source"><code>lenenc_int(&lt;&lt;Value:8, Rest/bits&gt;&gt;) when Value &lt; 251 -&gt; {Value, Rest};</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1269">1269</td>
<td class="hits">1</td>
<td class="source"><code>lenenc_int(&lt;&lt;16#fc:8, Value:16/little, Rest/binary&gt;&gt;) -&gt; {Value, Rest};</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1270">1270</td>
<td class="hits">1</td>
<td class="source"><code>lenenc_int(&lt;&lt;16#fd:8, Value:24/little, Rest/binary&gt;&gt;) -&gt; {Value, Rest};</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1271">1271</td>
<td class="hits">1</td>
<td class="source"><code>lenenc_int(&lt;&lt;16#fe:8, Value:64/little, Rest/binary&gt;&gt;) -&gt; {Value, Rest}.</code></td>
</tr>
<tr>
<td class="line" id="L1272">1272</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1273">1273</td>
<td class="hits"></td>
<td class="source"><code>%% Length-encoded-integer encode. Appends the encoded value to Acc.</code></td>
</tr>
<tr>
<td class="line" id="L1274">1274</td>
<td class="hits"></td>
<td class="source"><code>%% Values not representable in 64 bits are not accepted.</code></td>
</tr>
<tr>
<td class="line" id="L1275">1275</td>
<td class="hits"></td>
<td class="source"><code>-spec lenenc_int_encode(0..16#ffffffffffffffff) -&gt; binary().</code></td>
</tr>
<tr>
<td class="line" id="L1276">1276</td>
<td class="hits"></td>
<td class="source"><code>lenenc_int_encode(Value) when Value &gt;= 0 -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1277">1277</td>
<td class="hits">25</td>
<td class="source"><code>    if Value &lt; 251 -&gt; &lt;&lt;Value&gt;&gt;;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1278">1278</td>
<td class="hits">1</td>
<td class="source"><code>       Value =&lt; 16#ffff -&gt; &lt;&lt;16#fc, Value:16/little&gt;&gt;;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1279">1279</td>
<td class="hits">1</td>
<td class="source"><code>       Value =&lt; 16#ffffff -&gt; &lt;&lt;16#fd, Value:24/little&gt;&gt;;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1280">1280</td>
<td class="hits">1</td>
<td class="source"><code>       Value =&lt; 16#ffffffffffffffff -&gt; &lt;&lt;16#fe, Value:64/little&gt;&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1281">1281</td>
<td class="hits"></td>
<td class="source"><code>    end.</code></td>
</tr>
<tr>
<td class="line" id="L1282">1282</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1283">1283</td>
<td class="hits"></td>
<td class="source"><code>%% lenenc_str/1 decodes length-encoded-string values</code></td>
</tr>
<tr>
<td class="line" id="L1284">1284</td>
<td class="hits"></td>
<td class="source"><code>-spec lenenc_str(Input :: binary()) -&gt; {String :: binary(), Rest :: binary()}.</code></td>
</tr>
<tr>
<td class="line" id="L1285">1285</td>
<td class="hits"></td>
<td class="source"><code>lenenc_str(Bin) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1286">1286</td>
<td class="hits">2125</td>
<td class="source"><code>    {Length, Rest} = lenenc_int(Bin),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1287">1287</td>
<td class="hits">2125</td>
<td class="source"><code>    &lt;&lt;String:Length/binary, Rest1/binary&gt;&gt; = Rest,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1288">1288</td>
<td class="hits">2125</td>
<td class="source"><code>    {String, Rest1}.</code></td>
</tr>
<tr>
<td class="line" id="L1289">1289</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1290">1290</td>
<td class="hits"></td>
<td class="source"><code>%% Length-encoded-string encode. Prefixes the value with a</code></td>
</tr>
<tr>
<td class="line" id="L1291">1291</td>
<td class="hits"></td>
<td class="source"><code>%% length-encoded-integer denoting its size.</code></td>
</tr>
<tr>
<td class="line" id="L1292">1292</td>
<td class="hits"></td>
<td class="source"><code>-spec lenenc_str_encode(Input :: binary()) -&gt; binary().</code></td>
</tr>
<tr>
<td class="line" id="L1293">1293</td>
<td class="hits"></td>
<td class="source"><code>lenenc_str_encode(Bin) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1294">1294</td>
<td class="hits">9</td>
<td class="source"><code>    Length = byte_size(Bin),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1295">1295</td>
<td class="hits">9</td>
<td class="source"><code>    &lt;&lt;(lenenc_int_encode(Length))/binary, Bin:Length/binary&gt;&gt;.</code></td>
</tr>
<tr>
<td class="line" id="L1296">1296</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1297">1297</td>
<td class="hits"></td>
<td class="source"><code>%% nts/1 decodes a nul-terminated string</code></td>
</tr>
<tr>
<td class="line" id="L1298">1298</td>
<td class="hits"></td>
<td class="source"><code>-spec nulterm_str(Input :: binary()) -&gt; {String :: binary(), Rest :: binary()}.</code></td>
</tr>
<tr>
<td class="line" id="L1299">1299</td>
<td class="hits"></td>
<td class="source"><code>nulterm_str(Bin) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1300">1300</td>
<td class="hits">38</td>
<td class="source"><code>    [String, Rest] = binary:split(Bin, &lt;&lt;0&gt;&gt;),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1301">1301</td>
<td class="hits">38</td>
<td class="source"><code>    {String, Rest}.</code></td>
</tr>
<tr>
<td class="line" id="L1302">1302</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1303">1303</td>
<td class="hits"></td>
<td class="source"><code>-ifdef(TEST).</code></td>
</tr>
<tr>
<td class="line" id="L1304">1304</td>
<td class="hits"></td>
<td class="source"><code>-include_lib("eunit/include/eunit.hrl").</code></td>
</tr>
<tr>
<td class="line" id="L1305">1305</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1306">1306</td>
<td class="hits"></td>
<td class="source"><code>%% Testing some of the internal functions, mostly the cases we don't cover in</code></td>
</tr>
<tr>
<td class="line" id="L1307">1307</td>
<td class="hits"></td>
<td class="source"><code>%% other tests.</code></td>
</tr>
<tr>
<td class="line" id="L1308">1308</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1309">1309</td>
<td class="hits"></td>
<td class="source"><code>decode_text_test() -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1310">1310</td>
<td class="hits"></td>
<td class="source"><code>    %% Int types</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1311">1311</td>
<td class="hits">1</td>
<td class="source"><code>    lists:foreach(fun (T) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1312">1312</td>
<td class="hits">6</td>
<td class="source"><code>                      ?assertEqual(1, decode_text(#col{type = T}, &lt;&lt;"1"&gt;&gt;))</code></td>
</tr>
<tr>
<td class="line" id="L1313">1313</td>
<td class="hits"></td>
<td class="source"><code>                  end,</code></td>
</tr>
<tr>
<td class="line" id="L1314">1314</td>
<td class="hits"></td>
<td class="source"><code>                  [?TYPE_TINY, ?TYPE_SHORT, ?TYPE_LONG, ?TYPE_LONGLONG,</code></td>
</tr>
<tr>
<td class="line" id="L1315">1315</td>
<td class="hits"></td>
<td class="source"><code>                   ?TYPE_INT24, ?TYPE_YEAR]),</code></td>
</tr>
<tr>
<td class="line" id="L1316">1316</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1317">1317</td>
<td class="hits"></td>
<td class="source"><code>    %% BIT</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1318">1318</td>
<td class="hits">1</td>
<td class="source"><code>    &lt;&lt;217&gt;&gt; = decode_text(#col{type = ?TYPE_BIT, length = 8}, &lt;&lt;217&gt;&gt;),</code></td>
</tr>
<tr>
<td class="line" id="L1319">1319</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1320">1320</td>
<td class="hits"></td>
<td class="source"><code>    %% Floating point and decimal numbers</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1321">1321</td>
<td class="hits">1</td>
<td class="source"><code>    lists:foreach(fun (T) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1322">1322</td>
<td class="hits">2</td>
<td class="source"><code>                      ?assertEqual(3.0, decode_text(#col{type = T}, &lt;&lt;"3.0"&gt;&gt;))</code></td>
</tr>
<tr>
<td class="line" id="L1323">1323</td>
<td class="hits"></td>
<td class="source"><code>                  end,</code></td>
</tr>
<tr>
<td class="line" id="L1324">1324</td>
<td class="hits"></td>
<td class="source"><code>                  [?TYPE_FLOAT, ?TYPE_DOUBLE]),</code></td>
</tr>
<tr>
<td class="line" id="L1325">1325</td>
<td class="hits"></td>
<td class="source"><code>    %% Decimal types</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1326">1326</td>
<td class="hits">1</td>
<td class="source"><code>    lists:foreach(fun (T) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1327">1327</td>
<td class="hits">2</td>
<td class="source"><code>                      ColDef = #col{type = T, decimals = 1, length = 4},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1328">1328</td>
<td class="hits">2</td>
<td class="source"><code>                      ?assertMatch(3.0, decode_text(ColDef, &lt;&lt;"3.0"&gt;&gt;))</code></td>
</tr>
<tr>
<td class="line" id="L1329">1329</td>
<td class="hits"></td>
<td class="source"><code>                  end,</code></td>
</tr>
<tr>
<td class="line" id="L1330">1330</td>
<td class="hits"></td>
<td class="source"><code>                  [?TYPE_DECIMAL, ?TYPE_NEWDECIMAL]),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1331">1331</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(3.0,  decode_text(#col{type = ?TYPE_FLOAT}, &lt;&lt;"3"&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1332">1332</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(30.0, decode_text(#col{type = ?TYPE_FLOAT}, &lt;&lt;"3e1"&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1333">1333</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(3,    decode_text(#col{type = ?TYPE_LONG}, &lt;&lt;"3"&gt;&gt;)),</code></td>
</tr>
<tr>
<td class="line" id="L1334">1334</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1335">1335</td>
<td class="hits"></td>
<td class="source"><code>    %% Date and time</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1336">1336</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({2014, 11, 01},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1337">1337</td>
<td class="hits">1</td>
<td class="source"><code>                 decode_text(#col{type = ?TYPE_DATE}, &lt;&lt;"2014-11-01"&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1338">1338</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({0, {23, 59, 01}},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1339">1339</td>
<td class="hits">1</td>
<td class="source"><code>                 decode_text(#col{type = ?TYPE_TIME}, &lt;&lt;"23:59:01"&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1340">1340</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({{2014, 11, 01}, {23, 59, 01}},</code></td>
</tr>
<tr>
<td class="line" id="L1341">1341</td>
<td class="hits"></td>
<td class="source"><code>                 decode_text(#col{type = ?TYPE_DATETIME},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1342">1342</td>
<td class="hits">1</td>
<td class="source"><code>                             &lt;&lt;"2014-11-01 23:59:01"&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1343">1343</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({{2014, 11, 01}, {23, 59, 01}},</code></td>
</tr>
<tr>
<td class="line" id="L1344">1344</td>
<td class="hits"></td>
<td class="source"><code>                 decode_text(#col{type = ?TYPE_TIMESTAMP},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1345">1345</td>
<td class="hits">1</td>
<td class="source"><code>                             &lt;&lt;"2014-11-01 23:59:01"&gt;&gt;)),</code></td>
</tr>
<tr>
<td class="line" id="L1346">1346</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1347">1347</td>
<td class="hits"></td>
<td class="source"><code>    %% Strings and blobs</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1348">1348</td>
<td class="hits">1</td>
<td class="source"><code>    lists:foreach(fun (T) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1349">1349</td>
<td class="hits">9</td>
<td class="source"><code>                      ColDef = #col{type = T},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1350">1350</td>
<td class="hits">9</td>
<td class="source"><code>                      ?assertEqual(&lt;&lt;"x"&gt;&gt;, decode_text(ColDef, &lt;&lt;"x"&gt;&gt;))</code></td>
</tr>
<tr>
<td class="line" id="L1351">1351</td>
<td class="hits"></td>
<td class="source"><code>                  end,</code></td>
</tr>
<tr>
<td class="line" id="L1352">1352</td>
<td class="hits"></td>
<td class="source"><code>                  [?TYPE_VARCHAR, ?TYPE_ENUM, ?TYPE_TINY_BLOB,</code></td>
</tr>
<tr>
<td class="line" id="L1353">1353</td>
<td class="hits"></td>
<td class="source"><code>                   ?TYPE_MEDIUM_BLOB, ?TYPE_LONG_BLOB, ?TYPE_BLOB,</code></td>
</tr>
<tr>
<td class="line" id="L1354">1354</td>
<td class="hits"></td>
<td class="source"><code>                   ?TYPE_VAR_STRING, ?TYPE_STRING, ?TYPE_GEOMETRY]),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1355">1355</td>
<td class="hits">1</td>
<td class="source"><code>    ok.</code></td>
</tr>
<tr>
<td class="line" id="L1356">1356</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1357">1357</td>
<td class="hits"></td>
<td class="source"><code>decode_binary_test() -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1358">1358</td>
<td class="hits"></td>
<td class="source"><code>    %% Test the special rounding we apply to (single precision) floats.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1359">1359</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({1.0, &lt;&lt;&gt;&gt;},</code></td>
</tr>
<tr>
<td class="line" id="L1360">1360</td>
<td class="hits"></td>
<td class="source"><code>                 decode_binary(#col{type = ?TYPE_FLOAT},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1361">1361</td>
<td class="hits">1</td>
<td class="source"><code>                               &lt;&lt;1.0:32/float-little&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1362">1362</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({0.2, &lt;&lt;&gt;&gt;},</code></td>
</tr>
<tr>
<td class="line" id="L1363">1363</td>
<td class="hits"></td>
<td class="source"><code>                 decode_binary(#col{type = ?TYPE_FLOAT},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1364">1364</td>
<td class="hits">1</td>
<td class="source"><code>                               &lt;&lt;0.2:32/float-little&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1365">1365</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({-33.3333, &lt;&lt;&gt;&gt;},</code></td>
</tr>
<tr>
<td class="line" id="L1366">1366</td>
<td class="hits"></td>
<td class="source"><code>                 decode_binary(#col{type = ?TYPE_FLOAT},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1367">1367</td>
<td class="hits">1</td>
<td class="source"><code>                               &lt;&lt;-33.333333:32/float-little&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1368">1368</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({0.000123457, &lt;&lt;&gt;&gt;},</code></td>
</tr>
<tr>
<td class="line" id="L1369">1369</td>
<td class="hits"></td>
<td class="source"><code>                 decode_binary(#col{type = ?TYPE_FLOAT},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1370">1370</td>
<td class="hits">1</td>
<td class="source"><code>                               &lt;&lt;0.00012345678:32/float-little&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1371">1371</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({1234.57, &lt;&lt;&gt;&gt;},</code></td>
</tr>
<tr>
<td class="line" id="L1372">1372</td>
<td class="hits"></td>
<td class="source"><code>                 decode_binary(#col{type = ?TYPE_FLOAT},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1373">1373</td>
<td class="hits">1</td>
<td class="source"><code>                               &lt;&lt;1234.56789:32/float-little&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1374">1374</td>
<td class="hits">1</td>
<td class="source"><code>    ok.</code></td>
</tr>
<tr>
<td class="line" id="L1375">1375</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1376">1376</td>
<td class="hits"></td>
<td class="source"><code>null_bitmap_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1377">1377</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({&lt;&lt;0, 1:1&gt;&gt;, &lt;&lt;&gt;&gt;}, null_bitmap_decode(9, &lt;&lt;0, 4&gt;&gt;, 2)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1378">1378</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;0, 4&gt;&gt;, null_bitmap_encode(&lt;&lt;0, 1:1&gt;&gt;, 2)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1379">1379</td>
<td class="hits">1</td>
<td class="source"><code>    ok.</code></td>
</tr>
<tr>
<td class="line" id="L1380">1380</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1381">1381</td>
<td class="hits"></td>
<td class="source"><code>lenenc_int_test() -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1382">1382</td>
<td class="hits"></td>
<td class="source"><code>    %% decode</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1383">1383</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({40, &lt;&lt;&gt;&gt;}, lenenc_int(&lt;&lt;40&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1384">1384</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({16#ff, &lt;&lt;&gt;&gt;}, lenenc_int(&lt;&lt;16#fc, 255, 0&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1385">1385</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({16#33aaff, &lt;&lt;&gt;&gt;}, lenenc_int(&lt;&lt;16#fd, 16#ff, 16#aa, 16#33&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1386">1386</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({16#12345678, &lt;&lt;&gt;&gt;}, lenenc_int(&lt;&lt;16#fe, 16#78, 16#56, 16#34,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1387">1387</td>
<td class="hits">1</td>
<td class="source"><code>                                                 16#12, 0, 0, 0, 0&gt;&gt;)),</code></td>
</tr>
<tr>
<td class="line" id="L1388">1388</td>
<td class="hits"></td>
<td class="source"><code>    %% encode</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1389">1389</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;40&gt;&gt;, lenenc_int_encode(40)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1390">1390</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;16#fc, 255, 0&gt;&gt;, lenenc_int_encode(255)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1391">1391</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;16#fd, 16#ff, 16#aa, 16#33&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1392">1392</td>
<td class="hits">1</td>
<td class="source"><code>                 lenenc_int_encode(16#33aaff)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1393">1393</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;16#fe, 16#78, 16#56, 16#34, 16#12, 0, 0, 0, 0&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1394">1394</td>
<td class="hits">1</td>
<td class="source"><code>                 lenenc_int_encode(16#12345678)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1395">1395</td>
<td class="hits">1</td>
<td class="source"><code>    ok.</code></td>
</tr>
<tr>
<td class="line" id="L1396">1396</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1397">1397</td>
<td class="hits"></td>
<td class="source"><code>lenenc_str_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1398">1398</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({&lt;&lt;"Foo"&gt;&gt;, &lt;&lt;"bar"&gt;&gt;}, lenenc_str(&lt;&lt;3, "Foobar"&gt;&gt;)).</code></td>
</tr>
<tr>
<td class="line" id="L1399">1399</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1400">1400</td>
<td class="hits"></td>
<td class="source"><code>nulterm_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1401">1401</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({&lt;&lt;"Foo"&gt;&gt;, &lt;&lt;"bar"&gt;&gt;}, nulterm_str(&lt;&lt;"Foo", 0, "bar"&gt;&gt;)).</code></td>
</tr>
<tr>
<td class="line" id="L1402">1402</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1403">1403</td>
<td class="hits"></td>
<td class="source"><code>parse_header_test() -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1404">1404</td>
<td class="hits"></td>
<td class="source"><code>    %% Example from "MySQL Internals", revision 307, section 14.1.3.3 EOF_Packet</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1405">1405</td>
<td class="hits">1</td>
<td class="source"><code>    Packet = &lt;&lt;16#05, 16#00, 16#00, 16#05, 16#fe, 16#00, 16#00, 16#02, 16#00&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1406">1406</td>
<td class="hits">1</td>
<td class="source"><code>    &lt;&lt;Header:4/binary-unit:8, Body/binary&gt;&gt; = Packet,</code></td>
</tr>
<tr>
<td class="line" id="L1407">1407</td>
<td class="hits"></td>
<td class="source"><code>    %% Check header contents and body length</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1408">1408</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual({size(Body), 5, false}, parse_packet_header(Header)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1409">1409</td>
<td class="hits">1</td>
<td class="source"><code>    ok.</code></td>
</tr>
<tr>
<td class="line" id="L1410">1410</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1411">1411</td>
<td class="hits"></td>
<td class="source"><code>add_packet_headers_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1412">1412</td>
<td class="hits">1</td>
<td class="source"><code>    {Data, 43} = add_packet_headers(&lt;&lt;"foo"&gt;&gt;, 42),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1413">1413</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;3, 0, 0, 42, "foo"&gt;&gt;, list_to_binary(Data)).</code></td>
</tr>
<tr>
<td class="line" id="L1414">1414</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1415">1415</td>
<td class="hits"></td>
<td class="source"><code>add_packet_headers_equal_to_0xffffff_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1416">1416</td>
<td class="hits">1</td>
<td class="source"><code>    BigBin = binary:copy(&lt;&lt;1&gt;&gt;, 16#ffffff),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1417">1417</td>
<td class="hits">1</td>
<td class="source"><code>    {Data, 44} = add_packet_headers(BigBin, 42),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1418">1418</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;16#ff, 16#ff, 16#ff, 42, BigBin/binary,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1419">1419</td>
<td class="hits">1</td>
<td class="source"><code>                   0,     0,     0,     43&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1420">1420</td>
<td class="hits">1</td>
<td class="source"><code>                 list_to_binary(Data)).</code></td>
</tr>
<tr>
<td class="line" id="L1421">1421</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1422">1422</td>
<td class="hits"></td>
<td class="source"><code>add_packet_headers_greater_than_0xffffff_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1423">1423</td>
<td class="hits">1</td>
<td class="source"><code>    BigBin = binary:copy(&lt;&lt;1&gt;&gt;, 16#ffffff),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1424">1424</td>
<td class="hits">1</td>
<td class="source"><code>    {Data, 44} = add_packet_headers(&lt;&lt;BigBin/binary, "foo"&gt;&gt;, 42),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1425">1425</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;16#ff, 16#ff, 16#ff, 42, BigBin/binary, 3, 0, 0, 43, "foo"&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1426">1426</td>
<td class="hits">1</td>
<td class="source"><code>                 list_to_binary(Data)).</code></td>
</tr>
<tr>
<td class="line" id="L1427">1427</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1428">1428</td>
<td class="hits"></td>
<td class="source"><code>add_packet_headers_2_times_greater_than_0xffffff_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1429">1429</td>
<td class="hits">1</td>
<td class="source"><code>    BigBin = binary:copy(&lt;&lt;1&gt;&gt;, 16#ffffff),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1430">1430</td>
<td class="hits">1</td>
<td class="source"><code>    {Data, 45} = add_packet_headers(&lt;&lt;BigBin/binary, BigBin/binary, "foo"&gt;&gt;, 42),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1431">1431</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;16#ff, 16#ff, 16#ff, 42, BigBin/binary,</code></td>
</tr>
<tr>
<td class="line" id="L1432">1432</td>
<td class="hits"></td>
<td class="source"><code>                   16#ff, 16#ff, 16#ff, 43, BigBin/binary,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1433">1433</td>
<td class="hits">1</td>
<td class="source"><code>                   3,     0,     0,     44, "foo"&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1434">1434</td>
<td class="hits">1</td>
<td class="source"><code>                 list_to_binary(Data)).</code></td>
</tr>
<tr>
<td class="line" id="L1435">1435</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1436">1436</td>
<td class="hits"></td>
<td class="source"><code>parse_ok_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1437">1437</td>
<td class="hits">1</td>
<td class="source"><code>    Body = &lt;&lt;0, 5, 1, 2, 0, 0, 0, "Foo"&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1438">1438</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(#ok{affected_rows = 5,</code></td>
</tr>
<tr>
<td class="line" id="L1439">1439</td>
<td class="hits"></td>
<td class="source"><code>                     insert_id = 1,</code></td>
</tr>
<tr>
<td class="line" id="L1440">1440</td>
<td class="hits"></td>
<td class="source"><code>                     status = ?SERVER_STATUS_AUTOCOMMIT,</code></td>
</tr>
<tr>
<td class="line" id="L1441">1441</td>
<td class="hits"></td>
<td class="source"><code>                     warning_count = 0,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1442">1442</td>
<td class="hits">1</td>
<td class="source"><code>                     msg = &lt;&lt;"Foo"&gt;&gt;},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1443">1443</td>
<td class="hits">1</td>
<td class="source"><code>                 parse_ok_packet(Body)).</code></td>
</tr>
<tr>
<td class="line" id="L1444">1444</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1445">1445</td>
<td class="hits"></td>
<td class="source"><code>parse_error_test() -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1446">1446</td>
<td class="hits"></td>
<td class="source"><code>    %% Protocol 4.1</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1447">1447</td>
<td class="hits">1</td>
<td class="source"><code>    Body = &lt;&lt;255, 42, 0, "#", "XYZxx", "Foo"&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1448">1448</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(#error{code = 42, state = &lt;&lt;"XYZxx"&gt;&gt;, msg = &lt;&lt;"Foo"&gt;&gt;},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1449">1449</td>
<td class="hits">1</td>
<td class="source"><code>                 parse_error_packet(Body)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1450">1450</td>
<td class="hits">1</td>
<td class="source"><code>    ok.</code></td>
</tr>
<tr>
<td class="line" id="L1451">1451</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1452">1452</td>
<td class="hits"></td>
<td class="source"><code>parse_eof_test() -&gt;</code></td>
</tr>
<tr>
<td class="line" id="L1453">1453</td>
<td class="hits"></td>
<td class="source"><code>    %% Example from "MySQL Internals", revision 307, section 14.1.3.3 EOF_Packet</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1454">1454</td>
<td class="hits">1</td>
<td class="source"><code>    Packet = &lt;&lt;16#05, 16#00, 16#00, 16#05, 16#fe, 16#00, 16#00, 16#02, 16#00&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1455">1455</td>
<td class="hits">1</td>
<td class="source"><code>    &lt;&lt;_Header:4/binary-unit:8, Body/binary&gt;&gt; = Packet,</code></td>
</tr>
<tr>
<td class="line" id="L1456">1456</td>
<td class="hits"></td>
<td class="source"><code>    %% Ignore header. Parse body as an eof_packet.</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1457">1457</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(#eof{warning_count = 0,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1458">1458</td>
<td class="hits">1</td>
<td class="source"><code>                      status = ?SERVER_STATUS_AUTOCOMMIT},</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1459">1459</td>
<td class="hits">1</td>
<td class="source"><code>                 parse_eof_packet(Body)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1460">1460</td>
<td class="hits">1</td>
<td class="source"><code>    ok.</code></td>
</tr>
<tr>
<td class="line" id="L1461">1461</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1462">1462</td>
<td class="hits"></td>
<td class="source"><code>hash_password_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1463">1463</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;222,207,222,139,41,181,202,13,191,241,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1464">1464</td>
<td class="hits">1</td>
<td class="source"><code>                   234,234,73,127,244,101,205,3,28,251&gt;&gt;,</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1465">1465</td>
<td class="hits">1</td>
<td class="source"><code>                 hash_password(&lt;&lt;"foo"&gt;&gt;, &lt;&lt;"abcdefghijklmnopqrst"&gt;&gt;)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1466">1466</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertEqual(&lt;&lt;&gt;&gt;, hash_password(&lt;&lt;&gt;&gt;, &lt;&lt;"abcdefghijklmnopqrst"&gt;&gt;)).</code></td>
</tr>
<tr>
<td class="line" id="L1467">1467</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1468">1468</td>
<td class="hits"></td>
<td class="source"><code>valid_params_test() -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1469">1469</td>
<td class="hits">1</td>
<td class="source"><code>    ValidParams = [</code></td>
</tr>
<tr>
<td class="line" id="L1470">1470</td>
<td class="hits"></td>
<td class="source"><code>        null,</code></td>
</tr>
<tr>
<td class="line" id="L1471">1471</td>
<td class="hits"></td>
<td class="source"><code>        1,</code></td>
</tr>
<tr>
<td class="line" id="L1472">1472</td>
<td class="hits"></td>
<td class="source"><code>        0.5,</code></td>
</tr>
<tr>
<td class="line" id="L1473">1473</td>
<td class="hits"></td>
<td class="source"><code>        &lt;&lt;&gt;&gt;, &lt;&lt;$x&gt;&gt;, &lt;&lt;0:1&gt;&gt;,</code></td>
</tr>
<tr>
<td class="line" id="L1474">1474</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1475">1475</td>
<td class="hits"></td>
<td class="source"><code>        %% valid unicode</code></td>
</tr>
<tr>
<td class="line" id="L1476">1476</td>
<td class="hits"></td>
<td class="source"><code>        [], [$x], [16#E4],</code></td>
</tr>
<tr>
<td class="line" id="L1477">1477</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1478">1478</td>
<td class="hits"></td>
<td class="source"><code>        %% valid date</code></td>
</tr>
<tr>
<td class="line" id="L1479">1479</td>
<td class="hits"></td>
<td class="source"><code>        {1, 2, 3},</code></td>
</tr>
<tr>
<td class="line" id="L1480">1480</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1481">1481</td>
<td class="hits"></td>
<td class="source"><code>        %% valid time</code></td>
</tr>
<tr>
<td class="line" id="L1482">1482</td>
<td class="hits"></td>
<td class="source"><code>        {1, {2, 3, 4}}, {1, {2, 3, 4.5}},</code></td>
</tr>
<tr>
<td class="line" id="L1483">1483</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1484">1484</td>
<td class="hits"></td>
<td class="source"><code>        %% valid datetime</code></td>
</tr>
<tr>
<td class="line" id="L1485">1485</td>
<td class="hits"></td>
<td class="source"><code>        {{1, 2, 3}, {4, 5, 6}}, {{1, 2, 3}, {4, 5, 6.5}}</code></td>
</tr>
<tr>
<td class="line" id="L1486">1486</td>
<td class="hits"></td>
<td class="source"><code>    ],</code></td>
</tr>
<tr>
<td class="line" id="L1487">1487</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr class="hit">
<td class="line" id="L1488">1488</td>
<td class="hits">1</td>
<td class="source"><code>    InvalidParams = [</code></td>
</tr>
<tr>
<td class="line" id="L1489">1489</td>
<td class="hits"></td>
<td class="source"><code>        x,</code></td>
</tr>
<tr>
<td class="line" id="L1490">1490</td>
<td class="hits"></td>
<td class="source"><code>        [x],</code></td>
</tr>
<tr>
<td class="line" id="L1491">1491</td>
<td class="hits"></td>
<td class="source"><code>        {},</code></td>
</tr>
<tr>
<td class="line" id="L1492">1492</td>
<td class="hits"></td>
<td class="source"><code>        self(),</code></td>
</tr>
<tr>
<td class="line" id="L1493">1493</td>
<td class="hits"></td>
<td class="source"><code>        make_ref(),</code></td>
</tr>
<tr class="miss">
<td class="line" id="L1494">1494</td>
<td class="hits">0</td>
<td class="source"><code>        fun () -&gt; ok end,</code></td>
</tr>
<tr>
<td class="line" id="L1495">1495</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1496">1496</td>
<td class="hits"></td>
<td class="source"><code>        %% invalid unicode</code></td>
</tr>
<tr>
<td class="line" id="L1497">1497</td>
<td class="hits"></td>
<td class="source"><code>        [16#FFFFFFFF],</code></td>
</tr>
<tr>
<td class="line" id="L1498">1498</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1499">1499</td>
<td class="hits"></td>
<td class="source"><code>        %% invalid date</code></td>
</tr>
<tr>
<td class="line" id="L1500">1500</td>
<td class="hits"></td>
<td class="source"><code>        {x, 1, 2}, {1, x, 2}, {1, 2, x},</code></td>
</tr>
<tr>
<td class="line" id="L1501">1501</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1502">1502</td>
<td class="hits"></td>
<td class="source"><code>        %% invalid time</code></td>
</tr>
<tr>
<td class="line" id="L1503">1503</td>
<td class="hits"></td>
<td class="source"><code>        {x, {1, 2, 3}}, {1, {x, 2, 3}},</code></td>
</tr>
<tr>
<td class="line" id="L1504">1504</td>
<td class="hits"></td>
<td class="source"><code>        {1, {2, x, 3}}, {1, {2, 3, x}},</code></td>
</tr>
<tr>
<td class="line" id="L1505">1505</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1506">1506</td>
<td class="hits"></td>
<td class="source"><code>        %% invalid datetime</code></td>
</tr>
<tr>
<td class="line" id="L1507">1507</td>
<td class="hits"></td>
<td class="source"><code>        {{x, 1, 2}, {3, 4, 5}}, {{1, x, 2}, {3, 4, 5}},</code></td>
</tr>
<tr>
<td class="line" id="L1508">1508</td>
<td class="hits"></td>
<td class="source"><code>        {{1, 2, x}, {3, 4, 5}}, {{1, 2, 3}, {x, 4, 5}},</code></td>
</tr>
<tr>
<td class="line" id="L1509">1509</td>
<td class="hits"></td>
<td class="source"><code>        {{1, 2, 3}, {4, x, 5}}, {{1, 2, 3}, {4, 5, x}}</code></td>
</tr>
<tr>
<td class="line" id="L1510">1510</td>
<td class="hits"></td>
<td class="source"><code>    ],</code></td>
</tr>
<tr>
<td class="line" id="L1511">1511</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr class="hit">
<td class="line" id="L1512">1512</td>
<td class="hits">1</td>
<td class="source"><code>    lists:foreach(</code></td>
</tr>
<tr>
<td class="line" id="L1513">1513</td>
<td class="hits"></td>
<td class="source"><code>        fun (ValidParam) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1514">1514</td>
<td class="hits">14</td>
<td class="source"><code>            ?assert(is_valid_param(ValidParam))</code></td>
</tr>
<tr>
<td class="line" id="L1515">1515</td>
<td class="hits"></td>
<td class="source"><code>        end,</code></td>
</tr>
<tr>
<td class="line" id="L1516">1516</td>
<td class="hits"></td>
<td class="source"><code>        ValidParams),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1517">1517</td>
<td class="hits">1</td>
<td class="source"><code>    ?assert(valid_params(ValidParams)),</code></td>
</tr>
<tr>
<td class="line" id="L1518">1518</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr class="hit">
<td class="line" id="L1519">1519</td>
<td class="hits">1</td>
<td class="source"><code>    lists:foreach(</code></td>
</tr>
<tr>
<td class="line" id="L1520">1520</td>
<td class="hits"></td>
<td class="source"><code>        fun (InvalidParam) -&gt;</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1521">1521</td>
<td class="hits">20</td>
<td class="source"><code>            ?assertNot(is_valid_param(InvalidParam))</code></td>
</tr>
<tr>
<td class="line" id="L1522">1522</td>
<td class="hits"></td>
<td class="source"><code>        end,</code></td>
</tr>
<tr>
<td class="line" id="L1523">1523</td>
<td class="hits"></td>
<td class="source"><code>        InvalidParams),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1524">1524</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertNot(valid_params(InvalidParams)),</code></td>
</tr>
<tr class="hit">
<td class="line" id="L1525">1525</td>
<td class="hits">1</td>
<td class="source"><code>    ?assertNot(valid_params(ValidParams ++ InvalidParams)).</code></td>
</tr>
<tr>
<td class="line" id="L1526">1526</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
<tr>
<td class="line" id="L1527">1527</td>
<td class="hits"></td>
<td class="source"><code>-endif.</code></td>
</tr>
<tr>
<td class="line" id="L1528">1528</td>
<td class="hits"></td>
<td class="source"><code></code></td>
</tr>
</tbody>
<thead>
<tr>
<th>Line</th>
<th>Hits</th>
<th>Source</th>
</tr>
</thead>
</table>
</body>
</html>
